<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ikroal&#39;s blog</title>
  
  <subtitle>ç¥æ„¿æˆ‘ä»¬åœ¨æŠµè¾¾è·¯çš„æœ«ç«¯æ—¶,éƒ½ä¸ä¼šåæ‚”</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.ikroal.xyz/"/>
  <updated>2019-05-13T07:37:20.391Z</updated>
  <id>http://www.ikroal.xyz/</id>
  
  <author>
    <name>ikroal</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hadoop åŸºç¡€ä¹‹ HDFS å…¥é—¨</title>
    <link href="http://www.ikroal.xyz/2019/05/11/Hadoop%E5%9F%BA%E7%A1%80%E4%B9%8BHDFS/"/>
    <id>http://www.ikroal.xyz/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/</id>
    <published>2019-05-11T11:52:59.000Z</published>
    <updated>2019-05-13T07:37:20.391Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† HDFS çš„ä½“ç³»æ¶æ„ä»¥åŠå…¶æ‰§è¡Œæµç¨‹ï¼Œå¹¶ç»™å‡ºäº†è¯»å†™æ“ä½œçš„ç¼–ç¨‹å®ä¾‹ï¼Œå¸Œæœ›å¯¹ HDFS æœ‰ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚</p><a id="more"></a><h2 id="ç®€ä»‹">ç®€ä»‹</h2><p>HDFS (Hadoop Distributed File System) æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨å•†ä¸š PC ä¸Šçš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œå…¶è®¾è®¡æ€æƒ³æºè‡ªäº Google 2003 å¹´å‘å¸ƒçš„è®ºæ–‡ <a href="https://ai.google/research/pubs/pub51" target="_blank" rel="noopener">The Google File System</a> ã€‚HDFSçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³å¤§è§„æ¨¡æ•°æ®å­˜å‚¨å’Œç®¡ç†çš„é—®é¢˜ã€‚</p><h2 id="ä½“ç³»æ¶æ„">ä½“ç³»æ¶æ„</h2><p><img src="/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/HDFS-Structure.png"></p><p>ä¸Šå›¾è¡¨æ˜ HDFS æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ master/slave æ¶æ„ï¼Œä¸»è¦ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š</p><ol type="1"><li>NameNodeï¼ˆmaster èŠ‚ç‚¹ï¼‰<ul><li>å…ƒæ•°æ®ï¼ˆMetaDataï¼‰çš„ç®¡ç†ï¼Œå…¶ä¸­å…ƒæ•°æ®ç”±<strong>æ–‡ä»¶è·¯å¾„å</strong>ã€<strong>æ•°æ®å—ID</strong>ä»¥åŠ<strong>å­˜å‚¨ä½ç½®</strong>ç­‰ä¿¡æ¯æ„æˆ</li><li>ç®¡ç† HDFS çš„åå­—ç©ºé—´ã€‚</li></ul></li><li>SecondaryNameNode<ul><li>å®šæœŸåˆå¹¶ NameNode çš„ edit logsï¼ˆå¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ”¹åŠ¨åºåˆ—ï¼‰ åˆ° fsimageï¼ˆå¯¹æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å¿«ç…§ï¼‰ï¼Œå¹¶æ‹·è´ä¿®æ”¹åçš„ fsimage åˆ° NameNodeã€‚</li><li>æä¾›ä¸€ä¸ª NameNode çš„æ£€æŸ¥ç‚¹ï¼ˆåˆ‡å¿Œè®¤ä¸ºæ˜¯ NameNode çš„å¤‡ä»½ï¼‰ï¼Œå¯ç”¨äº NameNode çš„æ•…éšœæ¢å¤ã€‚</li></ul></li><li>DataNodeï¼ˆslave èŠ‚ç‚¹ï¼‰<ul><li>æä¾›æ–‡ä»¶å­˜å‚¨å’Œè¿›è¡Œæ•°æ®å—æ“ä½œã€‚</li><li>å‘¨æœŸæ€§çš„å‘ NameNode æ±‡æŠ¥å—ä¿¡æ¯ã€‚</li></ul></li></ol><p>è¿™é‡Œå¯¹å›¾ä¸­å‡ºç°çš„ä¸€äº›æ¦‚å¿µè¿›è¡Œè¯´æ˜ï¼š</p><ol type="1"><li><p>Replicationï¼ˆå‰¯æœ¬ï¼‰</p><p>ä¸ºäº†ä¿è¯æ•°æ®çš„é«˜å¯ç”¨ï¼ŒHDFS ä¼šå¯¹å†™å…¥çš„æ•°æ®è¿›è¡Œå†—ä½™å­˜å‚¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä¿å­˜ 3 ä»½ã€‚</p></li><li><p>Blocks</p><p>Block æ˜¯æœ€åŸºæœ¬çš„å­˜å‚¨å’Œæ“ä½œå•ä½ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸º 128Mï¼‰ï¼Œè¿™é‡Œçš„ Block ä¸æ˜¯æŒ‡ç‰©ç† Block ï¼Œè€Œæ˜¯æŒ‡æ–‡ä»¶ç³»ç»Ÿçš„ Blockï¼Œå…¶å¤§å°ä¸€èˆ¬æ˜¯ç‰©ç† Block çš„æ•´æ•°å€ã€‚</p></li></ol><h2 id="æ‰§è¡Œæµç¨‹">æ‰§è¡Œæµç¨‹</h2><h3 id="è¯»æ–‡ä»¶">è¯»æ–‡ä»¶</h3><p><img src="/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/HDFS-Read.jpg"></p><p>è¯»æ–‡ä»¶çš„è¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p><ol type="1"><li>Client å‘ NameNode å‘èµ·è¯·æ±‚è·å–æ–‡ä»¶æ•°æ®å—ä½ç½®ä¿¡æ¯</li><li>Client æŒ‰ç…§æ•°æ®å—è· Client çš„è¿œè¿‘ä¾æ¬¡è¿›è¡Œè¿æ¥ç„¶åè¯»å–æ•°æ®</li></ol><h3 id="å†™æ–‡ä»¶">å†™æ–‡ä»¶</h3><p><img src="/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/HDFS-Write.jpg"></p><p>å†™æ–‡ä»¶çš„è¿‡ç¨‹å¯ä»¥æ¦‚æ‹¬ä¸ºï¼š</p><ol type="1"><li>Client å‘ NameNode å‘èµ·å†™æ–‡ä»¶çš„è¯·æ±‚è·å¾—å¯å†™çš„ DataNode åˆ—è¡¨ç­‰ä¿¡æ¯</li><li>Client æ ¹æ® HDFS è®¾å®šçš„åˆ†å—å¤§å°å¯¹æ–‡ä»¶è¿›è¡Œåˆ†å—</li><li>Client å’Œ NameNode åˆ†é…çš„ DataNode æ„æˆ pipeline å¹¶è¿›è¡Œæ•°æ®å†™å…¥</li><li>å†™å…¥å®Œæˆä¹‹åï¼ŒNameNode æ¥æ”¶æ¥è‡ª DataNode çš„æ¶ˆæ¯è¿›è¡Œå…ƒæ•°æ®çš„æ›´æ–°</li></ol><h2 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h2><h3 id="æ–‡ä»¶æ“ä½œ">æ–‡ä»¶æ“ä½œ</h3><ol type="1"><li><p>åˆ—å‡ºæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -ls &lt;path&gt;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -mkdir &lt;path&gt;</span><br></pre></td></tr></table></figure></li><li><p>ä¸Šä¼ æ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -put &lt;localsrc&gt; &lt;dst&gt;</span><br></pre></td></tr></table></figure></li><li><p>è¾“å‡ºæ–‡ä»¶å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -cat &lt;src&gt;</span><br></pre></td></tr></table></figure></li><li><p>æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -get &lt;src&gt; &lt;localdst&gt;</span><br></pre></td></tr></table></figure></li><li><p>åˆ é™¤æ–‡ä»¶å’Œç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfs -rm &lt;src&gt;</span><br><span class="line">hdfs dfs -rmdir &lt;dir&gt;</span><br></pre></td></tr></table></figure></li></ol><h3 id="ç®¡ç†">ç®¡ç†</h3><ol type="1"><li><p>æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfsadmin -report</span><br></pre></td></tr></table></figure></li><li><p>è¿›å…¥å’Œé€€å‡ºå®‰å…¨æ¨¡å¼ï¼ˆè¯¥æ¨¡å¼ä¸å…è®¸æ–‡ä»¶ç³»ç»Ÿæœ‰ä»»ä½•ä¿®æ”¹ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfsadmin -safemode enter</span><br><span class="line">hdfs dfsadmin -safemode leave</span><br></pre></td></tr></table></figure></li></ol><h2 id="ç¼–ç¨‹å®ä¾‹">ç¼–ç¨‹å®ä¾‹</h2><ol type="1"><li><p>IDEA æ–°å»º Maven é¡¹ç›®</p><p><img src="/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/maven-create.png"></p><p>å‹¾é€‰ç›¸å…³é€‰é¡¹åï¼Œç‚¹å‡» next å¡«å…¥é¡¹ç›®ç›¸å…³ä¿¡æ¯å³å¯</p></li><li><p>pom.xml ä¸­æ·»åŠ ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span> //æ ¹æ® Hadoop ç‰ˆæœ¬è¿›è¡Œé€‰æ‹©</span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>è¯»å†™æ–‡ä»¶</p><p>åˆ›å»º Sample ç±»ç¼–å†™ç›¸åº”çš„è¯»å†™å‡½æ•°</p><ul><li><p>Sample ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FSDataInputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FSDataOutputStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.FileSystem;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ikroal</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sample</span> </span>&#123;</span><br><span class="line">    <span class="comment">//é»˜è®¤çš„ HDFS åœ°å€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_FS = <span class="string">"hdfs://localhost:9000"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = DEFAULT_FS + <span class="string">"/tmp/demo.txt"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_FILE = <span class="string">"demo.txt"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line">        conf.set(<span class="string">"fs.defaultFS"</span>, DEFAULT_FS); <span class="comment">//é…ç½® HDFS åœ°å€</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fs = FileSystem.get(conf);</span><br><span class="line">            write(fs, DEFAULT_FILE, PATH);</span><br><span class="line">            read(fs, PATH);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    fs.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>write å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* è¿›è¡Œæ–‡ä»¶å†™å…¥</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> inputPath å¾…å†™å…¥æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> outPath HDFS çš„å†™å…¥è·¯å¾„</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(FileSystem fileSystem, String inputPath, String outPath)</span> </span>&#123;</span><br><span class="line">    FSDataOutputStream outputStream = <span class="keyword">null</span>;</span><br><span class="line">    FileInputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        outputStream = fileSystem.create(<span class="keyword">new</span> Path(outPath)); <span class="comment">//è·å¾— HDFS çš„å†™å…¥æµ</span></span><br><span class="line">        inputStream = <span class="keyword">new</span> FileInputStream(inputPath); <span class="comment">//è¯»å–æœ¬åœ°æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">int</span> data;</span><br><span class="line">        <span class="keyword">while</span> ((data = inputStream.read()) != -<span class="number">1</span>) &#123; <span class="comment">//å†™å…¥æ“ä½œ</span></span><br><span class="line">            outputStream.write(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (outputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                outputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>read å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* è¿›è¡Œæ–‡ä»¶è¯»å–</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> path HDFS ä¸Šå¾…è¯»å–æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(FileSystem fileSystem, String path)</span> </span>&#123;</span><br><span class="line">    FSDataInputStream inputStream = <span class="keyword">null</span>;</span><br><span class="line">    BufferedReader reader = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        inputStream = fileSystem.open(<span class="keyword">new</span> Path(path)); <span class="comment">//è·å– HDFS è¯»å–æµ</span></span><br><span class="line">        reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</span><br><span class="line">        String content;</span><br><span class="line">        <span class="keyword">while</span> ((content = reader.readLine()) != <span class="keyword">null</span>) &#123; <span class="comment">//è¯»å–å¹¶è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">            System.out.println(content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="keyword">null</span>) &#123;</span><br><span class="line">                inputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                reader.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>åœ¨å·¥ç¨‹æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºè®¡åˆ’ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆè¿™é‡Œæ˜¯ demo.txtï¼‰ï¼Œå¡«å…¥ Hello Worldï¼</p></li><li><p>å¯åŠ¨ Hadoop ç„¶åè¿è¡Œç¨‹åºæŸ¥çœ‹ç»“æœ</p><p>é€šè¿‡ http://localhost:50070/explorer.html#/ å¯ä»¥æŸ¥çœ‹å†™å…¥ç»“æœ</p><p><img src="/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/write.png"></p><p>æ§åˆ¶å°åˆ™ä¼šè¾“å‡ºä¸Šä¼ æ–‡ä»¶çš„å†…å®¹</p><p><img src="/2019/05/11/HadoopåŸºç¡€ä¹‹HDFS/read.png"></p></li></ol><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="https://www.cnblogs.com/codeOfLife/p/5375120.html" target="_blank" rel="noopener">åˆæ­¥æŒæ¡HDFSçš„æ¶æ„åŠåŸç†</a></li><li><a href="https://blog.csdn.net/bingduanlbd/article/details/51914550#t23" target="_blank" rel="noopener">æ·±å…¥ç†è§£HDFSï¼šHadoopåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</a></li><li><a href="https://blog.csdn.net/whdxjbw/article/details/81072207" target="_blank" rel="noopener">HDFSè¯»å†™æµç¨‹ï¼ˆå²ä¸Šæœ€ç²¾ç‚¼è¯¦ç»†ï¼‰</a></li><li><a href="https://www.cnblogs.com/qingyunzong/p/8548806.html" target="_blank" rel="noopener">Hadoopå­¦ä¹ ä¹‹è·¯ï¼ˆåä¸€ï¼‰HDFSçš„è¯»å†™è¯¦è§£</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ä¸»è¦ä»‹ç»äº† HDFS çš„ä½“ç³»æ¶æ„ä»¥åŠå…¶æ‰§è¡Œæµç¨‹ï¼Œå¹¶ç»™å‡ºäº†è¯»å†™æ“ä½œçš„ç¼–ç¨‹å®ä¾‹ï¼Œå¸Œæœ›å¯¹ HDFS æœ‰ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Hadoop åŸºç¡€" scheme="http://www.ikroal.xyz/categories/Hadoop-%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="BigData" scheme="http://www.ikroal.xyz/tags/BigData/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop åŸºç¡€ä¹‹æ­å»ºç¯å¢ƒ</title>
    <link href="http://www.ikroal.xyz/2019/05/04/Hadoop%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83/"/>
    <id>http://www.ikroal.xyz/2019/05/04/HadoopåŸºç¡€ä¹‹æ­å»ºç¯å¢ƒ/</id>
    <published>2019-05-04T09:52:43.000Z</published>
    <updated>2019-05-13T10:39:11.731Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Hadoop çš„ä¸‰ç§è¿è¡Œæ¨¡å¼ä»¥åŠé…ç½®çš„æ–¹å¼ã€‚</p><a id="more"></a><h2 id="è¿è¡Œæ¨¡å¼">è¿è¡Œæ¨¡å¼</h2><p>Hadoop çš„è¿è¡Œæ¨¡å¼åˆ†ä¸ºä¸‰ç§ï¼š</p><ol type="1"><li>Standaloneï¼ˆæœ¬åœ°æ¨¡å¼/å•æœºæ¨¡å¼/localæ¨¡å¼ï¼‰ è¯¥æ¨¡å¼ä¸‹æ²¡æœ‰ä»»ä½•å®ˆæŠ¤è¿›ç¨‹ï¼Œç”¨æˆ·ç¨‹åºå’Œ Hadoop ç¨‹åºè¿è¡Œåœ¨åŒä¸€ä¸ª Java è¿›ç¨‹ï¼Œä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿè€Œä¸æ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œæ­¤æ¨¡å¼ä¸‹ä¸€èˆ¬ç”¨äºæœ¬åœ°è°ƒè¯•ã€‚</li><li>Pseudo-Distributedï¼ˆä¼ªé›†ç¾¤æ¨¡å¼ï¼‰ åœ¨<strong>å•æœº</strong>ä¸Šæ¨¡æ‹Ÿé›†ç¾¤æ¨¡å¼ï¼Œå„å®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨å•ç‹¬çš„ Java è¿›ç¨‹å½“ä¸­ï¼Œä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯ HDFS</li><li>Fully-Distributedï¼ˆé›†ç¾¤æ¨¡å¼ï¼‰ å®ˆæŠ¤è¿›ç¨‹è¿è¡Œåœ¨é›†ç¾¤ä¸Šï¼Œä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿä¹Ÿæ˜¯ HDFS</li></ol><h2 id="é…ç½®è¿‡ç¨‹">é…ç½®è¿‡ç¨‹</h2><p>æœ¬æ¬¡é…ç½®åŸºäº Hadoop2.9.2ï¼Œå…¶ä¸­ Standalone åœ¨ CentOS 7.2 ç³»ç»Ÿä¸‹è¿›è¡Œé…ç½®ï¼Œ Pseudo-Distributed æ¨¡å¼åœ¨ MacOS 10.14.4 ä¸Šè¿›è¡Œé…ç½®ï¼ŒFully-Distributed æ¨¡å¼åœ¨è…¾è®¯äº‘ä¸»æœºä¸Šè¿›è¡Œé…ç½®ï¼Œé›†ç¾¤ç”±ä¸¤å°äº‘ä¸»æœºç»„æˆï¼Œåˆ†åˆ«è¿è¡Œ Ubuntu 14.04.1 å’Œ CentOS 7.2 ç³»ç»Ÿã€‚</p><h3 id="ç¯å¢ƒå‡†å¤‡">ç¯å¢ƒå‡†å¤‡</h3><ul><li><p>Java 7/8 Hadoop 2.7.x to 2.x æ”¯æŒ Java 7/8ï¼Œå…¶å®ƒ Hadoop ç‰ˆæœ¬æ”¯æŒçš„ Java ç‰ˆæœ¬è¯·ç‚¹å‡» <a href="https://cwiki.apache.org/confluence/display/HADOOP/Hadoop+Java+Versions" target="_blank" rel="noopener">ğŸ”—</a> è¿›è¡ŒæŸ¥è¯¢ ä¸‹è½½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install java-1.8.0-openjdk-devel //centos å®‰è£… Java8ï¼Œubuntu ä¸‹éœ€è¦ç”¨ apt-get è¿›è¡Œå®‰è£…</span><br></pre></td></tr></table></figure><p>é…ç½®ç¯å¢ƒå˜é‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">vi .bash_profile</span><br><span class="line">export JAVA_HOME=/usr/lib/jvm/jre-1.8.0-openjdk.i386</span><br><span class="line">source .bash_profile</span><br></pre></td></tr></table></figure></li><li><p>ssh å’Œ rsync: ç”¨ <code>ssh</code> å’Œ <code>rsync</code> å‘½ä»¤æµ‹è¯•åå‘ç° Centos æœ¬èº«å°±æœ‰ï¼Œæ‰€ä»¥æ— é¡»è¿›è¡Œå®‰è£…ã€‚</p></li><li><p>Hadoop</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo wget http://mirror.bit.edu.cn/apache/hadoop/common/hadoop-2.9.2/hadoop-2.9.2.tar.gz</span><br><span class="line">tar -zxvf hadoop-2.9.2.tar.gz</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„ä¸‹è½½åœ°å€æœ€å¥½æ ¹æ®äº‘ä¸»æœºæ‰€åœ¨çš„åŒºåŸŸè¿›è¡Œé€‰æ‹©ï¼Œå¦‚æœæ˜¯å›½å†…çš„äº‘ä¸»æœºæœ€å¥½ä½¿ç”¨å›½å†…çš„é•œåƒåœ°å€ï¼Œè¿™æ ·ä¸‹è½½ä¼šå¿«å¾ˆå¤šã€‚</p></li></ul><h3 id="standalone-æ¨¡å¼">Standalone æ¨¡å¼</h3><p>ä¸‹è½½è§£å‹ä¹‹åçš„ Hadoop é»˜è®¤å°±æ˜¯ Standalone æ¨¡å¼ï¼Œå¯ç›´æ¥è¿è¡Œ wordcount è¿›è¡Œæµ‹è¯•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir input //hadoop çš„åŒçº§ç›®å½•åˆ›å»º</span><br><span class="line">cp hadoop-2.9.2/LICENSE.txt input/</span><br><span class="line"></span><br><span class="line">hadoop-2.9.2/bin/hadoop jar  hadoop-2.9.2/share/hadoop/mapreduce/hadoop-mapreduce-examples-2.9.2.jar wordcount input output //è¿è¡Œ wordcount</span><br><span class="line">cat output/part-r-00000 //æŸ¥çœ‹ç»“æœ</span><br></pre></td></tr></table></figure><p>åŒæ—¶å†å¼€ä¸€ä¸ªç»ˆç«¯åœ¨ä½œä¸šè¿è¡Œçš„æ—¶å€™è¾“å…¥ jps æŸ¥çœ‹è¿›ç¨‹</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/hadoop-standalone.png"></p><p>å¯ä»¥çœ‹åˆ° Standalone æ¨¡å¼ä¸‹ Hadoop åªä¼šå¯åŠ¨ RunJar è¿›ç¨‹æ¥è¿è¡Œæ•´ä¸ªä½œä¸š</p><h3 id="pseudo-distributed-æ¨¡å¼">Pseudo-Distributed æ¨¡å¼</h3><ol type="1"><li><p>ä¿®æ”¹ etc/hadoop/core-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  <span class="comment">&lt;!--é…ç½®è®¿é—® nameNode çš„ URI--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--æŒ‡å®šä¸´æ—¶ç›®å½•ï¼ŒMapReduce å’Œ HDFS çš„è®¸å¤šè·¯å¾„é…ç½®ä¾èµ–æ­¤è·¯å¾„--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/hdfs-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--é…ç½®æ–‡ä»¶çš„å‰¯æœ¬æ•°é‡--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.permissions<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span>    <span class="comment">&lt;!--å…³é—­é˜²ç«å¢™--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®å…å¯†ç™»å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh localhost æµ‹è¯•èƒ½å¦å…å¯†ç™»å½•ï¼ˆå¦‚æœèƒ½å¤Ÿåˆ™è·³è¿‡ä»¥ä¸‹æ“ä½œï¼‰</span><br><span class="line">ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa</span><br><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">chmod 0600 ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/hadoop-env.shï¼ˆå¦‚æœæç¤ºæ‰¾ä¸åˆ° JAVA_HOMEï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/lib/jvm/jre-1.8.0-openjdk.i386 //ä¸Šé¢é…ç½®çš„ JAVA_HOME å¥½åƒæ²¡èµ·ä½œç”¨</span><br></pre></td></tr></table></figure></li><li><p>æ ¼å¼åŒ– HDFS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs namenode -format</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ HDFS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbin/start-dfs.sh</span><br></pre></td></tr></table></figure><p>å¯åŠ¨åè¾“å…¥ jps çœ‹åˆ°ä»¥ä¸‹è¿›ç¨‹å³æˆåŠŸï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡ http://localhost:50070/ è®¿é—® NameNode</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/hdfs%E8%BF%9B%E7%A8%8B.png"></p></li><li><p>è¿è¡Œ wordcount</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs dfs -mkdir /user</span><br><span class="line">bin/hdfs dfs -mkdir /user/&lt;username&gt;</span><br><span class="line">bin/hdfs dfs -mkdir /user/&lt;username&gt;/input</span><br><span class="line">bin/hdfs dfs -put LICENSE.txt /user/&lt;username&gt;/input //åˆ›å»ºæ–‡ä»¶å¤¹å¹¶ä¸Šä¼ æ–‡ä»¶</span><br><span class="line">bin/hadoop jar  share/hadoop/mapreduce/hadoop-mapreduce-examples-2.9.2.jar wordcount input output //è¿è¡Œ wordcount</span><br><span class="line">bin/hdfs dfs -cat output/part-r-00000 //æ˜¾ç¤ºç»“æœ</span><br></pre></td></tr></table></figure><p>åœ¨å¦ä¸€ç»ˆç«¯è¾“å…¥ jps å¯ä»¥çœ‹åˆ°è¿è¡Œæ—¶çš„ä»¥ä¸‹è¿›ç¨‹ <img src="https://raw.githubusercontent.com/ikroal/blog-images/master/Pseudo-Distributed.png"></p><p>ä¾æ—§æ˜¯ç”¨ RunJar æäº¤ï¼Œåªæ˜¯è¯»å–å’Œå†™å…¥é‡‡ç”¨äº† HDFSã€‚</p></li><li><p>é€šè¿‡ YARN æ‰§è¡Œ Jobï¼ˆå¯é€‰é…ç½®ï¼Œä¸è¿‡ä¸ºäº†æ›´æ¥è¿‘çœŸå®é›†ç¾¤è¿˜æ˜¯å»ºè®®é…ç½®ï¼‰</p><ul><li><p>ä¿®æ”¹ etc/hadoop/mapred-site.xml</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp etc/hadoop/mapred-site.xml.template etc/hadoop/mapred-site.xml</span><br><span class="line">vi etc/hadoop/mapred-site.xml</span><br></pre></td></tr></table></figure><p>å¢åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--è¡¨æ˜è¿è¡Œåœ¨ YARN ä¸Š--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/yarn-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="comment">&lt;!--è®¾ç½®resourcemanagerçš„hostname--&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--æŒ‡å®š nodemanager è·å–æ•°æ®çš„æ–¹å¼--&gt;</span> </span><br><span class="line">     <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ YARN</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sbin/start-yarn.sh</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æˆåŠŸåå¯ä»¥é€šè¿‡ http://localhost:8088/ è®¿é—® ResourceManager èŠ‚ç‚¹ï¼Œå¹¶ä¸”è¾“å…¥ jps ä¼šæ˜¾ç¤ºä»¥ä¸‹è¿›ç¨‹</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/yarn-process.png"></p><p>å…¶ä¸­ ResourceManager å’Œ NodeManager æ˜¯å±äº YARN çš„è¿›ç¨‹ã€‚</p></li><li><p>é‡å¤ <code>7</code> çš„æ“ä½œï¼Œè¾“å…¥ jps æŸ¥è¯¢è¿›ç¨‹</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/yarn-run-process.png"></p><p>å¯ä»¥çœ‹åˆ°æ–°å¢åŠ äº† YarnChild è¿›ç¨‹å’Œ MRAppMaster è¿›ç¨‹ï¼Œä¹‹æ‰€ä»¥æœ‰ä¸¤ä¸ª YarnChild è¿›ç¨‹æ˜¯å› ä¸ºè¾“å…¥æ–‡ä»¶å¤¹ä¸­å­˜åœ¨ä¸¤ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œè¿™è¯´æ˜äº† MapReduce æ˜¯é€šè¿‡åˆ›å»º<strong>å¤šä¸ªè¿›ç¨‹å¹¶è¡Œ</strong>è®¡ç®—çš„ã€‚</p></li></ul></li></ol><h3 id="fully-distributed-æ¨¡å¼">Fully-Distributed æ¨¡å¼</h3><p>é›†ç¾¤åŒ…æ‹¬ä¸¤ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ååˆ†åˆ«ä¸º master å’Œ slaveï¼Œmaster å’Œ slave çš„èŠ‚ç‚¹é…ç½®è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œä»¥ä¸‹æ˜¯é…ç½®è¿‡ç¨‹ï¼ˆä¸¤ä¸ªèŠ‚ç‚¹å·®å¼‚é…ç½®ä¼šè¿›è¡Œæ³¨æ˜ï¼Œå»ºè®®å…ˆé…ç½®å¥½ master èŠ‚ç‚¹çš„ Hadoopï¼Œç„¶åç”¨ scp å‘½ä»¤å¤åˆ¶åˆ° slave èŠ‚ç‚¹è¿›è¡Œä¿®æ”¹ã€‚ï¼‰ï¼š</p><ol type="1"><li><p>ä¿®æ”¹ <strong>/etc/hosts</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">152.136.76.12 master //è…¾è®¯äº‘å…¬ç½‘ip</span><br><span class="line">94.191.43.137 slave</span><br></pre></td></tr></table></figure></li><li><p>å…å¯†ç™»å½•ï¼ˆ<strong>âš ï¸ä¸¤ä¸ªèŠ‚ç‚¹çš„ç™»å½•åå¿…é¡»ä¸€è‡´ï¼Œè¿™é‡Œéƒ½ä¸º root</strong>ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">master èŠ‚ç‚¹é…ç½®æœ¬æœºå…å¯†ç™»å½•ä»¥åŠç§»åŠ¨å…¬é’¥åˆ°å­èŠ‚ç‚¹</span><br><span class="line">ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa</span><br><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">chmod 0600 ~/.ssh/authorized_keys</span><br><span class="line">scp ~/.ssh/id_rsa.pub root@slave:~/</span><br><span class="line"></span><br><span class="line">slave èŠ‚ç‚¹é…ç½® master èŠ‚ç‚¹å…å¯†ç™»å½•</span><br><span class="line">cat ~/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys</span><br><span class="line">chmod 600  ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/core-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  <span class="comment">&lt;!--é…ç½®è®¿é—® nameNode çš„ URI--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://localhost:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--æŒ‡å®šä¸´æ—¶ç›®å½•ï¼ŒMapReduce å’Œ HDFS çš„è®¸å¤šè·¯å¾„é…ç½®ä¾èµ–æ­¤è·¯å¾„--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/home/hadoop/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/hdfs-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--é…ç½®æ–‡ä»¶çš„å‰¯æœ¬æ•°é‡--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.permissions<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span>    <span class="comment">&lt;!--å…³é—­é˜²ç«å¢™--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.secondary.http-address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>slave:50090<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!-- æŒ‡å®šsecondarynamenodeä½ç½® --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/mapred-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.framework.name<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--è¡¨æ˜è¿è¡Œåœ¨ YARN ä¸Š--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>yarn<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/yarn-site.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="comment">&lt;!--è®¾ç½®resourcemanagerçš„hostname--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>master<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="tag">&lt;/<span class="name">name</span>&gt;</span> <span class="comment">&lt;!--æŒ‡å®š nodemanager è·å–æ•°æ®çš„æ–¹å¼--&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mapreduce_shuffle<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/hadoop-env.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/lib/jvm/jre-1.8.0-openjdk.i386 //master å’Œ slave å¡«å…¥å„è‡ªè·¯å¾„</span><br><span class="line">export HADOOP_LOG_DIR=/root/hadoop/hadoop-2.9.2/logs //å¯ä»¥è‡ªå·±é€‰å®š</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/mapred-env.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/lib/jvm/jre-1.8.0-openjdk.i386</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/yarn-env.sh</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/lib/jvm/jre-1.8.0-openjdk.i386 </span><br><span class="line">export YARN_LOG_DIR=/root/hadoop/hadoop-2.9.2/logs</span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹ etc/hadoop/slaves</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master</span><br><span class="line">slave</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ HDFS å’Œ YARN</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs namenode -format //é¦–æ¬¡è¿è¡Œæ—¶æ ¼å¼åŒ–</span><br><span class="line">sbin/start-dfs.sh</span><br><span class="line">sbin/start-yarn.sh</span><br></pre></td></tr></table></figure><p>åœ¨ master å’Œ slave èŠ‚ç‚¹åˆ†åˆ«è¾“å…¥ jps åæœ‰</p><div class="group-picture"><div class="group-picture-container"><div class="group-picture-row"><div class="group-picture-column" style="width: 50%;"><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/master.png"></div><div class="group-picture-column" style="width: 50%;"><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/slave.png"></div></div></div></div><p>æ­¤æ—¶å¯ä»¥é€šè¿‡ http://152.136.76.12:8080 (ip ä¸º master çš„å…¬ç½‘ ip) ä»¥åŠ http://152.136.76.12:50070 åˆ†åˆ«è®¿é—® HDFS çš„ web ç•Œé¢å’Œ YARN çš„ web ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ° HDFS ä¸‹æœ‰ä¸€ä¸ª slave èŠ‚ç‚¹ï¼ŒYARN ä¸‹æœ‰ä¸¤ä¸ªèŠ‚ç‚¹</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/HDFS-node.png"></p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/YARN-node.png"></p></li><li><p>è¿è¡Œ wordcountï¼ˆä¸ä¼ªåˆ†å¸ƒå¼ä¸­ä¸€è‡´ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bin/hdfs dfs -mkdir /user</span><br><span class="line">bin/hdfs dfs -mkdir /user/&lt;username&gt;</span><br><span class="line">bin/hdfs dfs -mkdir /user/&lt;username&gt;/input</span><br><span class="line">bin/hdfs dfs -put LICENSE.txt /user/&lt;username&gt;/input </span><br><span class="line">bin/hadoop jar  share/hadoop/mapreduce/hadoop-mapreduce-examples-2.9.2.jar wordcount input output</span><br><span class="line">bin/hdfs dfs -cat output/part-r-00000</span><br></pre></td></tr></table></figure><p>ç»§ç»­ç”¨ jps æŸ¥çœ‹ä¸¤å°ä¸»æœºçš„è¿›ç¨‹</p><div class="group-picture"><div class="group-picture-container"><div class="group-picture-row"><div class="group-picture-column" style="width: 50%;"><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/master-run.png"></div><div class="group-picture-column" style="width: 50%;"><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/salve-run.png"></div></div></div></div><p>å¯ä»¥çœ‹åˆ°é›†ç¾¤æ¨¡å¼ä¸­çš„è¿›ç¨‹ä¸ä¼ªé›†ç¾¤æ¨¡å¼ä¸­çš„è¿›ç¨‹æ²¡æœ‰åŒºåˆ«ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºè¿›ç¨‹åœ¨ä¸åŒçš„ä¸»æœºä¸Šè¿è¡Œã€‚</p></li></ol><h2 id="é”™è¯¯">é”™è¯¯</h2><p>è¿™é‡Œä¸»è¦è®°å½•é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€éƒ¨åˆ†é”™è¯¯</p><ol type="1"><li>Container exited with a non-zero exit code 1. Error file: prelaunch.err. è¯¥é”™è¯¯æ˜¯åœ¨è…¾è®¯äº‘ä¸»æœºä¸Šé…ç½®çš„ä¼ªé›†ç¾¤æ¨¡å¼è¿è¡Œ wordcount æ—¶å‡ºç°çš„ï¼Œå°è¯•äº†ç½‘ä¸Šçš„ä¸€äº›åŠæ³•éƒ½æ²¡æœ‰è§£å†³ã€‚æœ€åé‡‡ç”¨è‡ªå·±ç”µè„‘é…ç½®å†è¿è¡Œä¸€éæˆåŠŸï¼Œå¯èƒ½æ˜¯å› ä¸ºäº‘ä¸»æœºçš„é…ç½®é—®é¢˜ã€‚</li><li>åœ¨ YARN ä¸Šè¿è¡Œ Java.net.ConnectException: Connection refused å¯èƒ½æ˜¯é˜²ç«å¢™çš„åŸå› ï¼Œæ ¹æ® <a href="http://www.aboutyun.com/thread-20153-1-1.html" target="_blank" rel="noopener">ğŸ”—</a> ä¸­çš„æç¤ºè§£å†³</li><li>æ— æ³•å¤–ç½‘è®¿é—®VMä¸­çš„ Hadoop YARN çš„8088ç«¯å£ æ— æ³•é€šè¿‡äº‘ä¸»æœº ip:8088 è®¿é—® YARN çš„ Web é¡µé¢æ—¶ï¼Œä¸å¦¨é€šè¿‡ <code>netstat -nlp | grep java</code> æŸ¥çœ‹å½“å‰æä¾› web æœåŠ¡çš„ç«¯å£ï¼Œå¦‚æœ ip æ˜¯ 127.0.0.1 è¯æ˜å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹ hostsï¼Œå…·ä½“è¿‡ç¨‹è§ <a href="https://www.cnblogs.com/dongxiucai/p/9641962.html" target="_blank" rel="noopener">ğŸ”—</a>ã€‚</li><li>slave: bash: line 0: cd: /root/hadoop/hadoop-2.9.2: No such file or directory é…ç½®é›†ç¾¤æ¨¡å¼æ—¶å‡ºç°ï¼Œä¸»è¦åŸå› æ˜¯æ‰‹åŠ¨é…ç½® slave æ—¶ Hadoop å­˜æ”¾è·¯å¾„ä¸ master ä¸ä¸€è‡´ï¼Œåªéœ€è¦å°† slave çš„ Hadoop æ”¾åœ¨ä¸ master çš„åŒä¸€è·¯å¾„ä¸‹å³å¯è§£å†³ã€‚</li></ol><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="https://www.jianshu.com/p/2d8518b19ee5" target="_blank" rel="noopener">Hadoopå®Œå…¨åˆ†å¸ƒå¼éƒ¨ç½²</a></li><li><a href="https://blog.csdn.net/yangjl38/article/details/7583374" target="_blank" rel="noopener">Hadoopä¸‰ç§æ¨¡å¼ä»‹ç»</a></li><li><a href="https://blog.csdn.net/qq_26442553/article/details/78710170" target="_blank" rel="noopener">hadoopçš„ä¸‰ç§è¿è¡Œæ¨¡å¼åŒºåˆ«åŠé…ç½®è¯¦è§£</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Hadoop çš„ä¸‰ç§è¿è¡Œæ¨¡å¼ä»¥åŠé…ç½®çš„æ–¹å¼ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Hadoop åŸºç¡€" scheme="http://www.ikroal.xyz/categories/Hadoop-%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="BigData" scheme="http://www.ikroal.xyz/tags/BigData/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop åŸºç¡€ä¹‹ç”Ÿæ€åœˆ</title>
    <link href="http://www.ikroal.xyz/2019/04/21/Hadoop%E5%9F%BA%E7%A1%80%E4%B9%8B%E7%94%9F%E6%80%81%E5%9C%88/"/>
    <id>http://www.ikroal.xyz/2019/04/21/HadoopåŸºç¡€ä¹‹ç”Ÿæ€åœˆ/</id>
    <published>2019-04-21T03:14:35.000Z</published>
    <updated>2019-05-13T08:40:38.786Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ¬æ–‡ä¸»è¦ç›®çš„æ˜¯ä»‹ç» Hadoop çš„åŸºæœ¬æ¶æ„ä»¥åŠè¡ç”Ÿå‡ºæ¥çš„å„ç§å·¥å…·ï¼Œä»¥æœŸå¯¹ Hadoop æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†ã€‚</p><a id="more"></a><h2 id="hadoop-ç”Ÿæ€ç³»ç»Ÿ">Hadoop ç”Ÿæ€ç³»ç»Ÿ</h2><p>Hadoop ç”Ÿæ€ç³»ç»Ÿæ˜¯æŒ‡ä»¥ <strong>åˆ†å¸ƒå¼çš„æ–‡ä»¶ç³»ç»Ÿ HDFS</strong>ã€<strong>åˆ†å¸ƒå¼çš„è®¡ç®—æ¡†æ¶ MapReduce</strong> ä»¥åŠ<strong>èµ„æºç®¡ç†å™¨ YARN</strong>ä¸ºåŸºç¡€æ„æˆçš„åˆ†å¸ƒå¼æ•°æ®å¤„ç†ç³»ç»Ÿï¼Œå…¶ç»“æ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/Hadoop%E6%9E%B6%E6%9E%84%E5%9B%BE2.0.png"></p><p>ä¸‹é¢å°†å¯¹å›¾ä¸­å„é¡¹ç»„ä»¶åšä¸€ä¸ªä»‹ç»</p><h3 id="hdfs">HDFS</h3><p>HDFS æ˜¯ Google äº 2003 å‘è¡¨çš„ åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ GFS è®ºæ–‡çš„å¼€æºå®ç°ç‰ˆæœ¬ï¼Œä¸»è¦ç›®çš„æ˜¯ä½¿ç”¨æ™®é€šå•†ä¸šç”µè„‘è§£å†³å¤§é‡æ•°æ®çš„å­˜å‚¨ä»¥åŠè¯»å–é€Ÿåº¦é—®é¢˜ï¼Œåœ¨ GFS å‡ºç°ä¹‹å‰ä¸€èˆ¬ä¸»è¦åœ¨<strong>å•å°è®¡ç®—æœº</strong>ç”¨ RAID æ¥æé«˜æ•°æ®å­˜å‚¨é‡å’Œè¯»å–é€Ÿåº¦ã€‚ä½†æ˜¯é‡‡ç”¨ RAID ä¸€æ–¹é¢æˆæœ¬æ¯”è¾ƒé«˜ï¼ˆéœ€æ±‚å¤ªé«˜æ—¶å¯èƒ½åªæœ‰è¶…çº§è®¡ç®—æœºæ‰èƒ½æ»¡è¶³ï¼‰ï¼Œå¦ä¸€æ–¹é¢æ•°æ®é‡è¿‡å¤§æ—¶å¯èƒ½è¶…çº§è®¡ç®—æœºä¹Ÿæ— æ³•æ»¡è¶³éœ€æ±‚ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±éœ€è¦é‡‡å–<strong>åˆ†å¸ƒå¼</strong>çš„æ–¹å¼å»æ»¡è¶³æ‰©å¤§å­˜å‚¨ï¼ˆå¤šå°æœºå™¨å¤šä¸ªç£ç›˜ï¼‰å’Œå¢åŠ è¯»å–é€Ÿåº¦çš„éœ€æ±‚ï¼ˆå¤šå°æœºå™¨å¯ä»¥åŒæ—¶è¯»ï¼‰ã€‚</p><h3 id="mapreduce">MapReduce</h3><p>MapReduce æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„è®¡ç®—æ¡†æ¶ï¼Œåœ¨ MapReduce å‡ºç°ä¹‹å‰å°±å·²ç»æœ‰äº†åˆ†å¸ƒå¼è®¡ç®—è¿™ä¸ªæ¦‚å¿µã€‚ä½†æ˜¯å¤§å¤šæ•°åˆ†å¸ƒå¼è®¡ç®—åªèƒ½ä¸“é—¨ç”¨äºå¤„ç†ä¸€ç±»è¿ç®—ï¼Œè€Œ Google åœ¨å¤§é‡å®è·µä¸­æ€»ç»“å‡ºäº†ä¸€ä¸ªé€šç”¨çš„ç¼–ç¨‹æ¨¡å‹ï¼š <code>map</code> å’Œ <code>reduce</code>ã€‚å…¶ä¸­ <code>map</code> æ˜¯æŒ‡åˆ†å¼€è®¡ç®—çš„è¿‡ç¨‹ï¼Œè€Œ <code>reduce</code> æ˜¯æŒ‡åˆå¹¶ç»“æœçš„è¿‡ç¨‹ã€‚è€Œåœ¨è¿™ä¸€ç¼–ç¨‹æ¨¡å‹æ·»åŠ çš„ä¸€ç³»åˆ—æœºåˆ¶å’Œæ“ä½œæ„æˆäº† MapReduceã€‚MapReduce å¤§å¤§é™ä½äº†åˆ†å¸ƒå¼è®¡ç®—çš„é—¨æ§›ï¼Œå¯¹äºå¼€å‘äººå‘˜è€Œè¨€åªéœ€è¦ç¼–å†™ä¸€ç³»åˆ— <code>map</code> å’Œ <code>reduce</code> å‡½æ•°å³å¯å®Œæˆæ‰€éœ€çš„åˆ†å¸ƒå¼è®¡ç®—è¿‡ç¨‹ã€‚</p><h3 id="yarn">YARN</h3><p>YARN æ˜¯ä¸€ä¸ªèµ„æºç®¡ç†æ¡†æ¶ï¼Œä¸»è¦ä½œç”¨æ˜¯è´Ÿè´£é›†ç¾¤çš„èµ„æºè°ƒåº¦å’Œä½œä¸šä»»åŠ¡ç®¡ç†ã€‚YARN çš„å‡ºç°æºäº Hadoop ä¸èƒ½æ»¡è¶³ç»Ÿä¸€ä½¿ç”¨é›†ç¾¤èµ„æºçš„éœ€æ±‚ï¼Œå› ä¸º Hadoop1 ä¸­é›†ç¾¤çš„èµ„æºè°ƒåº¦å’Œä»»åŠ¡ç®¡ç†ä¸ MapReduce çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯è€¦åˆåœ¨ä¸€èµ·çš„ï¼Œè€Œåç»­å‡ºç°çš„ Sparkã€Storm ç­‰åˆ†å¸ƒå¼è®¡ç®—ç³»ç»Ÿå…¶æ¶æ„å’Œæ‰§è¡Œè¿‡ç¨‹ä¸ MapReduce ä¸åŒï¼Œæ— æ³•ç›´æ¥å‘ Hadoop ç”³è¯·é›†ç¾¤èµ„æºã€‚æ‰€ä»¥ä¸ºäº†å®ç°é›†ç¾¤èµ„æºçš„ç»Ÿä¸€ç®¡ç†ï¼Œåœ¨ Hadoop2 ä¸­å¯¹ MapReduce è¿›è¡Œäº†ä¸€ä¸ªè§£è€¦ï¼ŒæŠ½ç¦»å‡ºäº† YARN è¿™ä¸ªæ¡†æ¶ã€‚</p><h3 id="zookeeper">ZooKeeper</h3><p>Zookeeper ä¸»è¦ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªåˆ†å¸ƒå¼ã€é«˜å¯ç”¨çš„åè°ƒæœåŠ¡ï¼Œè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ç®¡ç†é—®é¢˜ï¼šç»Ÿä¸€å‘½åï¼ŒçŠ¶æ€åŒæ­¥ï¼Œé›†ç¾¤ç®¡ç†ï¼Œé…ç½®åŒæ­¥ç­‰ã€‚</p><h3 id="pig">Pig</h3><p>è™½ç„¶ MapReduce æå¤§çš„ç®€åŒ–äº†åˆ†å¸ƒå¼è®¡ç®—ç¼–ç¨‹çš„é—¨æ§›ï¼Œä½†æ˜¯ Yahoo çš„å·¥ç¨‹å¸ˆä¾ç„¶è§‰å¾— MapReduce ç¼–ç¨‹å¤ªè¿‡éº»çƒ¦ï¼Œæ‰€ä»¥ä»–ä»¬ä¾¿å¼€å‘äº† Pig è¿™ä¸ªè„šæœ¬è¯­è¨€ç”¨äºæè¿°å¯¹å¤§æ•°æ®é›†çš„æ“ä½œã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡ç¼–è¯‘ Pig è„šæœ¬ç”Ÿæˆå¯¹åº”çš„ MapReduce ç¨‹åºã€‚</p><h3 id="hive">Hive</h3><p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ SQL çš„å·¥ç¨‹å¸ˆä½¿ç”¨ MapReduceï¼ŒFacebook çš„å·¥ç¨‹å¸ˆå¼€å‘äº† Hiveï¼Œé€šè¿‡ Hive ç†Ÿæ‚‰æ•°æ®åº“çš„å·¥ç¨‹å¸ˆå¯ä»¥æ— é—¨æ§›çš„ä½¿ç”¨ MapReduceã€‚</p><h3 id="mahout">Mahout</h3><p>Mahout çš„ä¸»è¦ç›®æ ‡æ˜¯åˆ›å»ºä¸€äº›å¯æ‰©å±•çš„æœºå™¨å­¦ä¹ é¢†åŸŸç»å…¸ç®—æ³•çš„å®ç°ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘äººå‘˜æ›´åŠ æ–¹ä¾¿å¿«æ·åœ°åˆ›å»ºæ™ºèƒ½åº”ç”¨ç¨‹åºã€‚Mahout ç°åœ¨å·²ç»åŒ…å«äº†èšç±»ã€åˆ†ç±»ã€æ¨èå¼•æ“ï¼ˆååŒè¿‡æ»¤ï¼‰å’Œé¢‘ç¹é›†æŒ–æ˜ç­‰å¹¿æ³›ä½¿ç”¨çš„æ•°æ®æŒ–æ˜æ–¹æ³•ã€‚</p><h3 id="tez">Tez</h3><p>Tez æ˜¯ Apache æœ€æ–°å¼€æºçš„æ”¯æŒ DAG ä½œä¸šçš„è®¡ç®—æ¡†æ¶ï¼Œå®ƒç›´æ¥æºäº MapReduce æ¡†æ¶ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å°† Map å’Œ Reduce ä¸¤ä¸ªæ“ä½œè¿›ä¸€æ­¥æ‹†åˆ†ï¼Œå³ Map è¢«æ‹†åˆ†æˆ Inputã€Processorã€Sortã€Mergeå’ŒOutputï¼Œ Reduce è¢«æ‹†åˆ†æˆ Inputã€Shuffleã€Sortã€Mergeã€Processor å’Œ Output ç­‰ã€‚</p><h3 id="hase">Hase</h3><p>HBase æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨ HDFS ä¹‹ä¸Šï¼Œé¢å‘åˆ—çš„é’ˆå¯¹ç»“æ„åŒ–æ•°æ®çš„å¯ä¼¸ç¼©ã€é«˜å¯é ã€é«˜æ€§èƒ½ã€åˆ†å¸ƒå¼å’Œé¢å‘åˆ—çš„åŠ¨æ€æ¨¡å¼æ•°æ®åº“ã€‚</p><h3 id="flume">Flume</h3><p>Cloudera å¼€æºçš„æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼Œå…·æœ‰åˆ†å¸ƒå¼ã€é«˜å¯é ã€é«˜å®¹é”™ã€æ˜“äºå®šåˆ¶å’Œæ‰©å±•çš„ç‰¹ç‚¹ã€‚</p><h3 id="sqoop">Sqoop</h3><p>Sqoop æ˜¯ SQL-to-Hadoop çš„ç¼©å†™ï¼Œä¸»è¦ç”¨äºä¼ ç»Ÿæ•°æ®åº“å’Œ Hadoop ä¹‹å‰ä¼ è¾“æ•°æ®ã€‚æ•°æ®çš„å¯¼å…¥å’Œå¯¼å‡ºæœ¬è´¨ä¸Šæ˜¯Mapreduce ç¨‹åºï¼Œå……åˆ†åˆ©ç”¨äº† MR çš„å¹¶è¡ŒåŒ–å’Œå®¹é”™æ€§ã€‚</p><h3 id="ambari">Ambari</h3><p>Ambari çš„ä½œç”¨æ¥è¯´ï¼Œå°±æ˜¯åˆ›å»ºã€ç®¡ç†ã€ç›‘è§† Hadoop çš„é›†ç¾¤ï¼Œæ˜¯ä¸ºäº†è®© Hadoop ä»¥åŠç›¸å…³çš„å¤§æ•°æ®è½¯ä»¶æ›´å®¹æ˜“ä½¿ç”¨çš„ä¸€ä¸ª web å·¥å…·ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æ€»çš„æ¥è¯´ HDFS ã€MapReduce ä»¥åŠ YARN æ˜¯ Hadoop çš„æ ¸å¿ƒç»„ä»¶ï¼Œè€Œæˆ‘ä»¬å­¦ä¹  Hadoop æœ€å¥½ä»æ ¸å¿ƒç»„ä»¶å¼€å§‹å­¦ä¹ å…¶åŸç†æœºåˆ¶ï¼Œå†é€æ¸å¾€ä¸Šå±‚è¿›è¡Œäº†è§£ã€‚</p><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="https://blog.csdn.net/hu_belif/article/details/83058798" target="_blank" rel="noopener">Hadoopç”Ÿæ€åœˆæ€»ç»“â€”â€”å¤§æ•°æ®</a></li><li><a href="https://blog.csdn.net/zcb_data/article/details/80402411" target="_blank" rel="noopener">hadoopç”Ÿæ€åœˆå„ä¸ªç»„ä»¶ç®€ä»‹</a></li><li><a href="https://www.cnblogs.com/gridmix/p/5102694.html" target="_blank" rel="noopener">å¤§æ•°æ®æŠ€æœ¯Hadoopå…¥é—¨ç†è®ºç³»åˆ—ä¹‹ä¸€----hadoopç”Ÿæ€åœˆä»‹ç»</a></li><li><a href="https://time.geekbang.org/column/intro/133" target="_blank" rel="noopener">ä»0å¼€å§‹å­¦å¤§æ•°æ®---æå®¢æ—¶é—´</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;æœ¬æ–‡ä¸»è¦ç›®çš„æ˜¯ä»‹ç» Hadoop çš„åŸºæœ¬æ¶æ„ä»¥åŠè¡ç”Ÿå‡ºæ¥çš„å„ç§å·¥å…·ï¼Œä»¥æœŸå¯¹ Hadoop æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Hadoop åŸºç¡€" scheme="http://www.ikroal.xyz/categories/Hadoop-%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="BigData" scheme="http://www.ikroal.xyz/tags/BigData/"/>
    
  </entry>
  
  <entry>
    <title>Java åŸºç¡€ä¹‹é›†åˆæ¡†æ¶(ä¸€)ï¼šé›†åˆæ¡†æ¶</title>
    <link href="http://www.ikroal.xyz/2018/03/17/Java%E5%9F%BA%E7%A1%80%E4%B9%8B%E9%9B%86%E5%90%88-%E4%B8%80/"/>
    <id>http://www.ikroal.xyz/2018/03/17/JavaåŸºç¡€ä¹‹é›†åˆ-ä¸€/</id>
    <published>2018-03-17T05:47:45.000Z</published>
    <updated>2019-05-13T08:44:47.605Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2><p>é›†åˆç±»åº”è¯¥æ˜¯å¹³æ—¶ä½¿ç”¨çš„éå¸¸é¢‘ç¹çš„ç±»äº†ï¼Œä½†æ˜¯å¯¹å…¶å†…éƒ¨æ„æˆå´ä¸€ç›´ä¸å¤ªæ¸…æ™°ï¼Œæ‰€ä»¥å¸Œæœ›é€šè¿‡æœ¬ç¯‡æ–‡ç« å°è¯•å»ç†è§£é›†åˆæ¡†æ¶çš„æ•´ä½“è®¾è®¡ä»¥åŠé›†åˆå­˜åœ¨çš„å¿…è¦æ€§ã€‚åœ¨å¼€å§‹åˆ†æä¹‹å‰é¦–å…ˆè®©æˆ‘ä»¬æ€è€ƒä»¥ä¸‹é—®é¢˜ï¼š</p><ol type="1"><li>é›†åˆå­˜åœ¨çš„æ„ä¹‰ï¼Œé›†åˆå’Œæ•°ç»„çš„åŒºåˆ«</li><li>é›†åˆæ¡†æ¶çš„è®¾è®¡æ„å›¾</li><li>é›†åˆçš„å¸¸ç”¨æ“ä½œ<a id="more"></a></li></ol><h2 id="é›†åˆå­˜åœ¨çš„æ„ä¹‰ä»¥åŠä¸æ•°ç»„çš„åŒºåˆ«">é›†åˆå­˜åœ¨çš„æ„ä¹‰ä»¥åŠä¸æ•°ç»„çš„åŒºåˆ«</h2><p>æƒ³è¦äº†è§£ Java ä¸ºä»€ä¹ˆä¼šè®¾è®¡é›†åˆï¼Œå°±å¾—å…ˆæ˜ç™½é›†åˆçš„å‡ºç°è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œå…³äºè¿™ä¸€é—®é¢˜ã€ŒJava ç¼–ç¨‹æ€æƒ³ã€ä¸­æ˜¯è¿™ä¹ˆæè¿°çš„</p><blockquote><p>å¦‚æœä¸€ä¸ªç¨‹åºä¸­åªåŒ…å«å›ºå®šæ•°é‡çš„ä¸”å…¶ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯å·²çŸ¥çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ç¨‹åºã€‚ é€šå¸¸ï¼Œç¨‹åºæ€»æ˜¯æ ¹æ®è¿è¡Œæ—¶æ‰çŸ¥é“çš„æŸäº›æ¡ä»¶å»åˆ›å»ºæ–°å¯¹è±¡ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œä¸ä¼šçŸ¥é“æ‰€éœ€å¯¹è±¡çš„æ•°é‡ï¼Œç”šè‡³ä¸çŸ¥é“ç¡®åˆ‡çš„ç±»å‹ã€‚</p></blockquote><p>æ‰€ä»¥ä¹‹æ‰€ä»¥éœ€è¦é›†åˆæ˜¯å› ä¸ºåœ¨ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ä¼šéœ€è¦ä¿å­˜<strong>æ•°é‡ä¸å®š</strong>ã€<strong>ç±»å‹ä¸å®š</strong>çš„æ•°æ®ã€‚</p><p>é’ˆå¯¹<strong>æ•°é‡ä¸å®š</strong>è€ƒè™‘ä¸‹é¢è¿™ç§æƒ…å†µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String STOP_FLAG = <span class="string">"s"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        String collection[] = <span class="keyword">new</span> String[COUNT];</span><br><span class="line">        System.out.println(<span class="string">"è¾“å…¥å³å°†ä¿å­˜çš„æ•°æ®"</span>);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (!(collection[i] = scanner.next()).equals(STOP_FLAG)) &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        scanner.close();</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; collection.length; i++) &#123;</span><br><span class="line">            System.out.print(collection[i] + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œä¸ºä¸€ä¸ªç®€å•çš„è¾“å…¥ç¨‹åºï¼Œé‡‡ç”¨æ•°ç»„çš„å½¢å¼å»ä¿å­˜ç”¨æˆ·çš„è¾“å…¥ï¼Œå½“ç”¨æˆ·çš„è¾“å…¥è¶…è¿‡æ•°ç»„å¯å®¹çº³çš„æ•°é‡çš„æ—¶å€™ä¾¿ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³å‘¢ï¼Ÿä¸€ç§æ–¹å¼æ˜¯å°†æ•°ç»„çš„æ•°é‡åˆ†é…çš„è¶³å¤Ÿå¤§ï¼Œä½†æ˜¯é‡‡å–è¿™ç§æ–¹å¼ææœ‰å¯èƒ½æµªè´¹å†…å­˜ç©ºé—´ã€‚å¦ä¸€ç§æ–¹å¼åˆ™æ˜¯åŠ¨æ€æ‰©å±•å¤§å°ï¼Œé€šè¿‡åŠ¨æ€æ‰©å±•å¤§å°æ—¢èƒ½å¤Ÿå®¹çº³è¶³å¤Ÿå¤šçš„å…ƒç´ ï¼Œåˆèƒ½å¤ŸèŠ‚çº¦å†…å­˜ç©ºé—´ã€‚è€Œé›†åˆæ­£å…·å¤‡åŠ¨æ€æ‰©å±•å¤§å°è¿™ä¸€ç‰¹æ€§ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé›†åˆå°±ä½“ç°å‡ºäº†å®ƒçš„ä½œç”¨ã€‚ è‡³äº<strong>ç±»å‹ä¸å®š</strong>ï¼Œè€ƒè™‘å¦ä¸€ç§æƒ…å†µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rookieyang.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataArray</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String datas[];</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COUNT = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataArray</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        datas = <span class="keyword">new</span> String[COUNT];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¹Ÿå¯è‡ªè¡Œå¯¹æ•°ç»„è¿›è¡ŒåŠ¨æ€æ‰©å±•ï¼Œè¿™é‡Œåªæ˜¯æµ‹è¯•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addData</span><span class="params">(String data)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            datas[index] = data;</span><br><span class="line">            index++;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">"è¶…å‡ºæœ€å¤§çš„å­˜å‚¨èŒƒå›´"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.rookieyang.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataCollection</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; datas;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addData</span><span class="params">(T data)</span> </span>&#123;</span><br><span class="line">        datas.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºå¯¹äºæ•°ç»„è€Œè¨€åœ¨åŠ¨æ€æ·»åŠ æ•°æ®ä¼šç•¥æ˜¾éº»çƒ¦ï¼Œè€Œä¸”åªèƒ½ä¿å­˜ String ç±»å‹æ•°æ®ï¼Œä½†å¯¹äºé‡‡ç”¨é›†åˆè€Œè¨€ï¼Œä½¿ç”¨èµ·æ¥ä¸ä»…ç®€å•è€Œä¸”å…¶æ‰©å±•æ€§ä¹Ÿå¼ºï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å†³å®šé›†åˆä¸­ä¿å­˜ä½•ç§ç±»å‹æ•°æ®ï¼Œè¿™å°±å®ç°äº†ä»£ç çš„å¤ç”¨ã€‚ å¯¹äºé›†åˆå’Œæ•°ç»„è€Œè¨€ï¼Œå…¶ä¸»è¦åŒºåˆ«å¦‚ä¸‹</p><ul><li>æ•°ç»„æ˜¯é™æ€çš„ï¼Œä¸€ä¸ªæ•°ç»„å®ä¾‹å…·æœ‰å›ºå®šçš„å¤§å°ï¼Œé›†åˆæ˜¯åŠ¨æ€çš„ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€è¦åŠ¨æ€æ‰©å±•å¤§å°</li><li>æ•°ç»„æ—¢å¯ä»¥ä¿å­˜åŸºæœ¬ç±»å‹ï¼Œä¹Ÿå¯ä¿å­˜å¼•ç”¨ç±»å‹ï¼Œé›†åˆåªèƒ½ä¿å­˜å¼•ç”¨ç±»å‹ï¼Œåœ¨ä¿å­˜åŸºæœ¬ç±»å‹çš„æ—¶å€™ä¼šè‡ªåŠ¨è£…ç®±</li></ul><h2 id="é›†åˆæ•´ä½“æ¡†æ¶åˆ†æ">é›†åˆæ•´ä½“æ¡†æ¶åˆ†æ</h2><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/collections-all-structure.png"></p><p>é¦–å…ˆçœ‹ä¸‹é›†åˆçš„æ•´ä½“æ¡†æ¶å›¾ï¼Œå¯¹äºé›†åˆè€Œè¨€ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šCollection å’Œ Mapï¼Œå…¶ä¸­ Collection ä¸»è¦ä¿å­˜çš„æ˜¯å•ä¸ªå…ƒç´ ï¼Œè€Œ Map åˆ™å¯ä»¥å°†æŸäº›å¯¹è±¡ä¸å…¶å®ƒä¸€äº›å¯¹è±¡å­˜åœ¨çš„å…³ç³»ç”¨ key-value æ–¹å¼ä¿å­˜ä¸‹æ¥ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†å°±è¿™ä¸¤ä¸ªéƒ¨åˆ†å±•å¼€åˆ†æã€‚</p><h3 id="collection-æ¥å£">Collection æ¥å£</h3><h4 id="ç»“æ„åˆ†æ">ç»“æ„åˆ†æ</h4><p>è¿™é‡Œä¸ºäº†æ–¹ä¾¿åˆ†æåªå±•ç¤ºäº†æ¥å£çš„ç»§æ‰¿ç»“æ„</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/collection-structure.png"></p><p>é¦–å…ˆæŸ¥çœ‹ Iterable</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Iterable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="function">Iterator&lt;T&gt; <span class="title">iterator</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">forEach</span><span class="params">(Consumer&lt;? <span class="keyword">super</span> T&gt; action)</span> </span>&#123;</span><br><span class="line">        Objects.requireNonNull(action);</span><br><span class="line">        <span class="keyword">for</span> (T t : <span class="keyword">this</span>) &#123;</span><br><span class="line">            action.accept(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Spliterator&lt;T&gt; <span class="title">spliterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Spliterators.spliteratorUnknownSize(iterator(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Itrable æ¥å£ä¸­æ‹¥æœ‰ä¸€ä¸ª iterator æ–¹æ³•ä»¥åŠä¸¤ä¸ª 1.8 æ·»åŠ çš„é»˜è®¤æ–¹æ³•ï¼š</p><ul><li>iteratorï¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ç”¨äºéå†</li><li>forEachï¼šæ ¹æ®ç»™å®šçš„ action å¤„ç†æ¯ä¸ªå…ƒç´ </li><li>spliteratorï¼šæä¾›äº†ä¸€ä¸ªç”¨äºå¹¶è¡Œéå†çš„è¿­ä»£å™¨ï¼Œç”±äºè¿™é‡Œä¸»è¦æ¢è®¨ç»“æ„è®¾è®¡ï¼Œæ‰€ä»¥æš‚ä¸”ä¸å±•å¼€è¯´æ˜</li></ul><p>çœ‹åˆ°è¿™é‡Œæˆ‘äº§ç”Ÿäº†ç¬¬ä¸€ä¸ªç–‘é—®ï¼Œä¸ºä»€ä¹ˆ Collection ä¸ç›´æ¥ç»§æ‰¿ Iterator æ¥å£ï¼Œè€Œéœ€è¦ç”¨ Iterable è¿›è¡ŒåŒ…è£…ä¹‹åå†ç»§æ‰¿å‘¢ï¼Ÿ è¿™é‡Œå‡è®¾å­˜åœ¨ä¸€ä¸ª CustomizeCollection æ¥å£åœ¨åŒ…å«äº† Collection æ¥å£æ–¹æ³•çš„åŸºç¡€ä¸Šç»§æ‰¿äº† Iterator æ¥å£è€Œä¸æ˜¯ Iterableï¼ˆæˆ–è€…æ˜¯ç›´æ¥åŒ…å«äº† Collection æ¥å£æ–¹æ³•ä»¥åŠ Iterator æ¥å£æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å®ç° CustomizeCollection æ¥å£çš„æ—¶å€™æ‰€å¾—åˆ°çš„ CustomizeClass ç±»ç»“æ„å°†å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/customizeClass.png"> å¯ä»¥çœ‹åˆ°å¦‚æœæƒ³å®ç° CustomizeCollection åˆ™å¿…é¡»è¦å®ç° Iterator æ¥å£æ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶é‡‡ç”¨è¿™ç§æ–¹å¼å¯èƒ½å¯¼è‡´åœ¨ä¸åŒçš„ CustomizeCollection æ¥å£å®ç°ç±»ä¸­å­˜åœ¨ç›¸åŒçš„ Itrator æ¥å£æ–¹æ³•å®ç°ï¼ˆéå†è¿™ä¸€æ“ä½œæŸäº›æ—¶å€™å¯èƒ½æ˜¯é€šç”¨çš„ï¼‰ï¼Œè¿™æ ·ä¸€æ¥å°±é™ä½äº†<strong>ä»£ç çš„å¤ç”¨æ€§</strong>ï¼Œå¦å¤–ä»<strong>å•ä¸€èŒè´£</strong>çš„è§’åº¦æ¥è€ƒè™‘ï¼ŒCustomizeCollection æ¥å£ä¸­æ‰åˆäº†é›†åˆå…ƒç´ çš„ç®¡ç†åŠŸèƒ½ä»¥åŠè¿­ä»£å™¨çš„åŠŸèƒ½ï¼Œè€Œé‡‡ç”¨ Iterable åŒ…è£…ä¹‹ååˆ™å¯ä»¥å°†è¿™ä¸¤ä¸ªåŠŸèƒ½è¿›è¡Œä¸€å®šç¨‹åº¦ä¸Šçš„åˆ†å‰²ã€‚</p><p>æ¥ç€ä» Collection åˆå»¶å±•å‡ºä¸‰ä¸ªæ¥å£ï¼Œè¿™ä¸‰ä¸ªæ¥å£æ˜¯å¯¹é›†åˆåŠŸèƒ½çš„å…·ä½“åŒ–ï¼š</p><ul><li>Set è¡¨ç¤ºçš„æ˜¯æ— åºã€ä¸å­˜åœ¨é‡å¤å…ƒç´ çš„é›†åˆ</li><li>List è¡¨ç¤ºçš„æ˜¯ä¸€ç§æœ‰åºã€å¯é‡å¤å…ƒç´ çš„é›†åˆ</li><li>Queue è¡¨ç¤ºçš„æ˜¯ä¸€ç§é˜Ÿåˆ—ï¼Œå…¶å®é˜Ÿåˆ—ä¹Ÿæ˜¯ä¸€ç§æœ‰åºçš„é›†åˆï¼Œä½†ä¹‹æ‰€ä»¥ä¼šå•ç‹¬è®¾è®¡å‡ºä¸€ä¸ªæ¥å£çš„åŸå› åœ¨äºï¼ŒQueue æ¥å£å»é™¤äº†å¾ˆå¤šä¸éœ€è¦çš„åŠŸèƒ½ï¼Œä½¿å¾—æ¥å£æœ¬èº«æ›´ç¬¦åˆ<strong>å•ä¸€èŒè´£</strong>ä»¥åŠ<strong>æ¥å£éš”ç¦»</strong>åŸåˆ™ã€‚</li></ul><h4 id="åŠŸèƒ½åˆ†æ">åŠŸèƒ½åˆ†æ</h4><p>Collection æ¥å£çš„åŠŸèƒ½å¤§è‡´æ¦‚æ‹¬å¦‚ä¸‹ï¼ˆæš‚ä¸ä»‹ç» 1.8 å¼•å…¥çš„é»˜è®¤æ–¹æ³•ï¼‰</p><ul><li>å¢åŠ <ul><li>boolean add(E e) å¢åŠ å•å…ƒå…ƒç´ </li><li>boolean addAll(Collection&lt;? extends E&gt; c) å¢åŠ é›†åˆ c çš„å…ƒç´ </li></ul></li><li>åˆ é™¤<ul><li>boolean remove(Object o) ç§»é™¤å…ƒç´ </li><li>boolean removeAll(Collection&lt;?&gt; c) ç§»é™¤é›†åˆ c çš„å…ƒç´ </li><li>void clear() æ¸…ç©ºé›†åˆ</li></ul></li><li>æŸ¥è¯¢<ul><li>boolean contains(Object o) æŸ¥è¯¢é›†åˆæ˜¯å¦å­˜åœ¨å…ƒç´  o</li><li>boolean containsAll(Collection&lt;?&gt; c)æŸ¥è¯¢å½“å‰é›†åˆæ˜¯å¦å­˜åœ¨é›†åˆ c ä¸­çš„æ‰€æœ‰å…ƒç´ </li><li>boolean isEmpty() æŸ¥è¯¢æ˜¯å¦é›†åˆä¸ºç©º</li><li>int size() æŸ¥è¯¢é›†åˆçš„å¤§å°</li></ul></li><li>å…¶å®ƒ<ul><li>Iterator<e> iterator() è¿”å›è¿­ä»£å™¨</e></li><li>boolean retainAll(Collection&lt;?&gt; c) å–å½“å‰é›†åˆå’Œé›†åˆ c çš„äº¤é›†</li></ul></li></ul><p>Set æ¥å£ä¸ Colleciton æ¥å£å®šä¹‰çš„æ–¹æ³•å®Œå…¨ä¸€è‡´</p><p>List æ¥å£åœ¨ Collectiion æ¥å£åŸºç¡€ä¸Šæ–°å¢äº†ä¸€äº›ä¸ç´¢å¼•æœ‰å…³çš„æ–¹æ³•</p><ul><li>å¢åŠ <ul><li>void add(int index, E element) åœ¨ index å¤„æ’å…¥å…ƒç´ </li></ul></li><li>åˆ é™¤<ul><li>E remove(int index) åˆ é™¤ index å¤„çš„å…ƒç´ </li></ul></li><li>ä¿®æ”¹<ul><li>E set(int index, E element) ä¿®æ”¹ index çš„å…ƒç´ ä¸º element</li></ul></li><li>æŸ¥è¯¢<ul><li>E get(int index) è·å– index å¤„çš„å…ƒç´ </li><li>int indexOf(Object o) è·å–å…ƒç´  o ç¬¬ä¸€æ¬¡å‡ºç°çš„ index</li><li>int lastIndexOf(Object o) è·å–å…ƒç´  o æœ€åä¸€æ¬¡å‡ºç°çš„ index</li></ul></li><li>å…¶å®ƒ<ul><li>ListIterator<e> listIterator() è¿”å› ListIterator ç±»å‹çš„è¿­ä»£å™¨</e></li><li>ListIterator<e> listIterator(int index) è¿”å›ä» index å¼€å§‹çš„ ListIterator ç±»å‹çš„è¿­ä»£å™¨</e></li></ul></li></ul><p>Queue æ¥å£æ–°å¢çš„æ–¹æ³•å¦‚ä¸‹</p><ul><li>å‡ºé˜Ÿ<ul><li>E peek() å‡ºé˜Ÿä½†æ˜¯ä¸åˆ é™¤å…ƒç´ ï¼Œåœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™è¿”å› null</li><li>E element() å‡ºé˜Ÿä½†æ˜¯ä¸åˆ é™¤å…ƒç´ ï¼Œåœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸</li><li>E poll() å‡ºé˜Ÿå¹¶ä¸”åˆ é™¤å…ƒç´ ï¼Œåœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™è¿”å›null</li><li>E remove() å‡ºé˜Ÿå¹¶ä¸”åˆ é™¤å…ƒç´ ï¼Œåœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸</li></ul></li><li>å…¥é˜Ÿ<ul><li>boolean offer(E e)</li></ul></li></ul><h3 id="map-æ¥å£">Map æ¥å£</h3><h4 id="ç»“æ„åˆ†æ-1">ç»“æ„åˆ†æ</h4><p>Map æ˜¯ä¸€ä¸ªå•ä¸€çš„æ¥å£ï¼Œå¹¶æ²¡æœ‰åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œä½†åœ¨ Map æ¥å£çš„å†…éƒ¨æœ‰ä¸€ä¸ª Entry æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function">K <span class="title">getKey</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">V <span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">V <span class="title">setValue</span><span class="params">(V value)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° Entry é‡Œé¢å°è£…çš„éƒ½æ˜¯å’Œ Map ä¸­å…ƒç´ æœ‰å…³çš„æ“ä½œï¼Œè¿™ä¸€æ¥å£ä¸»è¦ç”¨æ¥è§„å®š Map ä¸­ç”¨æ¥å­˜å‚¨ key-value æ‰€éœ€è¦æä¾›çš„åŠŸèƒ½</p><h4 id="åŠŸèƒ½åˆ†æ-1">åŠŸèƒ½åˆ†æ</h4><p>Map æ¥å£çš„åŠŸèƒ½å¤§è‡´å¦‚ä¸‹ï¼š</p><ul><li>å¢åŠ æˆ–ä¿®æ”¹<ul><li>V put(K key, V value) å­˜å‚¨ key å’Œ valueï¼Œå¦‚æœ key å·²ç»å­˜åœ¨åˆ™ä¼šå°†åŸæ¥çš„ value æ›¿æ¢ä¸ºæ–°çš„ value</li><li>void putAll(Map&lt;? extends K, ? extends V&gt; m) å°† m ä¸­çš„ key å’Œ value æ·»åŠ åˆ°å½“å‰ Map ä¸­</li></ul></li><li>åˆ é™¤<ul><li>V remove(Object key) ç§»é™¤æŒ‡å®šçš„ key ä»¥åŠå…³è”çš„ value</li><li>void clear() æ¸…ç©º Map</li></ul></li><li>æŸ¥æ‰¾<ul><li>V get(Object key) è·å– key å…³è”çš„ value</li><li>boolean containsKey(Object key) åˆ¤æ–­å½“å‰ Map æ˜¯å¦åŒ…å«æŒ‡å®šçš„ key</li><li>boolean containsValue(Object value) åˆ¤æ–­å½“å‰Map æ˜¯å¦åŒ…å«æŒ‡å®šçš„ value</li><li>boolean isEmpty() åˆ¤æ–­å½“å‰ Map æ˜¯å¦ä¸ºç©º</li><li>int size() è·å–å½“å‰ Map çš„å¤§å°</li></ul></li><li>å…¶å®ƒ<ul><li>Set<k> keySet() å°† key ç”Ÿæˆ Set é›†åˆ</k></li><li>Collection<v> values() å°† value ç”Ÿæˆé›†åˆ</v></li><li>Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet() å°† Map ä¸­ä¿å­˜çš„å…ƒç´ ç”Ÿæˆ Set é›†åˆï¼Œä¸€èˆ¬ç”¨äºéå†é›†åˆ</li></ul></li></ul><p>ä» Map æ¥å£æ‰€æä¾›çš„æ–¹æ³•æ¥çœ‹ï¼Œå¤§éƒ¨åˆ†æ–¹æ³•å…¶å®ä¸ Collection æ¥å£ä¸­æ— å¼‚ï¼Œåªæ˜¯åœ¨ Collection ä¸­æ˜¯å¯¹å•ä¸ªå…ƒç´ è¿›è¡Œæ“ä½œï¼Œä½†æ˜¯åœ¨ Map æ¥å£ä¸­æ˜¯å¯¹ key-value è¿™ç§å…³è”å…ƒç´ è¿›è¡Œæ“ä½œã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>Java é›†åˆæ¡†æ¶ä»¥ Colleciton å’Œ Map ä¸ºåŸºç¡€ï¼Œé«˜åº¦æŠ½è±¡äº†å¯¹å•ä¸ªå…ƒç´ ä»¥åŠé”®å€¼å¯¹çš„æ“ä½œï¼Œè€Œåœ¨æ­¤åŸºç¡€ä¸Šä¸ºäº†å‡è½»ä¸šåŠ¡å¼€å‘éš¾åº¦ï¼Œé›†åˆæ¡†æ¶åˆæä¾›äº†å¤šä¸ªå®ç°ç±»ä»¥ä¾›ä½¿ç”¨ï¼Œå°½ç®¡çœ‹èµ·æ¥é”™ç»¼å¤æ‚ï¼Œä½†æ˜¯åªè¦äº†è§£æ ¸å¿ƒçš„æ¥å£ä¹‹é—´çš„ç»§æ‰¿å…³ç³»ä¾¿å¯å¯¹é›†åˆæ¡†æ¶æœ‰ä¸ªè¾ƒä¸ºæ¸…æ™°çš„è®¤è¯†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é—®é¢˜&quot;&gt;é—®é¢˜&lt;/h2&gt;
&lt;p&gt;é›†åˆç±»åº”è¯¥æ˜¯å¹³æ—¶ä½¿ç”¨çš„éå¸¸é¢‘ç¹çš„ç±»äº†ï¼Œä½†æ˜¯å¯¹å…¶å†…éƒ¨æ„æˆå´ä¸€ç›´ä¸å¤ªæ¸…æ™°ï¼Œæ‰€ä»¥å¸Œæœ›é€šè¿‡æœ¬ç¯‡æ–‡ç« å°è¯•å»ç†è§£é›†åˆæ¡†æ¶çš„æ•´ä½“è®¾è®¡ä»¥åŠé›†åˆå­˜åœ¨çš„å¿…è¦æ€§ã€‚åœ¨å¼€å§‹åˆ†æä¹‹å‰é¦–å…ˆè®©æˆ‘ä»¬æ€è€ƒä»¥ä¸‹é—®é¢˜ï¼š&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;é›†åˆå­˜åœ¨çš„æ„ä¹‰ï¼Œé›†åˆå’Œæ•°ç»„çš„åŒºåˆ«&lt;/li&gt;
&lt;li&gt;é›†åˆæ¡†æ¶çš„è®¾è®¡æ„å›¾&lt;/li&gt;
&lt;li&gt;é›†åˆçš„å¸¸ç”¨æ“ä½œ&lt;/li&gt;&lt;/ol&gt;
    
    </summary>
    
      <category term="JavaåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Java" scheme="http://www.ikroal.xyz/tags/Java/"/>
    
      <category term="é›†åˆ" scheme="http://www.ikroal.xyz/tags/%E9%9B%86%E5%90%88/"/>
    
  </entry>
  
  <entry>
    <title>Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆå››ï¼‰ä¹‹Lanucherçš„å¯åŠ¨</title>
    <link href="http://www.ikroal.xyz/2018/02/28/Android%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E7%AE%80%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89/"/>
    <id>http://www.ikroal.xyz/2018/02/28/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆå››ï¼‰/</id>
    <published>2018-02-28T14:55:07.000Z</published>
    <updated>2019-05-13T08:28:40.180Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>é€šè¿‡<a href="/2018/01/22/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰/" title="Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰">Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰</a>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å·²ç»å¤§è‡´äº†è§£äº†æœåŠ¡æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Œæ¥ç€æœ¬æ–‡å°†ä¼šåˆ†æç³»ç»Ÿå¯åŠ¨çš„æœ€åä¸€æ­¥ï¼Œå³ Launcher çš„å¯åŠ¨ã€‚<a id="more"></a></p><h2 id="lanucherçš„å¯åŠ¨æµç¨‹">Lanucherçš„å¯åŠ¨æµç¨‹</h2><p>åœ¨ SystemServer ä¸­å¯åŠ¨çš„è¿™ä¹ˆå¤šæœåŠ¡å½“ä¸­ ActivityManagerService æ˜¯è´Ÿè´£å››å¤§ç»„ä»¶çš„å¯åŠ¨ã€åˆ‡æ¢ã€è°ƒåº¦çš„ï¼Œæ‰€ä»¥ Launcher çš„å¯åŠ¨ä¸ ActivityManagerService ç¦»ä¸å¼€å…³ç³» frameworks/base/services/java/com/android/server/SystemServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We now tell the activity manager it is okay to run third party</span></span><br><span class="line">    <span class="comment">// code.  It will call back into us once it has gotten to the state</span></span><br><span class="line">    <span class="comment">// where third party code can really run (but before it has actually</span></span><br><span class="line">    <span class="comment">// started launching the initial applications), for us to complete our</span></span><br><span class="line">    <span class="comment">// initialization.</span></span><br><span class="line">    mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            ....</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                startSystemUi(context);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                reportWtf(<span class="string">"starting System UI"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ startOtherServices ä¸­è°ƒç”¨äº† mActivityManagerService çš„ systemReady æ–¹æ³•ï¼Œå¹¶åœ¨ä¼ å…¥çš„ Runnable å¯¹è±¡ä¸­å¯åŠ¨äº† SystemUiï¼Œæ¥ç€ç»§ç»­æŸ¥çœ‹ systemReady æ–¹æ³• frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//ç¬¬ä¸€æ¬¡ä¸ºfalseä¸ä¼šè¿›å…¥</span></span><br><span class="line">        <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">            <span class="comment">// If we're done calling all the receivers, run the next "boot phase" passed in</span></span><br><span class="line">            <span class="comment">// by the SystemServer</span></span><br><span class="line">            <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                goingCallback.run();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ....</span><br><span class="line">        mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// Make sure we have no pre-ready processes sitting around.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//æ‰§è¡Œä¼ å…¥çš„Runnableå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) goingCallback.run();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// Only start up encryption-aware persistent apps; once user is</span></span><br><span class="line">        <span class="comment">// unlocked we'll come back around and start unaware apps</span></span><br><span class="line">        startPersistentApps(PackageManager.MATCH_DIRECT_BOOT_AWARE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start up initial activity.</span></span><br><span class="line">        mBooting = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// Enable home activity for system user, so that the system can always boot</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//å¯åŠ¨Lanucherçš„ä¸»Activity</span></span><br><span class="line">        startHomeActivityLocked(currentUserId, <span class="string">"systemReady"</span>);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        mStackSupervisor.resumeFocusedStackTopActivityLocked();</span><br><span class="line">        mUserController.sendUserSwitchBroadcastsLocked(-<span class="number">1</span>, currentUserId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ systemReady æ–¹æ³•ä¸­ä¼šè°ƒç”¨ startHomeActivityLocked</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startHomeActivityLocked</span><span class="params">(<span class="keyword">int</span> userId, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL</span><br><span class="line">            &amp;&amp; mTopAction == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We are running in factory test mode, but unable to find</span></span><br><span class="line">        <span class="comment">// the factory test app, so just sit around displaying the</span></span><br><span class="line">        <span class="comment">// error message and don't try to start anything.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ„å»ºå¯åŠ¨Lanucherä¸»Activityçš„Intentå¯¹è±¡</span></span><br><span class="line">    Intent intent = getHomeIntent();</span><br><span class="line">    ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId);</span><br><span class="line">    <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(aInfo.applicationInfo.packageName, aInfo.name));</span><br><span class="line">        <span class="comment">// Don't do this if the home app is currently being</span></span><br><span class="line">        <span class="comment">// instrumented.</span></span><br><span class="line">        aInfo = <span class="keyword">new</span> ActivityInfo(aInfo);</span><br><span class="line">        aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId);</span><br><span class="line">        ProcessRecord app = getProcessRecordLocked(aInfo.processName,</span><br><span class="line">                aInfo.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (app == <span class="keyword">null</span> || app.instrumentationClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">            <span class="comment">//å¯åŠ¨Lanucherä¸»Activity</span></span><br><span class="line">            mActivityStarter.startHomeActivityLocked(intent, aInfo, reason);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"No home screen found for "</span> + intent, <span class="keyword">new</span> Throwable());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥ startHomeActivityLocked æ–¹æ³•ä¹‹åå¯ä»¥çœ‹åˆ°è°ƒç”¨äº† getHomeIntent è¿”å›äº†ä¸€ä¸ª Intentï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¯åŠ¨ä¸€ä¸ª Activity çš„ä¿¡æ¯éƒ½æ˜¯é€šè¿‡ Intent è¿›è¡Œä¼ é€’çš„ï¼Œæ‰€ä»¥ç»§ç»­æŸ¥çœ‹ getHomeIntent çœ‹çœ‹ Intent åŒ…å«çš„ä¿¡æ¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Intent <span class="title">getHomeIntent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//mTopAction æ˜¯ android.intent.action.MAIN</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(mTopAction, mTopData != <span class="keyword">null</span> ? Uri.parse(mTopData) : <span class="keyword">null</span>);</span><br><span class="line">    intent.setComponent(mTopComponent);</span><br><span class="line">    intent.addFlags(Intent.FLAG_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) &#123;</span><br><span class="line">        intent.addCategory(Intent.CATEGORY_HOME);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ getHomeIntent ä¸­é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª Intent å¯¹è±¡ï¼Œç„¶åç»™è¿™ä¸ªå¯¹è±¡å¢åŠ äº†ä¸€ä¸ª categoryï¼Œcategory å¯¹åº”çš„ä¿¡æ¯æ˜¯ android.intent.category.HOMEï¼ŒæŸ¥æ‰¾ Lanucher3 çš„ AndroidManifest.xml å¯ä»¥çœ‹è§</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">"com.android.launcher3.Launcher"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:clearTaskOnLaunch</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:stateNotNeeded</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">"@style/Theme"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">"adjustPan"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">"nosensor"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:configChanges</span>=<span class="string">"keyboard|keyboardHidden|navigation"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:resumeWhilePausing</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:taskAffinity</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.HOME"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.MONKEY"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™è¯´æ˜å³å°†å¯åŠ¨çš„ Activity æ˜¯ com.android.launcher3.Launcherï¼Œç°åœ¨å›åˆ° startHomeActivityLocked æ–¹æ³•ä¸­ï¼Œç»§ç»­å¾€ä¸‹çœ‹å¯ä»¥çŸ¥é“åœ¨å¾—åˆ° Intent å¯¹è±¡ä¹‹åï¼Œæœ€åæ˜¯é€šè¿‡ ActivityStarter çš„ startHomeActivityLocked å¯åŠ¨äº† Launcherã€‚ä¹‹åçš„éƒ¨åˆ†ç”±äºæ¶‰åŠåˆ° Lanucher æºç å’Œ Activity å¯åŠ¨çš„ç»†è‡´æµç¨‹ï¼Œæ‰€ä»¥å°±æš‚æ—¶ä¸åšåˆ†æäº†ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>é€šè¿‡å››ç¯‡æ–‡ç« çš„åˆ†æå¯¹ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹æœ‰äº†ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œä½†æ˜¯é™äºæ°´å¹³æœ‰é™ï¼Œæœ‰äº›éƒ¨åˆ†åˆ†æçš„æ¯”è¾ƒç²—ç³™ï¼Œå¸Œæœ›ä¹‹ååœ¨æ°´å¹³æå‡ä¹‹åèƒ½å¤Ÿå¯¹å„ä¸ªéƒ¨åˆ†è¿›è¡Œè¿›ä¸€æ­¥çš„å®Œå–„ï¼Œä¾‹å¦‚ï¼šBinderã€ActivityManagerServiceã€Acitvity çš„å¯åŠ¨è¿‡ç¨‹ç­‰ç­‰ã€‚ æœ€åå€Ÿç”¨ Gityuan <a href="http://gityuan.com/android/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¼€ç¯‡</a>ä¸­çš„ä¸€å¼ å›¾ç‰‡è¯´æ˜ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/Android-start.png"></p><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="http://blog.csdn.net/itachi85/article/details/56669808" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼ˆå››ï¼‰Launcherå¯åŠ¨è¿‡ç¨‹ä¸ç³»ç»Ÿå¯åŠ¨æµç¨‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;é€šè¿‡&lt;a href=&quot;/2018/01/22/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰/&quot; title=&quot;Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰&quot;&gt;Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰&lt;/a&gt;è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å·²ç»å¤§è‡´äº†è§£äº†æœåŠ¡æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Œæ¥ç€æœ¬æ–‡å°†ä¼šåˆ†æç³»ç»Ÿå¯åŠ¨çš„æœ€åä¸€æ­¥ï¼Œå³ Launcher çš„å¯åŠ¨ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Androidè¿›é˜¶" scheme="http://www.ikroal.xyz/categories/Android%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="æºç åˆ†æ" scheme="http://www.ikroal.xyz/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ç™½è¯æ·±åº¦å­¦ä¹ -åŸºç¡€ç¯‡</title>
    <link href="http://www.ikroal.xyz/2018/01/28/%E7%99%BD%E8%AF%9D%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
    <id>http://www.ikroal.xyz/2018/01/28/ç™½è¯æ·±åº¦å­¦ä¹ ä¹‹åŸºç¡€ç¯‡/</id>
    <published>2018-01-28T04:06:04.000Z</published>
    <updated>2019-05-13T08:15:08.074Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ”¶è·">æ”¶è·</h2><p>ã€Œç™½è¯æ·±åº¦å­¦ä¹ ä¸TensorFlowã€çš„åŸºç¡€ç¯‡ä¸»è¦å†…å®¹ä¸ºâ€œæœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆâ€ã€â€œæ·±åº¦å­¦ä¹ æ˜¯ä»€ä¹ˆâ€ä»¥åŠâ€œTensorFlowâ€æ¡†æ¶ç‰¹æ€§ä¸å®‰è£…ï¼Œé€šè¿‡é˜…è¯»åŸºç¡€ç¯‡çš„å†…å®¹å¤§è‡´äº†è§£äº†ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>æœºå™¨å­¦ä¹ ä¸æ·±åº¦å­¦ä¹ çš„æ¦‚å¿µ</li><li>æœºå™¨å­¦ä¹ ä¸æ·±åº¦å­¦ä¹ çš„åŒºåˆ«</li><li>æœºå™¨å­¦ä¹ çš„å¸¸ç”¨æ–¹æ³•</li><li>å®‰è£…TensorFlowæ¡†æ¶</li></ul><a id="more"></a><h2 id="ç¬¬ä¸€ç« ">ç¬¬ä¸€ç« </h2><h3 id="æœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆ">æœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆ</h3><p>æœºå™¨å­¦ä¹ æ˜¯äººç±»å®šä¹‰ä¸€å®šçš„è®¡ç®—æœºç®—æ³•ï¼Œè®©è®¡ç®—æœºæ ¹æ®è¾“å…¥çš„æ ·æœ¬å’Œä¸€äº›äººç±»çš„å¹²é¢„æ¥æ€»ç»“å¹¶å½’çº³å…¶ç‰¹å¾å’Œç‰¹ç‚¹ï¼Œå¹¶ç”¨è¿™äº›ç‰¹å¾å’Œç‰¹ç‚¹ä¸ä¸€å®šçš„å­¦ä¹ ç›®æ ‡å½¢æˆæ˜ å°„å…³ç³»ï¼Œè¿›è€Œè‡ªåŠ¨åŒ–åœ°åšå‡ºç›¸åº”ååº”çš„è¿‡ç¨‹ã€‚</p><h3 id="æœºå™¨å­¦ä¹ çš„ç›®çš„">æœºå™¨å­¦ä¹ çš„ç›®çš„</h3><p>äººç±»å­¦ä¹ çš„ç›®çš„æ˜¯æŒæ¡çŸ¥è¯†ã€æŒæ¡èƒ½åŠ›ã€æŒæ¡æŠ€å·§ç„¶åæœ€ç»ˆèƒ½å¤Ÿè¿›è¡Œæ¯”è¾ƒå¤æ‚çš„æˆ–è€…é«˜è¦æ±‚çš„å·¥ä½œã€‚ç›¸ä¼¼çš„æœºå™¨å­¦ä¹ çš„æœ€ç»ˆç›®çš„åœ¨äºè®©è®¡ç®—æœºèƒ½å¤Ÿç‹¬ç«‹æˆ–è€…åŠç‹¬ç«‹çš„è¿›è¡Œç›¸å¯¹å¤æ‚æˆ–è€…é«˜è¦æ±‚çš„å·¥ä½œã€‚</p><blockquote><p>æœºå™¨å­¦ä¹ ä¸éæœºå™¨å­¦ä¹ çš„åŒºåˆ«åœ¨äºè¿‡å»çš„è®¡ç®—æœºåœ¨ç¨‹åºç»™å®šçš„æƒ…å†µä¸‹ï¼Œå…¶è¡Œä¸ºé€»è¾‘å°±å·²ç»ç¡®å®šäº†ï¼Œè€Œæœºå™¨å­¦ä¹ åˆ™éœ€è¦é€šè¿‡æ ·æœ¬è¿›è¡Œç»Ÿè®¡å½’çº³ç„¶åæ‰ä¼šç¡®å®šå…¶è¡Œä¸ºé€»è¾‘ã€‚æ‰€ä»¥é€šè¿‡æœºå™¨å­¦ä¹ å¯ä»¥è¿›è¡Œç›¸ç‰‡è¯†åˆ«ä¿¡æ¯ã€æ–°é—»çš„è‡ªåŠ¨åˆ†ç±»ç­‰å·¥ä½œã€‚å› ä¸ºè®¡ç®—æœºäº‹å…ˆæ˜¯ä¸ä¼šçŸ¥é“éœ€è¦æå–çš„ä¿¡æ¯åœ¨ç»™å®šçš„ç›¸ç‰‡ä¸­æ‰€å…·å¤‡çš„ç‰¹å¾ï¼Œåªæœ‰é€šè¿‡æœºå™¨å­¦ä¹ ä¸æ–­çš„ç»Ÿè®¡å½’çº³æ‰èƒ½å¾—å‡ºé€‚åˆè¯†åˆ«å¤§å¤šæ•°ç›¸ç‰‡ä¸­æ‰€éœ€æå–çš„ä¿¡æ¯çš„æ¨¡å‹ã€‚</p></blockquote><h3 id="æœºå™¨å­¦ä¹ çš„åˆ†ç±»">æœºå™¨å­¦ä¹ çš„åˆ†ç±»</h3><p>ä»å­¦ä¹ çš„ç§ç±»æ¥è¯´ï¼Œæœºå™¨å­¦ä¹ ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼šæœ‰ç›‘ç£å­¦ä¹ å’Œæ— ç›‘ç£å­¦ä¹ <br>æœ‰ç›‘ç£å­¦ä¹ æ˜¯æŒ‡å…ˆå¯¹ç»™äºˆçš„æ ·æœ¬è¿›è¡Œæ€»ç»“å¾—å‡ºåˆ†ç±»è§„åˆ™ï¼Œä¹‹åæ ¹æ®è¿™ä¸ªè§„åˆ™è¿›è¡Œåˆ†ç±»æ“ä½œï¼Œå¯¹äºæœ‰ç›‘ç£å­¦ä¹ è€Œè¨€åŸºæœ¬åˆ†ä¸ºä¸‰ä¸ªè¿‡ç¨‹ï¼š</p><ul><li>è®­ç»ƒ è®­ç»ƒçš„è¿‡ç¨‹ä¸»è¦æ˜¯æ‹¿ä¸€å®šå…·æœ‰æ ‡ç­¾çš„æ ·æœ¬è¿›è¡Œç»Ÿè®¡å’Œå½’çº³æ€»ç»“å‡ºä¸€ä¸ªæ¨¡å‹</li><li>éªŒè¯ éªŒè¯çš„è¿‡ç¨‹ä¸»è¦æ˜¯æ‹¿ä¸€äº›æœªåˆ†ç±»çš„æ ·æœ¬å¯¹è¿™ä¸ªæ¨¡å‹è¿›è¡ŒéªŒè¯ï¼Œåˆ¤æ–­å…¶æ˜¯å¦å…·æœ‰æ³›åŒ–æ€§(generalization)ã€‚</li><li>æµ‹è¯• æµ‹è¯•åˆ™æ˜¯ç”¨<strong>ä¸€å®šé‡</strong>çš„æ ·æœ¬åˆ¤æ–­æ¨¡å‹çš„è¯†åˆ«èƒ½åŠ›</li></ul><p>æ— ç›‘ç£å­¦ä¹ åˆ™æ˜¯åœ¨è·å¾—è®­ç»ƒçš„å‘é‡æ•°æ®ååœ¨æ²¡æœ‰æ ‡ç­¾çš„æƒ…å†µä¸‹å°è¯•æ‰¾å‡ºå…¶å†…éƒ¨è•´å«å…³ç³»çš„ä¸€ç§æŒ–æ˜å·¥ä½œã€‚</p><blockquote><p>æœ‰ç›‘ç£å­¦ä¹ å’Œæ— ç›‘ç£å­¦ä¹ çš„åŒºåˆ«åœ¨äºå‰è€…çš„è¾“å…¥æ•°æ®å…·æœ‰æ ‡ç­¾ï¼Œè€Œåè€…çš„è¾“å…¥æ•°æ®æ²¡æœ‰æ ‡ç­¾</p></blockquote><h3 id="æœºå™¨å­¦ä¹ çš„å¸¸ç”¨æ–¹æ³•">æœºå™¨å­¦ä¹ çš„å¸¸ç”¨æ–¹æ³•</h3><h4 id="èšç±»">èšç±»</h4><p>èšç±»æ˜¯æŒ‡å°†ç‰©ç†å¯¹è±¡æˆ–æŠ½è±¡å¯¹è±¡çš„é›†åˆåˆ†ç»„ä¸ºç”±å½¼æ­¤ç±»ä¼¼çš„å¯¹è±¡ç»„æˆå¤šä¸ªç±»çš„åˆ†æè¿‡ç¨‹</p><blockquote><p>ç‰¹å¾å½¢æ€çš„ç›¸åŒæˆ–è¿‘ä¼¼çš„åˆ’åœ¨ä¸€ä¸ªæ¦‚å¿µä¸‹ï¼Œç‰¹å¾å½¢æ€ä¸åŒçš„åˆ’åœ¨ä¸åŒæ¦‚å¿µä¸‹</p></blockquote><p>èšç±»å¸¸ç”¨çš„ç®—æ³•æœ‰ K-Meansã€DBSCAN ç­‰å‡ ç§ï¼Œå…¶åŸºæœ¬æ€è·¯éƒ½æ˜¯<strong>åˆ©ç”¨æ¯ä¸ªå‘é‡ä¹‹é—´çš„è·ç¦»ï¼Œä»è¿œè¿‘åˆ¤æ–­æ˜¯å¦ä»å±äºåŒä¸€ç±»åˆ«ã€‚</strong></p><h4 id="å›å½’">å›å½’</h4><p>å›å½’æ˜¯ä¸€ä¸ªã€Œç”±æœç´¢å› ã€çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ç§å½’çº³çš„æ€æƒ³ï¼Œå½“æˆ‘ä»¬çœ‹åˆ°å¤§é‡çš„äº‹å®æ‰€å‘ˆç°çš„æ ·æ€å»æ¨æ–­åŸå› æˆ–å®¢è§‚è•´å«çš„å…³ç³»æ˜¯å¦‚ä½•çš„ã€‚ å›å½’çš„è®­ç»ƒè¿‡ç¨‹ä¸€èˆ¬å¦‚ä¸‹ï¼š</p><ul><li><p>æ ¹æ®è§‚å¯Ÿå’Œå½’çº³æ ·æœ¬ï¼ˆè®­ç»ƒé›†ï¼‰çš„ç»“æœæ¨æ–­å‘é‡å’Œæœ€ç»ˆçš„å‡½æ•°å€¼å‘ˆç°å¦‚ä¸‹æ˜ å°„å…³ç³» <span class="math display">\[y=f(x)=wx+b\]</span> è¿™é‡Œçš„ <span class="math inline">\(w\)</span> å’Œ <span class="math inline">\(x\)</span> åˆ†åˆ«æ˜¯ <span class="math inline">\(1*n\)</span> å’Œ <span class="math inline">\(n*1\)</span> çš„çŸ©é˜µï¼Œä¹Ÿå°±æ˜¯è¯´æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯æ±‚è§£ w å’Œ b</p></li><li><p>ä»£å…¥æ ·æœ¬å€¼ï¼ˆéªŒè¯é›†ï¼‰å¾—åˆ°è¯¯å·®å’Œ <span class="math inline">\(Loss\)</span> <span class="math display">\[Loss=\sum_{i=1}^n|wx_i+b-y_i|\]</span> è¿™é‡Œçš„ <span class="math inline">\(wx_i+b\)</span> æ˜¯æ ¹æ®ç¬¬ä¸€æ­¥æ¨æ–­å…³ç³»è®¡ç®—å‡ºçš„å€¼ï¼Œ<span class="math inline">\(y_i\)</span> æ˜¯å®é™…è§‚æµ‹åˆ°çš„å€¼ï¼Œå°†æ‰€æœ‰æµ‹è¯•çš„è¯¯å·®ç›¸åŠ ä¹‹åå³å¯å¾—åˆ°æ€»çš„è¯¯å·®ï¼Œ<span class="math inline">\(Loss\)</span> è¶Šå°åˆ™ä»£è¡¨æ˜ å°„å…³ç³»è¶Šç²¾ç¡®</p></li></ul><blockquote><p>è¿™é‡Œä»¥çº¿æ€§å›å½’ä¸ºä¾‹ï¼Œè‡³äºéçº¿æ€§å›å½’è¿‡ç¨‹æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯æ˜ å°„å…³ç³»å’Œ <span class="math inline">\(Loss\)</span> å‡½æ•°æœ‰äº›ä¸åŒã€‚</p></blockquote><h4 id="åˆ†ç±»">åˆ†ç±»</h4><p>åˆ†ç±»è¿™ä¸ªæ¦‚å¿µä¸€ç›´éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå…·ä½“åˆ°æœºå™¨å­¦ä¹ å½“ä¸­åˆ™æ˜¯åˆ©ç”¨æˆ‘ä»¬ç¼–å†™çš„åˆ†ç±»å™¨å¯¹æ ·æœ¬è¿›è¡Œåˆ†ç±»ï¼Œè€Œåˆ¤æ–­è¿™ç§åˆ†ç±»å™¨æ˜¯å¦åˆç†çš„åŸåˆ™åœ¨äº<code>å¬å›ç‡</code>å’Œ<code>ç²¾ç¡®ç‡</code>è¿™ä¸¤ä¸ªæŒ‡æ ‡</p><ul><li>å¬å›ç‡æ˜¯æ£€ç´¢å‡ºçš„ç›¸å…³æ ·æœ¬å’Œæ ·æœ¬åº“ä¸­æ‰€æœ‰çš„ç›¸å…³æ ·æœ¬çš„æ¯”ç‡ï¼Œè¡¡é‡çš„æ˜¯åˆ†ç±»å™¨çš„æŸ¥å…¨ç‡</li><li>ç²¾ç¡®ç‡æ˜¯æ£€ç´¢å‡ºçš„ç›¸å…³æ ·æœ¬æ•°ä¸æ£€ç´¢å‡ºæ ·æœ¬æ€»æ•°çš„æ¯”ç‡ï¼Œè¡¡é‡çš„æ˜¯åˆ†ç±»å™¨çš„æŸ¥å‡†ç‡</li></ul><p>åˆ†ç±»çš„è®­ç»ƒè¿‡ç¨‹å’Œå›å½’çš„è®­ç»ƒè¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼š</p><ol type="1"><li>è¾“å…¥æ ·æœ¬å’Œåˆ†ç±»æ ‡ç­¾</li><li>å»ºç«‹æ˜ å°„å‡è¯´çš„æŸä¸ª<span class="math inline">\(y=f(x)\)</span></li><li>æ±‚è§£å‡ºå…¨å±€çš„æŸå¤±å‡½æ•°<span class="math inline">\(Loss\)</span>å’Œå¾…å®šç³»æ•°<span class="math inline">\(w\)</span>çš„æ˜ å°„å…³ç³»ï¼Œ<span class="math inline">\(Loss=g(w)\)</span></li><li>é€šè¿‡è¿­ä»£ä¼˜åŒ–é€æ­¥é™ä½<span class="math inline">\(Loss\)</span>ï¼Œæœ€ç»ˆæ‰¾åˆ°ä¸€ä¸ª<span class="math inline">\(w\)</span>èƒ½ä½¿å¬å›ç‡å’Œç²¾ç¡®ç‡æ»¡è¶³å½“å‰åœºæ™¯éœ€è¦</li></ol><h2 id="ç¬¬äºŒç« ">ç¬¬äºŒç« </h2><h3 id="æ·±åº¦å­¦ä¹ æ˜¯ä»€ä¹ˆ">æ·±åº¦å­¦ä¹ æ˜¯ä»€ä¹ˆ</h3><p>æ·±åº¦å­¦ä¹ æ˜¯æŒ‡åŸºäºæ·±åº¦ç¥ç»ç½‘ç»œã€Œdeep neural networksã€çš„å­¦ä¹ ï¼Œä¹Ÿå°±æ˜¯æ·±åº¦äººå·¥ç¥ç»ç½‘ç»œæ‰€è¿›è¡Œçš„å­¦ä¹ è¿‡ç¨‹ã€‚</p><h3 id="æ·±åº¦ç¥ç»ç½‘ç»œçš„ç»„æˆ">æ·±åº¦ç¥ç»ç½‘ç»œçš„ç»„æˆ</h3><p>æ·±åº¦ç¥ç»ç½‘ç»œç”±å¤šä¸ªç¥ç»å…ƒç»„æˆï¼Œè€Œç¥ç»å…ƒæ˜¯äººç±»å—åˆ°ç”Ÿç‰©ç¥ç»ç»†èƒç»“æ„å¯å‘è€Œç ”ç©¶å‡ºçš„ä¸€ç§ç®—æ³•ä½“ç³»ï¼Œä¸€ä¸ªå®Œæ•´çš„ç¥ç»å…ƒç”±<code>çº¿æ€§æ¨¡å‹</code>å’Œ<code>æ¿€åŠ±å‡½æ•°</code>ä¸¤éƒ¨åˆ†é¦–å°¾ç›¸æ¥ç»„æˆã€‚åŸºæœ¬æ¨¡å‹å¦‚ä¸‹ï¼šå…¶ä¸­<span class="math inline">\(wx+b\)</span>æ˜¯çº¿æ€§æ¨¡å‹ï¼Œ<span class="math inline">\(\int\)</span>è¡¨ç¤ºæ¿€åŠ±å‡½æ•°</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/Neurons.png"></p><p>å¸¸è§çš„æ¿€åŠ±å‡½æ•°æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p><ol type="1"><li><p>Sigmoid å‡½æ•° <span class="math display">\[f(x)={1 \over 1+e^{-(wx+b)}}\]</span></p></li><li><p>Tanh å‡½æ•° <span class="math display">\[tanh(x)={e^x-e^{-x}\over e^x+e^{-x}}\]</span></p></li><li><p>ReLu å‡½æ•° <span class="math display">\[y=max(x,0)\]</span></p></li><li><p>Linear å‡½æ•° <span class="math display">\[f(x)=x\]</span></p></li></ol><p>å¯¹äºç¥ç»ç½‘ç»œè€Œè¨€ä¸»è¦åˆ†ä¸ºä¸‰å±‚ï¼šè¾“å…¥å±‚ (input layer)ã€éšè—å±‚ (hidden layer)ã€è¾“å‡ºå±‚ (output layer)</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/NeuralNetworks.png"></p><p>è¾“å…¥å±‚ç›´æ¥æ¥æ”¶è¾“å…¥çš„å‘é‡ï¼Œä¸å¯¹æ•°æ®è¿›è¡Œä»»ä½•å¤„ç† éšè—å±‚å¯ä»¥æœ‰ä¸€å±‚æˆ–è€…å¤šå±‚ è¾“å‡ºå±‚æ˜¯æœ€åä¸€å±‚ï¼Œç”¨äºè¾“å‡ºæ•´ä¸ªç½‘ç»œå¤„ç†çš„å€¼ï¼Œè¿™ä¸ªå€¼å¯èƒ½æ˜¯ä¸€ä¸ªåˆ†ç±»å‘é‡å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç±»ä¼¼çº¿æ€§å›å½’äº§ç”Ÿçš„è¿ç»­çš„å€¼</p><h3 id="æ·±åº¦å­¦ä¹ å’Œæœºå™¨å­¦ä¹ çš„åŒºåˆ«">æ·±åº¦å­¦ä¹ å’Œæœºå™¨å­¦ä¹ çš„åŒºåˆ«</h3><p>æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é›†ï¼Œå½“æ·±åº¦å­¦ä¹ å’Œä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ çš„åŒºåˆ«åœ¨äºï¼Œä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ é€šå¸¸æ˜¯éœ€è¦äººæå‰è¿›è¡Œç‰¹å¾æå–ï¼ŒæŠŠæå–è¿‡çš„ç‰¹å¾å‘é‡åŒ–åå†ä¸¢ç»™æ¨¡å‹å»è®­ç»ƒï¼Œè¿™é‡Œäººè¦åšç›¸å½“çš„å‰ç½®å·¥ä½œã€‚è€Œæ·±åº¦å­¦ä¹ é€šå¸¸å¯ä»¥é‡‡ç”¨ End-to-End çš„å­¦ä¹ æ–¹å¼ï¼Œè¾“å…¥çš„å†…å®¹åªéœ€è¦åšå¾ˆå°‘çš„ä¸€äº›å½’ä¸€åŒ– (normalization)ã€ç™½åŒ– (whitening) ç­‰å¤„ç†å°±å¯ä»¥ä¸¢ç»™æ¨¡å‹å»è®­ç»ƒï¼Œé€šå¸¸ä¸éœ€è¦äººåšç‰¹å¾æå–çš„å·¥ä½œã€‚</p><h2 id="ç¬¬ä¸‰ç« ">ç¬¬ä¸‰ç« </h2><h3 id="å®‰è£…-tensorflow-æ¡†æ¶">å®‰è£… TensorFlow æ¡†æ¶</h3><p>æœ¬æ¬¡å®‰è£…ç¯å¢ƒæ˜¯ macosã€Python3</p><ol type="1"><li><p>å®‰è£… Anaconda åœ¨ <a href="https://www.anaconda.com/download/#macos" target="_blank" rel="noopener">Anaconda å®˜ç½‘</a> ä¸‹è½½ Python3.6 ç‰ˆæœ¬ pkg æ–‡ä»¶è¿›è¡Œå®‰è£…</p></li><li><p>å»ºç«‹ TensorFlow è¿è¡Œç¯å¢ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda create -n tensorflow python=<span class="number">3.6</span></span><br><span class="line">source activate tensorflow</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£… TensorFlow</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install tensorflow</span><br></pre></td></tr></table></figure></li><li><p>æµ‹è¯• TensorFlow</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hello = tf.constant(<span class="string">'Hello,TensorFlow!'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sess = tf.Session()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(sess.run(hello))</span><br><span class="line"><span class="string">b'Hello,TensorFlow!'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = tf.constant(<span class="number">10</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b = tf.constant(<span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(sess.run(a + b))</span><br><span class="line"><span class="number">42</span></span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ”¶è·&quot;&gt;æ”¶è·&lt;/h2&gt;
&lt;p&gt;ã€Œç™½è¯æ·±åº¦å­¦ä¹ ä¸TensorFlowã€çš„åŸºç¡€ç¯‡ä¸»è¦å†…å®¹ä¸ºâ€œæœºå™¨å­¦ä¹ æ˜¯ä»€ä¹ˆâ€ã€â€œæ·±åº¦å­¦ä¹ æ˜¯ä»€ä¹ˆâ€ä»¥åŠâ€œTensorFlowâ€æ¡†æ¶ç‰¹æ€§ä¸å®‰è£…ï¼Œé€šè¿‡é˜…è¯»åŸºç¡€ç¯‡çš„å†…å®¹å¤§è‡´äº†è§£äº†ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœºå™¨å­¦ä¹ ä¸æ·±åº¦å­¦ä¹ çš„æ¦‚å¿µ&lt;/li&gt;
&lt;li&gt;æœºå™¨å­¦ä¹ ä¸æ·±åº¦å­¦ä¹ çš„åŒºåˆ«&lt;/li&gt;
&lt;li&gt;æœºå™¨å­¦ä¹ çš„å¸¸ç”¨æ–¹æ³•&lt;/li&gt;
&lt;li&gt;å®‰è£…TensorFlowæ¡†æ¶&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://www.ikroal.xyz/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="ç™½è¯æ·±åº¦å­¦ä¹ ä¸TensorFlow" scheme="http://www.ikroal.xyz/tags/%E7%99%BD%E8%AF%9D%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E4%B8%8ETensorFlow/"/>
    
  </entry>
  
  <entry>
    <title>Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰ä¹‹ SystemServer è¿›ç¨‹</title>
    <link href="http://www.ikroal.xyz/2018/01/22/Android%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E7%AE%80%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/"/>
    <id>http://www.ikroal.xyz/2018/01/22/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸‰ï¼‰/</id>
    <published>2018-01-22T15:34:45.000Z</published>
    <updated>2018-03-04T14:57:17.233Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨<a href="/2017/11/05/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰/" title="Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰">Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰</a>ä¸­å·²ç»å¤§è‡´åˆ†æäº† zygote è¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹å½“ä¸­æ‰€åšçš„ä¸»è¦å·¥ä½œï¼Œæœ¬ç¯‡å°†ç»§ç»­å¯¹ SystemServer çš„å¯åŠ¨è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚<a id="more"></a></p><h2 id="systemserver-å¯åŠ¨è¿‡ç¨‹">SystemServer å¯åŠ¨è¿‡ç¨‹</h2><p>ä¸Šæ–‡è¯´åˆ° SystemServer è¿›ç¨‹åœ¨ ZygoteInit.java ä¸­è¢«åˆ›å»ºï¼Œç„¶åä¾¿ä¼šåœ¨ SystemServer è¿›ç¨‹è°ƒç”¨ handleSystemServerProcess æ–¹æ³•å¤„ç† SystemServer è¿›ç¨‹çš„å‰©ä½™å·¥ä½œ frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ZygoteConnection.Arguments parsedArgs)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SystemServer è¿›ç¨‹ä¸éœ€è¦è¿›è¡ŒSocketé€šä¿¡ï¼Œæ‰€ä»¥å…³é—­</span></span><br><span class="line">    closeServerSocket();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®è¿›ç¨‹åä¸ºsystem_server</span></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è¿™é‡Œ parsedArgs.invokeWith ä¸º null</span></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ClassLoader cl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»º SystemServer çš„ç±»åŠ è½½å™¨å¯¹è±¡</span></span><br><span class="line">            cl = createSystemServerClassLoader(systemServerClasspath,</span><br><span class="line">                                               parsedArgs.targetSdkVersion);</span><br><span class="line">            </span><br><span class="line">            Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†å‰©ä½™å‚æ•°ä¼ é€’ç»™ SystemServer</span></span><br><span class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* should never reach here */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ handleSystemServerProcess æ–¹æ³•ä¸­é¦–å…ˆä¼šå…³é—­æ‰ Socket è¿æ¥ï¼Œç„¶åä¼šæ ¹æ®ä¼ é€’è¿‡æ¥çš„å‚æ•°è®¾ç½®è¿›ç¨‹åç§°ï¼Œåœ¨è®¾ç½®å®Œè¿›ç¨‹åç§°ä¹‹åï¼Œç”±äº parseArgs çš„æˆå‘˜ invokeWith ä¸º nullï¼Œæ‰€ä»¥ä¼šåˆ©ç”¨ systemServerClasspath åˆ›å»ºå¯¹åº”çš„ç±»åŠ è½½å™¨å¯¹è±¡ï¼Œæœ€åä¼šé€šè¿‡ RuntimeInit çš„ zygoteInit æ–¹æ³•å°†å‰©ä½™å‚æ•°ä¼ é€’ç»™ SystemServerã€‚</p><h3 id="runtimeinit-åˆ†æ">RuntimeInit åˆ†æ</h3><p>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</span><br><span class="line">    redirectLogStreams();</span><br><span class="line"></span><br><span class="line">    commonInit();</span><br><span class="line">    nativeZygoteInit();</span><br><span class="line">    applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>zygoteInit ä¸­ä¾æ¬¡è°ƒç”¨äº† nativeZygoteInit å’Œ applicationInitï¼Œå…¶ä¸­å‰è€…å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè€Œåè€…åˆ™ä¼šè°ƒç”¨äº† SystemServer ç±»çš„ main æ–¹æ³•ã€‚</p><h4 id="å¯åŠ¨çº¿ç¨‹æ± ">å¯åŠ¨çº¿ç¨‹æ± </h4><p>nativeZygoteInit å®é™…ä¸Šå¯¹åº”ç€ com_android_internal_os_RuntimeInit_nativeZygoteInit frameworks/base/core/jni/AndroidRuntime.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    &#123; <span class="string">"nativeFinishInit"</span>, <span class="string">"()V"</span>,</span><br><span class="line">        (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeFinishInit &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeZygoteInit"</span>, <span class="string">"()V"</span>,</span><br><span class="line">        (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeZygoteInit &#125;,</span><br><span class="line">    &#123; <span class="string">"nativeSetExitWithoutCleanup"</span>, <span class="string">"(Z)V"</span>,</span><br><span class="line">        (<span class="keyword">void</span>*) com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_com_android_internal_os_RuntimeInit</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jniRegisterNativeMethods(env, <span class="string">"com/android/internal/os/RuntimeInit"</span>,</span><br><span class="line">        gMethods, NELEM(gMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­æŸ¥çœ‹ com_android_internal_os_RuntimeInit_nativeZygoteInit å¯ä»¥çŸ¥é“æœ€ç»ˆè°ƒç”¨äº† gCurRuntime çš„ onZygoteInit æ–¹æ³•ï¼Œè€Œ gCurRuntime å®é™…ä¸Šæ˜¯ä¸€ä¸ª AndroidRuntime çš„æŒ‡é’ˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">com_android_internal_os_RuntimeInit_nativeZygoteInit</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCurRuntime-&gt;onZygoteInit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>onZygoteInit çš„å…·ä½“å®ç°åœ¨ AndroidRuntime çš„å­ç±» AppRuntime ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆé€šè¿‡ startThreadPool å¯åŠ¨äº†çº¿ç¨‹æ±  frameworks/base/cmds/app_process/app_main.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;ProcessState&gt; proc = ProcessState::self();</span><br><span class="line">    ALOGV(<span class="string">"App process: starting thread pool.\n"</span>);</span><br><span class="line">    proc-&gt;startThreadPool();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è°ƒç”¨-systemserver-çš„-main-æ–¹æ³•">è°ƒç”¨ SystemServer çš„ main æ–¹æ³•</h4><p>frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ® argv æ„å»º RuntimeInit.Argumentsï¼Œè¿™é‡Œçš„ argv[] å®é™…ä¸Šæ˜¯ â€œcom.android.server.SystemServerâ€</span></span><br><span class="line">    <span class="keyword">final</span> Arguments args;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        args = <span class="keyword">new</span> Arguments(argv);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        Slog.e(TAG, ex.getMessage());</span><br><span class="line">        <span class="comment">// let the process exit</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The end of of the RuntimeInit event (see #zygoteInit).</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining arguments are passed to the start class's static main</span></span><br><span class="line">    invokeStaticMain(args.startClass, args.startArgs, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ applicationInit æ–¹æ³•ä¸­ä¼šå¯¹ argv è¿›è¡Œè§£æåˆ›å»º RuntimeInit.Arguments å‚æ•°ï¼Œç„¶åä¼šè°ƒç”¨ invokeStaticMain</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–SystemServerçš„Classå¯¹è±¡</span></span><br><span class="line">        cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Missing class when invoking static main "</span> + className,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è·å– main æ–¹æ³•</span></span><br><span class="line">        m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Missing static main on "</span> + className, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Problem getting static main on "</span> + className, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æ–¹æ³•ä¿®é¥°ç¬¦ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯å…¥å£ main æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">int</span> modifiers = m.getModifiers();</span><br><span class="line">    <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Main method is not public and static on "</span> + className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This throw gets caught in ZygoteInit.main(), which responds</span></span><br><span class="line"><span class="comment">     * by invoking the exception's run() method. This arrangement</span></span><br><span class="line"><span class="comment">     * clears up all the stack frames that were required in setting</span></span><br><span class="line"><span class="comment">     * up the process.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ invokeStaticMain æ–¹æ³•ä¸­ä¼šé€šè¿‡æ–¹æ³•ç­¾åè·å–åˆ° SystemServer çš„ main æ–¹æ³•ï¼Œä¹‹åä¼šæŠ›å‡º MethodAndArgsCaller å¼‚å¸¸ï¼Œç„¶ååœ¨ ZygoteInit çš„ main æ–¹æ³•ä¸­è¿›è¡Œæ•è·ï¼Œæ•è·ä¹‹åä¼šæ‰§è¡Œ MethodAndArgsCaller çš„ run æ–¹æ³•ï¼Œè€Œåœ¨ run æ–¹æ³•ä¸­ä¼šå®Œæˆå¯¹ SystemServer çš„ main æ–¹æ³•çš„è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MethodAndArgsCaller çš„ run æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">        Throwable cause = ex.getCause();</span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (Error) cause;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ZygoteInit æ•è·å¼‚å¸¸</span></span><br><span class="line"><span class="comment">//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        caller.run();</span><br><span class="line">    &#125;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="systemserver-åˆ†æ">SystemServer åˆ†æ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SystemServer().run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SystemServer çš„ main æ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ª SystemServer å¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†å…¶ run æ–¹æ³•ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ run æ–¹æ³•éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//åˆ›å»º SystemServer ä¸»çº¿ç¨‹çš„ Looper</span></span><br><span class="line">        Looper.prepareMainLooper();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– mSystemContext</span></span><br><span class="line">        createSystemContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»º SystemServiceManager å¯¹è±¡</span></span><br><span class="line">        mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨æœåŠ¡</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"StartServices"</span>);</span><br><span class="line">        startBootstrapServices();</span><br><span class="line">        startCoreServices();</span><br><span class="line">        startOtherServices();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// For debug builds, log event loop stalls to dropbox for analysis.</span></span><br><span class="line">    <span class="keyword">if</span> (StrictMode.conditionallyEnableDebugLogging()) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Enabled StrictMode for system server main thread."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop forever.</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ run æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨ Looper.prepareMainLooper() åˆ›å»ºäº†å½“å‰ä¸»çº¿ç¨‹çš„ Looperï¼Œä¹‹åä¼šè°ƒç”¨ createSystemContext åˆå§‹åŒ– mSystemContext å®ä¾‹ï¼Œè¿™é‡Œçš„ mSystemContext æ˜¯ä¸€ä¸ª ContextImpl å®ä¾‹ï¼Œä¸»è¦ç”¨äºåˆå§‹åŒ–ä¸€äº› Serviceï¼Œæœ€ååˆ™æ˜¯å¯åŠ¨ç³»ç»Ÿå„é¡¹æœåŠ¡ã€‚</p><h4 id="å¯åŠ¨ç³»ç»ŸæœåŠ¡">å¯åŠ¨ç³»ç»ŸæœåŠ¡</h4><p>ä»å¯åŠ¨æœåŠ¡çš„è¿‡ç¨‹ä¸­çœ‹ï¼Œç³»ç»Ÿå°†æœåŠ¡åˆ†ä¸ºä¸‰ç±»ï¼š</p><ol type="1"><li><p>å¼•å¯¼æœåŠ¡----------startBootstrapServices()</p><p>Installerã€ActivityManagerServiceã€PackageManagerService ç­‰</p></li><li><p>æ ¸å¿ƒæœåŠ¡----------startCoreServices()</p><p>BatteryServiceã€UsageStatsServiceã€WebViewUpdateService</p></li><li><p>å…¶å®ƒæœåŠ¡----------startOtherServices()</p><p>AlarmManagerServiceã€VibratorService ç­‰</p></li></ol><p>è€Œå¯¹äºæœåŠ¡çš„å¯åŠ¨æ–¹å¼è€Œè¨€ä¹Ÿåˆ†ä¸ºä¸‰ç§ï¼ˆå¯åŠ¨æ–¹å¼ä¸æœåŠ¡ç±»åˆ«å¹¶ä¸å¯¹åº”ï¼‰ï¼š</p><ol type="1"><li><p>mSystemServiceManager.startService()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T extends SystemService&gt; <span class="function">T <span class="title">startService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> String name = serviceClass.getName();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//åˆ›å»ºServiceå®ä¾‹</span></span><br><span class="line">        <span class="keyword">final</span> T service;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class);</span><br><span class="line">            service = constructor.newInstance(mContext);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">            ....</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ å…¥ List&lt;SystemService&gt; å½“ä¸­</span></span><br><span class="line">        mServices.add(service);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å›è°ƒ Service çš„ onStart æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            service.onStart();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to start service "</span> + name</span><br><span class="line">                    + <span class="string">": onStart threw an exception"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º startService å¯åŠ¨çš„æœåŠ¡éƒ½æ˜¯ SystemService çš„å­ç±»ï¼Œå¯åŠ¨çš„è¿‡ç¨‹æ˜¯å…ˆå¯¹æœåŠ¡ç±»è¿›è¡ŒåŠ è½½ï¼ŒåŠ è½½ä¹‹åè¿›è¡Œå®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–ä¹‹ååˆ™ä¼šè°ƒç”¨å®ä¾‹çš„ onStart æ–¹æ³•ã€‚</p></li><li><p>xxxService.main()</p><p>è¿™ç§æ–¹å¼ä¸»è¦åœ¨å¯åŠ¨ä»¥ä¸‹ä¸‰ä¸ªæœåŠ¡ä¸­ç”¨åˆ°</p><ul><li><p>PackageManagerService</p></li><li>OtaDexoptService</li><li><p>WindowManagerService</p></li></ul><p>è¿™é‡Œä»¥ PackageManagerService ä¸ºä¾‹è¿›è¡Œåˆ†æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageManagerService <span class="title">main</span><span class="params">(Context context, Installer installer,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> factoryTest, <span class="keyword">boolean</span> onlyCore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Self-check for initial settings.</span></span><br><span class="line">    PackageManagerServiceCompilerMapping.checkProperties();</span><br><span class="line"></span><br><span class="line">    PackageManagerService m = <span class="keyword">new</span> PackageManagerService(context, installer,</span><br><span class="line">            factoryTest, onlyCore);</span><br><span class="line">    m.enableSystemUserPackages();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ³¨å†Œå¯åŠ¨æœåŠ¡</span></span><br><span class="line">    ServiceManager.addService(<span class="string">"package"</span>, m);</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ main æ–¹æ³•ä¸­ç›´æ¥åˆ›å»ºäº† PackageManagerService çš„å®ä¾‹ï¼Œç„¶åé€šè¿‡ ServiceManager è¿›è¡Œæ³¨å†Œå¯åŠ¨ã€‚</p></li><li><p>ServiceManager.addService()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceManager.addService(<span class="string">"scheduling_policy"</span>, <span class="keyword">new</span> SchedulingPolicyService());</span><br></pre></td></tr></table></figure><p>ServiceManager æ¶‰åŠåˆ° Binder æš‚ä¸åšåˆ†æ</p></li></ol><p>ä¸Šæ–‡ä¸­æåˆ°äº†æœåŠ¡çš„æ³¨å†Œï¼Œå¯¹äºæœåŠ¡çš„æ³¨å†Œè€Œè¨€å®é™…ä¸Šåˆ†ä¸ºä¸¤ç§ï¼šä¸€æ˜¯ ServiceManager.addServiceï¼ŒäºŒæ˜¯ LocalServices.addService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This class is used in a similar way as ServiceManager, except the services registered here</span></span><br><span class="line"><span class="comment"> * are not Binder objects and are only available in the same process.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Once all services are converted to the SystemService interface, this class can be absorbed</span></span><br><span class="line"><span class="comment"> * into SystemServiceManager.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@hide</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalServices</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LocalServices</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt; sLocalServiceObjects =</span><br><span class="line">            <span class="keyword">new</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Adds a service instance of the specified interface to the global registry of local services.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addService</span><span class="params">(Class&lt;T&gt; type, T service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sLocalServiceObjects) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sLocalServiceObjects.containsKey(type)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Overriding service registration"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sLocalServiceObjects.put(type, service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ LocalServices çš„ç±»æè¿°å¯ä»¥çŸ¥é“ LocalServices ä¸ ServiceManager ç”¨å¤„ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºServiceManager ç”¨äºä¸åŒè¿›ç¨‹é—´è·å– Serviceï¼Œè€Œ LocalServices åªèƒ½å¤Ÿç”¨äºåŒä¸€è¿›ç¨‹ä¸­è·å– Serviceã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>è‡³æ­¤å¤§æ¦‚å°±èƒ½çŸ¥é“åœ¨ SystemServer å¯åŠ¨è¿‡ç¨‹ä¸­ä¸»è¦åšäº†ä¸‰ä»¶äº‹</p><ol type="1"><li>å¼€å¯çº¿ç¨‹æ± </li><li>åˆ›å»º SystemServerManager å¯¹è±¡è´Ÿè´£ç»§æ‰¿è‡ª SystemService çš„æœåŠ¡çš„åˆ›å»ºã€å¯åŠ¨ä»¥åŠç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</li><li>å¯åŠ¨ç³»ç»Ÿçš„æœåŠ¡</li></ol><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="http://gityuan.com/2016/02/14/android-system-server/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-SystemServerä¸Šç¯‡</a></li><li><a href="http://gityuan.com/2016/02/20/android-system-server-2/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-SystemServerä¸‹ç¯‡</a></li><li><a href="http://gityuan.com/2016/10/01/system_service_common/" target="_blank" rel="noopener">Androidç³»ç»ŸæœåŠ¡çš„æ³¨å†Œæ–¹å¼</a></li><li><a href="http://blog.csdn.net/itachi85/article/details/56669808" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼ˆä¸‰ï¼‰è§£æSyetemServerè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;åœ¨&lt;a href=&quot;/2017/11/05/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰/&quot; title=&quot;Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰&quot;&gt;Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰&lt;/a&gt;ä¸­å·²ç»å¤§è‡´åˆ†æäº† zygote è¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹å½“ä¸­æ‰€åšçš„ä¸»è¦å·¥ä½œï¼Œæœ¬ç¯‡å°†ç»§ç»­å¯¹ SystemServer çš„å¯åŠ¨è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Androidè¿›é˜¶" scheme="http://www.ikroal.xyz/categories/Android%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="æºç åˆ†æ" scheme="http://www.ikroal.xyz/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>JavaåŸºç¡€ä¹‹æ³¨è§£</title>
    <link href="http://www.ikroal.xyz/2018/01/15/Java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%B3%A8%E8%A7%A3/"/>
    <id>http://www.ikroal.xyz/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/</id>
    <published>2018-01-15T14:07:15.000Z</published>
    <updated>2019-05-13T08:50:21.904Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2><p>å…³äºæ³¨è§£é¦–å…ˆè¯·æ€è€ƒä¸€ä¸‹ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>æ³¨è§£æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>æ³¨è§£çš„ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼Ÿ</li><li>æ³¨è§£å¯ä»¥åˆ†ä¸ºå“ªäº›ç±»å‹ï¼Ÿ</li><li>æ³¨è§£çš„å¤„ç†è¿‡ç¨‹ï¼Ÿ</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹è¿™å‡ ä¸ªé—®é¢˜è¿›è¡Œæ¢è®¨<a id="more"></a></p><h2 id="æ³¨è§£ç®€ä»‹">æ³¨è§£ç®€ä»‹</h2><blockquote><p><em>Annotations</em>, a form of metadata, provide data about a program that is not part of the program itself. Annotations have no direct effect on the operation of the code they annotate.</p></blockquote><p>ä¸Šè¿°æ˜¯å®˜æ–¹ç»™å‡ºçš„å…³äºæ³¨è§£çš„å®šä¹‰ï¼Œå¤§è‡´æ„æ€æ˜¯æ³¨è§£æ˜¯<strong>å…ƒæ•°æ®</strong>ï¼ˆMetaDataï¼‰çš„ä¸€ç§å½¢å¼ï¼Œå®ƒç”¨äºæä¾›ä¸€äº›å’Œç¨‹åºå…ƒç´ æœ‰å…³çš„å…ƒæ•°æ®ï¼Œè¿™äº›æ•°æ®æœ¬èº«ä¸å±äºç¨‹åºï¼Œå¹¶ä¸”ä¹Ÿä¸ä¼šç›´æ¥å½±å“ç¨‹åºçš„æ“ä½œã€‚ ä¸ºäº†æ›´ç›´è§‚çš„ç†è§£æ³¨è§£çš„æ¦‚å¿µï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›ä¸€æ­¥äº†è§£å…ƒæ•°æ®è¿™ä¸ªæ¦‚å¿µï¼Œå…³äºå…ƒæ•°æ® Wiki ä¸Šçš„æè¿°å¦‚ä¸‹ï¼š</p><blockquote><p><strong>Metadata</strong> is &quot;data [information] that provides information about other data&quot;ï¼ŒFor example, a digital image may include metadata that describes how large the picture is, the color depth, the image resolution, when the image was created, the shutter speed, and other data.</p></blockquote><p>å…ƒæ•°æ®æ˜¯æè¿°æ•°æ®çš„æ•°æ®ï¼Œå¯¹äºä¸€å¼ ç›¸ç‰‡è€Œè¨€å…ƒæ•°æ®åŒ…æ‹¬ç›¸ç‰‡çš„å¤§å°ã€è‰²å½©æ·±åº¦ã€å›¾ç‰‡çš„åˆ†è¾¨ç‡ã€å›¾ç‰‡å»ºç«‹æ—¶é—´ä»¥åŠå¿«é—¨é€Ÿåº¦ç­‰ç›¸å…³æ•°æ®ã€‚ ç»“åˆä¸¤è€…å¯ä»¥å¾—åˆ°ï¼š<strong>æ³¨è§£æ˜¯ä¸€ç§ç”¨äºæè¿°ç¨‹åºå…ƒç´ ä¿¡æ¯çš„ä¿®é¥°ç¬¦ï¼Œå¯ä»¥ç”¨æ¥ä¿®é¥°åŒ…ã€ç±»ã€æ„é€ å™¨ã€æ–¹æ³•ã€æˆå‘˜å˜é‡ã€å‚æ•°ã€å±€éƒ¨å˜é‡ã€‚</strong> è¿™é‡Œå†ç»“åˆå…·ä½“çš„åœºæ™¯è¿›è¡Œç†è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindView</span>(R.id.toolbar)</span><br><span class="line"><span class="keyword">public</span> Toolbar mToolbar;</span><br></pre></td></tr></table></figure><p>å¯¹äºæˆå‘˜å˜é‡ mToolbar è€Œè¨€ï¼Œå…¶åŸºæœ¬çš„ä¿¡æ¯åŒ…å« widthã€heigthã€idï¼Œé€šè¿‡æ³¨è§£æˆ‘ä»¬èƒ½å¤Ÿå¾ˆæ˜ç¡®çš„æè¿°å®ƒçš„ id ä¿¡æ¯ã€‚</p><h2 id="æ³¨è§£çš„ä¸»è¦ä½¿ç”¨åœºæ™¯">æ³¨è§£çš„ä¸»è¦ä½¿ç”¨åœºæ™¯</h2><p>è¦æ˜ç™½æ³¨è§£çš„ä½¿ç”¨åœºæ™¯ï¼Œé¦–å…ˆéœ€è¦äº†è§£çš„æ˜¯æ³¨è§£çš„ä¸»è¦ä½œç”¨ï¼š</p><blockquote><ul><li><p><strong>Information for the compiler</strong>â€” Annotations can be used by the compiler to detect errors or suppress warnings.</p></li><li><p><strong>Compile-time and deployment-time processing</strong>â€” Software tools can process annotation information to generate code, XML files, and so forth.</p></li><li><p><strong>Runtime processing</strong>â€” Some annotations are available to be examined at runtime.</p></li></ul></blockquote><p>æ¥ä¸‹æ¥ä¸¾å‡ ä¸ªå¸¸è§çš„ä¾‹å­è¯´æ˜ï¼š</p><ol type="1"><li><p>ä¸ºç¼–è¯‘å™¨æä¾›ä¿¡æ¯ç”¨äºæ£€æµ‹é”™è¯¯æˆ–è€…æŠ‘åˆ¶è­¦å‘Š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addItems</span><span class="params">(@NonNull String item)</span> </span>&#123;</span><br><span class="line">  List list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">  list.add(item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¯‘æ—¶å’Œéƒ¨ç½²æ—¶é€šè¿‡å¯¹æ³¨è§£è¿›è¡Œå¤„ç†ç”Ÿæˆä»£ç ã€XML æ–‡ä»¶ç­‰</p><p>æ¯”è¾ƒå¸¸è§çš„å¦‚<a href="https://github.com/JakeWharton/butterknife" target="_blank" rel="noopener">butterknife</a>ï¼Œbutterknife èƒ½å¤Ÿé€šè¿‡æ³¨è§£è‡ªåŠ¨ç”Ÿæˆ findViewById çš„ä»£ç ï¼Œ<strong>æœ‰åŠ©äºå‡è½»æ ·æ¿ä»£ç çš„è´Ÿæ‹…</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindView</span>(R.id.toolbar)</span><br><span class="line"><span class="keyword">public</span> Toolbar mToolbar;</span><br></pre></td></tr></table></figure></li><li><p>è¿è¡Œæ—¶é€šè¿‡æ³¨è§£è¿›è¡Œæ£€æŸ¥å¤„ç†</p><p>åœ¨è¿è¡Œæ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æœºåˆ¶å¯¹æ³¨è§£æä¾›çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œç„¶åå®ç°éœ€è¦çš„åŠŸèƒ½ã€‚</p></li></ol><p>åœ¨æ˜ç¡®äº†æ³¨è§£çš„ä¸»è¦ä½œç”¨ä¹‹åï¼Œæ³¨è§£çš„ä½¿ç”¨åœºæ™¯å°±å·²ç»å‘¼ä¹‹æ¬²å‡ºäº†ï¼Œ<strong>å½“æˆ‘ä»¬éœ€è¦ä¸ºç¨‹åºä¸­çš„å…ƒç´ æä¾›ä¿¡æ¯ï¼Œå¹¶ä¸”è¿™äº›ä¿¡æ¯éœ€è¦å¾—åˆ°å¤„ç†çš„æ—¶å€™ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨æ³¨è§£ã€‚</strong></p><h2 id="æ³¨è§£çš„åˆ†ç±»">æ³¨è§£çš„åˆ†ç±»</h2><h3 id="åŸºæœ¬æ³¨è§£">åŸºæœ¬æ³¨è§£</h3><p>Java æä¾›äº† 5 ä¸ªåŸºæœ¬çš„ Annotation</p><table><thead><tr class="header"><th style="text-align: left;">æ³¨è§£å</th><th style="text-align: left;">ä½œç”¨</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"><span class="citation" data-cites="Override">@Override</span></td><td style="text-align: left;">é™å®šé‡å†™çˆ¶ç±»æ–¹æ³•</td></tr><tr class="even"><td style="text-align: left;"><span class="citation" data-cites="Deprecated">@Deprecated</span></td><td style="text-align: left;">è¡¨ç¤ºæŸä¸ªç¨‹åºå…ƒç´ å·²ç»è¿‡æ—¶</td></tr><tr class="odd"><td style="text-align: left;"><span class="citation" data-cites="SuppressWarnings">@SuppressWarnings</span></td><td style="text-align: left;">æŠ‘åˆ¶ç¼–è¯‘å™¨çš„è­¦å‘Š</td></tr><tr class="even"><td style="text-align: left;"><span class="citation" data-cites="SafeVarargs">@SafeVarargs</span></td><td style="text-align: left;">æŠ‘åˆ¶å †æ±¡æŸ“è­¦å‘Š</td></tr><tr class="odd"><td style="text-align: left;"><span class="citation" data-cites="FunctionalInterface">@FunctionalInterface</span></td><td style="text-align: left;">æŒ‡å®šæŸä¸ªæ¥å£å¿…é¡»æ˜¯å‡½æ•°å¼æ¥å£</td></tr></tbody></table><p>æ¥ä¸‹æ¥èŠèŠå®ƒä»¬çš„ä½¿ç”¨</p><ol type="1"><li><p>Override</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FatherClass</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">overridedMethod</span><span class="params">()</span> </span>&#123; </span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseAnnotationUse</span> <span class="keyword">extends</span> <span class="title">FatherClass</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">overridedMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.overridedMethod();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>Overrideçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š<ol type="1"><li><p>å¸®åŠ©æ£€æŸ¥æ˜¯å¦æ­£ç¡®çš„å¤å†™äº†çˆ¶ç±»ä¸­çš„å·²æœ‰æ–¹æ³•ï¼ˆå¦‚æœä¸å°å¿ƒæ‹¼å†™é”™è¯¯æˆ–è€…æ–¹æ³•ç­¾åå¯¹ä¸ä¸Šè¢«è¦†ç›–çš„æ–¹æ³•ï¼Œç¼–è¾‘å™¨éƒ½ä¼šå‘å‡ºè­¦å‘Šä¿¡æ¯ï¼‰</p></li><li><p>è¡¨ç¤ºå½“å‰æ–¹æ³•å®šä¹‰å°†è¦†ç›–è¶…ç±»çš„æ–¹æ³•ã€‚</p><p>å¦‚æœæ²¡æœ‰æ­£ç¡®çš„å¤å†™çˆ¶ç±»ä¸­çš„æ–¹æ³•åˆ™ä¼šæç¤º <strong>Method does not override method from its superclass</strong>ã€‚</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/Override-error.jpg"></p><p><img src="https://ws1.sinaimg.cn/large/006tNc79gy1fnhpc8zywyj30el00qglf.jpg"></p></li></ol></li><li><p>Deprecated åœ¨ FatherClass å¢åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deprecatedMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ BaseAnnotationUse ä¸­å¢åŠ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useDeprecatedMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> deprecatedMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™å°†ä¼šçœ‹åˆ° deprecatedMethod() æ˜¾ç¤ºçº¢è‰²ï¼Œå¹¶ä¸”ç¼–è¾‘å™¨æç¤º<strong>deprecatedMethod() å·²ç»è¿‡æ—¶äº†</strong></p></li></ol><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/deprecated-error.jpg"></p><ol start="3" type="1"><li><p>SuppressWarning å¯¹ BaseAnnotationUse ä¸­çš„ useDeprecatedMethod æ–¹æ³•è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">useDeprecatedMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line"> deprecatedMethod();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡å¢åŠ  SuppressWarning æŠ‘åˆ¶äº† Deprecated çš„è­¦å‘Šï¼ŒdeprecatedMethod() çš„çº¢è‰²å°†ä¼šæ¶ˆå¤±</p></li></ol><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/suppressWarning.jpg"></p><ol start="4" type="1"><li><p>SafeVarargs</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SafeVarargs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">faultyMethod</span><span class="params">(List&lt;String&gt;... listStrArray)</span> </span>&#123;</span><br><span class="line">List[] listArray = listStrArray;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æŠŠä¸€ä¸ªä¸å¸¦æ³›å‹çš„å¯¹è±¡èµ‹ç»™ä¸€ä¸ªå¸¦æ³›å‹çš„å˜é‡çš„æ—¶å€™ï¼Œå¾€å¾€å°†ä¼šå¯¼è‡´â€å †æ±¡æŸ“â€œï¼Œæ‰€ä»¥åœ¨ Java 7 ä¸­å¢åŠ äº† SafeVarargs ç”¨äºæŠ‘åˆ¶å †æ±¡æŸ“çš„è­¦å‘Šï¼ŒSafeVarargs åªèƒ½ç”¨åœ¨å‚æ•°é•¿åº¦å¯å˜çš„æ–¹æ³•æˆ–æ„é€ æ–¹æ³•ä¸Šï¼Œä¸”æ–¹æ³•å¿…é¡»å£°æ˜ä¸ºstaticæˆ–finalï¼Œå¦åˆ™ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/SafeVarargs.jpg"></p><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fnhpc97402j30ns00wglh.jpg"></p></li><li><p>FunctionalInterface</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BaseInterface</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FunctionalInterface æ˜¯ Java 8 ä¸“é—¨ä¸º Lambda è¡¨è¾¾å¼æ–°å¢çš„ï¼Œé€šè¿‡ FunctionalInterface å¯ä»¥é™åˆ¶æ¥å£ä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå¦‚æœåœ¨ BaseInterface æ¥å£ä¸­æ–°å¢æŠ½è±¡æ–¹æ³•ï¼Œç¼–è¯‘æ—¶å°†ä¼šæç¤º BaseInterface ä¸æ˜¯å‡½æ•°å¼æ¥å£ã€‚</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/FunctionalInterface.jpg"></p><p><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fnhpc8exc7j30od01vgll.jpg"></p></li></ol><h3 id="å…ƒæ³¨è§£">å…ƒæ³¨è§£</h3><p>JDK åœ¨ java.lang.annotation ä¸­å†…ç½®äº† 6 ç§å…ƒæ³¨è§£ï¼Œé™¤äº† Native ä¹‹å¤–éƒ½ç”¨äºä¿®é¥°å…¶å®ƒçš„ Annotation å®šä¹‰</p><table><thead><tr class="header"><th style="text-align: left;">æ³¨è§£å</th><th style="text-align: left;">ä½œç”¨</th></tr></thead><tbody><tr class="odd"><td style="text-align: left;"><span class="citation" data-cites="Retention">@Retention</span></td><td style="text-align: left;">æŒ‡å®šè¢«ä¿®é¥°çš„æ³¨è§£çš„ä¿ç•™æ—¶é—´</td></tr><tr class="even"><td style="text-align: left;"><span class="citation" data-cites="Target">@Target</span></td><td style="text-align: left;">æŒ‡å®šè¢«ä¿®é¥°çš„æ³¨è§£å¯ä»¥ä¿®é¥°çš„ç¨‹åºå…ƒç´ </td></tr><tr class="odd"><td style="text-align: left;"><span class="citation" data-cites="Documented">@Documented</span></td><td style="text-align: left;">æŒ‡å®šè¢«ä¿®é¥°çš„æ³¨è§£å¯ä»¥è¢« javadoc æå–æˆæ–‡æ¡£</td></tr><tr class="even"><td style="text-align: left;"><span class="citation" data-cites="Inherited">@Inherited</span></td><td style="text-align: left;">æŒ‡å®šè¢«ä¿®é¥°çš„æ³¨è§£å…·æœ‰ç»§æ‰¿æ€§ï¼Œå¦‚æœæŸä¸ªç±»ä½¿ç”¨äº†è¢« <span class="citation" data-cites="Inherited">@Inherited</span> ä¿®é¥°çš„æ³¨è§£ï¼Œé‚£ä¹ˆå…¶å­ç±»å°†è‡ªåŠ¨è¢«è¯¥æ³¨è§£ä¿®é¥°</td></tr><tr class="odd"><td style="text-align: left;"><span class="citation" data-cites="Repeatable">@Repeatable</span></td><td style="text-align: left;">ç”¨äºå®šä¹‰é‡å¤æ³¨è§£</td></tr><tr class="even"><td style="text-align: left;"><span class="citation" data-cites="Native">@Native</span></td><td style="text-align: left;">è¡¨ç¤ºå®šä¹‰å¸¸é‡å€¼çš„å­—æ®µå¯ä»¥ä»æœ¬åœ°ä»£ç å¼•ç”¨ã€‚</td></tr></tbody></table><p>æ¥ä¸‹æ¥ä¸»è¦ä»‹ç»å‰äº”ç§ï¼Œ<span class="citation" data-cites="Native">@Native</span> å®åœ¨æ˜¯ä¸å¸¸ç”¨</p><ol type="1"><li><p>Retention</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.ANNOTATION_TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Returns the retention policy.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> the retention policy</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function">RetentionPolicy <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Retentionçš„å®šä¹‰å¦‚ä¸Šï¼Œå…¶æ‹¥æœ‰ä¸€ä¸ª RetentionPolicy ç±»å‹çš„æˆå‘˜å˜é‡ï¼ŒRetentionPolicy æ˜¯æšä¸¾ç±»ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªæšä¸¾å€¼ï¼š</p><ul><li>RetentionPolicy.SOURCE æ³¨è§£åªèƒ½ä¿ç•™åœ¨æºæ–‡ä»¶å½“ä¸­ï¼Œç¼–è¯‘å™¨ä¸ä¼šç¼–è¯‘è¿™ç§æ³¨è§£</li><li>RetentionPolicy.CLASS æ³¨è§£èƒ½å¤Ÿä¿ç•™åœ¨ class æ–‡ä»¶å½“ä¸­ï¼Œä½†æ˜¯å½“ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼ŒJVM ä¸èƒ½å¤Ÿè·å–åˆ°æ³¨è§£ä¿¡æ¯</li><li>RetentionPolicy.RUNTIME æ³¨è§£èƒ½å¤Ÿä¿ç•™åœ¨ class æ–‡ä»¶å½“ä¸­ï¼Œç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼ŒJVM ä¹Ÿèƒ½å¤Ÿè·å–åˆ°æ³¨è§£ä¿¡æ¯ï¼Œç¨‹åºèƒ½å¤Ÿé€šè¿‡åå°„å»è·å–åˆ° Annotation ä¿¡æ¯</li></ul></li><li><p>Target</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.ANNOTATION_TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Returns an array of the kinds of elements an annotation type</span></span><br><span class="line"><span class="comment">  * can be applied to.</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> an array of the kinds of elements an annotation type</span></span><br><span class="line"><span class="comment">  * can be applied to</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ElementType ä¹Ÿæ˜¯ä¸€ä¸ªæšä¸¾ç±»ï¼Œå…¶æšä¸¾å€¼å’Œæ„ä¹‰æ˜¯ï¼š</p><ul><li>ElementType.TYPE è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°ç±»ã€æ¥å£æˆ–è€…æšä¸¾å®šä¹‰</li><li>ElementType.FIELD è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°æˆå‘˜å˜é‡</li><li>ElementType.METHOD è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°æ–¹æ³•å®šä¹‰</li><li>ElementType.PARAMETER è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°å‚æ•°</li><li>ElementType.CONSTRUCTOR è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°æ„é€ å‡½æ•°</li><li>ElementType.LOCAL_VARIABLE è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°å±€éƒ¨å˜é‡</li><li>ElementType.ANNOTATION_TYPE è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°æ³¨è§£</li><li>ElementType.PACKAGE è¡¨æ˜æ³¨è§£å¯ä»¥ä¿®é¥°åŒ…å®šä¹‰</li><li>ElementType.TYPE_PARAMETER è¡¨æ˜æ³¨è§£åªèƒ½å®šä¹‰ç¨‹åºå…ƒç´ çš„ä¿®é¥°</li><li>ElementType.TYPE_USE è¡¨æ˜æ³¨è§£ä¸ä»…å¯ä»¥åœ¨å®šä¹‰ç¨‹åºå…ƒç´ çš„æ—¶å€™ä½¿ç”¨ï¼Œè¿˜å¯ä»¥åœ¨<strong>åˆ›å»ºå¯¹è±¡ã€ç±»å‹è½¬æ¢ã€ä½¿ç”¨ implements å®ç°æ¥å£ã€ä½¿ç”¨ throws å£°æ˜æŠ›å‡ºå¼‚å¸¸</strong>çš„æ—¶å€™ä½¿ç”¨</li></ul></li><li><p>Documented å¯¹äºä½¿ç”¨è¢« <span class="citation" data-cites="Documented">@Documented</span> ä¿®é¥°çš„æ³¨è§£å’Œä¸å¸¦ <span class="citation" data-cites="Documented">@Documented</span> ä¿®é¥°çš„æ³¨è§£ï¼Œå…¶åŒºåˆ«å¦‚ä¸‹ï¼š</p></li></ol><figure><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/Documented.jpg" alt="annotation_1"><figcaption>annotation_1</figcaption></figure><figure><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/noDocumented.jpg" alt="annotation_2"><figcaption>annotation_2</figcaption></figure><ol start="4" type="1"><li><p>Inherited</p><p>Inherited çš„ç»§æ‰¿ä½œç”¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¾‹å­æ¥ä½“ç°ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ª Interitable æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inheritable &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºä¸€ä¸ªç”± Inheritable ä¿®é¥°çš„ Base ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inheritable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ååˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª Base ç±»çš„ InheritableTest ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InheritableTest</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è¢« Inheritable æ³¨è§£</span></span><br><span class="line">    System.out.println(InheritableTest.class.isAnnotationPresent(Inheritable.class));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œä¹‹åå¯ä»¥å‘ç°ç»“æœä¸º true</p></li><li><p>Repeatable</p><p>Repeatable æ˜¯ Java8 æ–°å¢çš„æ³¨è§£ï¼Œç”¨äºå®šä¹‰é‡å¤æ³¨è§£ï¼Œåœ¨ Java8 ä¹‹å‰çš„é‡å¤æ³¨è§£åªèƒ½å†™æˆä»¥ä¸‹å½¢å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Infos(&#123;@Info(name = &quot;zhangsan&quot;), @Info(name = &quot;lisi&quot;)&#125;)</span><br><span class="line">private Person mPerson;</span><br><span class="line">public class Person &#123;</span><br><span class="line"></span><br><span class="line">    private String mName;</span><br><span class="line">    private int mAge;</span><br><span class="line">    private int mHeight;</span><br><span class="line">    private int mWeight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ Info å’Œ Infos åˆ†åˆ«æ˜¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Info &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Infos &#123;</span><br><span class="line">  </span><br><span class="line">  Info[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº Infos ä¸­ä¿ç•™äº† Info çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ Infos çš„ä¿ç•™æ—¶é—´ä¸èƒ½æ¯” Info å°‘ï¼Œå¦åˆ™ç¼–è¯‘å™¨å°†ä¼šæŠ¥é”™ã€‚å¦‚æœ Info çš„ä¿ç•™æ—¶é—´æ˜¯ RUNTIMEï¼Œè€Œ Infos çš„ä¿ç•™æ—¶é—´æ˜¯ SOURCEï¼Œé‚£ä¹ˆ JVM æœ€ç»ˆä¼šä¸¢å¼ƒ Infos ä»¥åŠ Infos ä¸­çš„ Info ä¿¡æ¯ï¼Œè¿™ä¸ Info æœŸæœ›çš„ä¿ç•™æ—¶é—´ç›¸çŸ›ç›¾ã€‚</p></li></ol><h3 id="è‡ªå®šä¹‰æ³¨è§£">è‡ªå®šä¹‰æ³¨è§£</h3><p>JDK å†…ç½®çš„æ³¨è§£å¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬è¿˜éœ€è¦å­¦ä¼šè‡ªå®šä¹‰æ³¨è§£ï¼Œå®šä¹‰ä¸€ä¸ªæ³¨è§£éœ€è¦ç”¨åˆ° <span class="citation" data-cites="Interface">@Interface</span> å…³é”®å­—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> View çš„ Id</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindOnClickListener &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> å®ç° OnClickListener æ¥å£çš„ç±»</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  Class&lt;? extends OnClickListener&gt; value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å®šä¹‰äº†ä¸¤ä¸ªæ³¨è§£ç”¨äºç»‘å®š View çš„ id ä»¥åŠ ç‚¹å‡»äº‹ä»¶ï¼Œå¹¶ä¸”æŒ‡å®šäº†æ³¨è§£å¯ä»¥ä¿®é¥°çš„å…ƒç´ ä»¥åŠä¿ç•™æ—¶é—´ï¼Œå¯ä»¥çœ‹åˆ°å®šä¹‰ä¸€ä¸ªæ³¨è§£ä¸å®šä¹‰ä¸€ä¸ªæ¥å£éå¸¸ç±»ä¼¼ï¼Œè€Œå®é™…ä¸Šæ¯ä¸ªæ³¨è§£éƒ½æ˜¯ç»§æ‰¿è‡ª Annotation æ¥å£çš„æ¥å£ï¼Œåç¼–è¯‘ BindView ç”Ÿæˆçš„ class æ–‡ä»¶å¯ä»¥çœ‹åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Compiled from <span class="string">"BindView.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">com</span>.<span class="title">rookieyang</span>.<span class="title">runtimeannotation</span>.<span class="title">customizeannotation</span>.<span class="title">BindView</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">annotation</span>.<span class="title">Annotation</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè‡ªå®šä¹‰çš„æ³¨è§£éƒ½æ˜¯å«æœ‰æˆå‘˜å˜é‡çš„ï¼Œè€Œæ³¨è§£é™¤äº†æŒ‰ç…§åŸºæœ¬æ³¨è§£ã€å…ƒæ³¨è§£ã€è‡ªå®šä¹‰æ³¨è§£è¿›è¡Œåˆ†ç±»ä¹‹å¤–ï¼Œæˆ‘è¿˜å¯ä»¥æ ¹æ®æ˜¯å¦åŒ…å«æˆå‘˜å˜é‡å°†å®ƒåˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li><p>æ ‡è®°æ³¨è§£ï¼šè¿™ç§æ³¨è§£æ²¡æœ‰æˆå‘˜å˜é‡ï¼Œå®ƒä»…ä»…é€šè¿‡æ˜¯å¦å­˜åœ¨æ¥æä¾›ä¿¡æ¯ï¼Œå¦‚@Overrideã€<span class="citation" data-cites="Deprecated">@Deprecated</span></p></li><li><p>å…ƒæ•°æ®æ³¨è§£ï¼šè¿™ç§æ³¨è§£åŒ…å«æˆå‘˜å˜é‡ï¼Œå®ƒé€šè¿‡æˆå‘˜å˜é‡æä¾›æ›´å¤šçš„ä¿¡æ¯ï¼Œå¦‚@Retentionã€<span class="citation" data-cites="Target">@Target</span></p></li></ul><h2 id="æ³¨è§£çš„å¤„ç†">æ³¨è§£çš„å¤„ç†</h2><p>åœ¨ä½¿ç”¨è‡ªå®šä¹‰çš„æ³¨è§£çš„æ—¶å€™ï¼Œå¦‚æœä¸æä¾›æ³¨è§£çš„å¤„ç†å·¥å…·ï¼Œæ³¨è§£æ˜¯ä¸ä¼šè‡ªåŠ¨ç”Ÿæ•ˆçš„ï¼Œæ³¨è§£çš„å¤„ç†æ–¹æ³•ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯è¿è¡Œæ—¶å¤„ç†æ³¨è§£ï¼Œä¸€ç§æ˜¯ç¼–è¯‘æ—¶å¤„ç†æ³¨è§£ã€‚</p><ol type="1"><li><p>è¿è¡Œæ—¶å¤„ç†æ³¨è§£</p><p>è¿è¡Œæ—¶å¤„ç†æ³¨è§£ä¸»è¦åˆ©ç”¨ Java çš„åå°„æœºåˆ¶ï¼Œæ¥ä¸‹æ¥å°†ç»“åˆå…·ä½“å®ä¾‹è¯´æ˜å¦‚ä½•é€šè¿‡åå°„å¤„ç†æ³¨è§£ã€‚</p><p>é¦–å…ˆåˆ©ç”¨è‡ªå®šä¹‰æ³¨è§£éƒ¨åˆ†å®šä¹‰çš„ä¸¤ä¸ªæ³¨è§£ BindView å’Œ BindOnClickListener å¯¹ View è¿›è¡Œæ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@BindView</span>(R.id.hello_world)</span><br><span class="line"><span class="meta">@BindOnClickListener</span>(CustomizeOnClickListener.class)</span><br><span class="line"><span class="keyword">private</span> Button mHelloWorld;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ Activity ä¸­å®šä¹‰ä¸€ä¸ª CustomizeOnClickListener å†…éƒ¨ç±»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class CustomizeOnClickListener implements OnClickListener &#123;</span><br><span class="line"></span><br><span class="line">  @Override</span><br><span class="line">  public void onClick(View view) &#123;</span><br><span class="line">    Toast.makeText(MainActivity.this, R.string.hello_world,</span><br><span class="line">    Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€å®šä¹‰ä¸€ä¸ªå¤„ç†æ³¨è§£çš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationProcess</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">    Field[] fields = obj.getClass().getDeclaredFields();</span><br><span class="line">    Activity activity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Activity)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"ä¼ å…¥çš„å‚æ•°ä¸æ˜¯Activity"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    activity = (Activity) obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        View view = <span class="keyword">null</span>;</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span> );</span><br><span class="line">        BindView bindView = field.getAnnotation(BindView.class);</span><br><span class="line">        BindOnClickListener bindOnClickListener = field</span><br><span class="line">        .getAnnotation(BindOnClickListener.class);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯ View</span></span><br><span class="line">        <span class="keyword">boolean</span> isView = View.class.isAssignableFrom(field.getType());</span><br><span class="line">        <span class="keyword">if</span> (bindView != <span class="keyword">null</span> &amp;&amp; isView) &#123;</span><br><span class="line">          view = activity.findViewById(bindView.value());</span><br><span class="line">          <span class="comment">//è®¾ç½® obj å¯¹è±¡å½“ä¸­çš„ field å€¼ä¸º view</span></span><br><span class="line">          field.set(obj, view);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bindOnClickListener != <span class="keyword">null</span> &amp;&amp; isView &amp;&amp; view != <span class="keyword">null</span>) &#123;</span><br><span class="line">          Class&lt;? extends OnClickListener&gt; listener = bindOnClickListener.value();</span><br><span class="line">          <span class="comment">//å®ä¾‹åŒ– CustomizeOnClickListener å†…éƒ¨ç±»</span></span><br><span class="line">          OnClickListener onClickListener = listener.getConstructor(</span><br><span class="line">          obj.getClass()).newInstance(activity);</span><br><span class="line">          view.setOnClickListener(onClickListener);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.i(obj.getClass().getSimpleName(), e.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ååœ¨ Activity ä¸­è°ƒç”¨å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationProcess.process(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure></li><li><p>ç¼–è¯‘æ—¶å¤„ç†æ³¨è§£</p><p>ç›¸å¯¹ä¸è¿è¡Œæ—¶åˆ©ç”¨åå°„å¤„ç†æ³¨è§£ä¼šæœ‰æ€§èƒ½æŸå¤±è€Œè¨€ï¼Œç¼–è¯‘æ—¶å¤„ç†æ³¨è§£åˆ©ç”¨ APTï¼ˆAnnotation Processing Toolï¼‰å¯¹æ³¨è§£è¿›è¡Œå¤„ç†ç„¶åç”Ÿæˆä»£ç ã€XML æ–‡ä»¶ï¼Œåˆ©ç”¨ APT å»å¤„ç†æ³¨è§£æ€§èƒ½æ›´å¥½ã€‚å‚ç…§ JDK æ–‡æ¡£ä¸­å¯¹äº Processor æ¥å£çš„æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´çŸ¥é“æ³¨è§£å¤„ç†å™¨çš„å·¥ä½œæµç¨‹</p><blockquote><ol type="1"><li>If an existing Processor object is not being used, to create an instance of a processor the tool calls the no-arg constructor of the processor class.</li><li>Next, the tool calls the init method with an appropriate ProcessingEnvironment.</li><li>Afterwards, the tool calls getSupportedAnnotationTypes, getSupportedOptions, and getSupportedSourceVersion. These methods are only called once per run, not on each round.</li><li>As appropriate, the tool calls the process method on the Processor object; a new Processor object is not created for each round.</li></ol></blockquote><p>ç¼–è¯‘å·¥å…·å°†ä¼šé€šè¿‡æ³¨è§£å¤„ç†å™¨çš„æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–ä¸€ä¸ªæ³¨è§£å¤„ç†å™¨å¯¹è±¡ï¼Œç„¶åè°ƒç”¨æ³¨è§£å¤„ç†å™¨çš„ init æ–¹æ³•å¹¶ä¼ å…¥ ProcessingEnvironmentï¼Œä¹‹ååˆ™è°ƒç”¨ getSupportedAnnotationTypesï¼ŒgetSupportedOptionså’ŒgetSupportedSourceVersionï¼Œæœ€åå°†ä¼šè°ƒç”¨ process æ–¹æ³•ã€‚ æ¥ä¸‹æ¥å°†è¯´æ˜å¦‚ä½•åˆ©ç”¨ APT ç”Ÿæˆä¸€ä¸ªç±»æ–‡ä»¶ç”¨äºæ˜¾ç¤º HelloWorldï¼š</p><p>é¦–å…ˆéœ€è¦æ˜ç¡®å¸Œæœ›ç”Ÿæˆçš„ç±»æ–‡ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rookieyang.myannotationtwo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity_HelloWorld</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(context, <span class="string">"HelloWorld"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ³è¦ç”Ÿæˆè¿™ä¸ªç±»æ–‡ä»¶éœ€è¦è·å–åˆ°ä¸¤ç‚¹ä¿¡æ¯ï¼š<strong>åŒ…åå’Œç±»å</strong>ï¼Œé€šè¿‡åŒ…åå¯ä»¥ä½¿ç±»æ–‡ä»¶ç”Ÿæˆåœ¨ä½¿ç”¨æ³¨è§£çš„åŒ…ä¸‹ï¼Œä¾¿äºè§£ææ³¨è§£çš„æ—¶å€™åŠ è½½ç±»æ–‡ä»¶ï¼Œé€šè¿‡ç±»ååŠ ä¸Š &quot;_HelloWorld&quot; ç¡®ä¿ç”Ÿæˆçš„ç±»æ–‡ä»¶å”¯ä¸€å­˜åœ¨ï¼ŒåŒæ—¶ä¹Ÿè¾¾åˆ°äº†ä½¿ç”¨æ³¨è§£çš„ç±»å’Œç”Ÿæˆçš„ç±»ç»‘å®šçš„æ•ˆæœã€‚</p><p>æ¥ä¸‹æ¥éœ€è¦åˆ›å»ºä¸¤ä¸ª Moduleï¼Œå…¶ä¸­ä¸€ä¸ªå®šä¹‰äº†æ‰€æœ‰çš„æ³¨è§£ï¼Œå¦å¤–ä¸€ä¸ªå®šä¹‰äº† APTï¼Œä¹‹æ‰€ä»¥éœ€è¦å®šä¹‰ä¸¤ä¸ª Module çš„åŸå› ï¼Œå…¶ä¸€ä¸ºäº†è®©å·¥ç¨‹ç»“æ„æ›´æ¸…æ™°ï¼Œå¦ä¸€æ–¹é¢å®šä¹‰ APT éœ€è¦ç”¨åˆ° javax åŒ…ã€‚æ•´ä½“çš„å·¥ç¨‹ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/project-structure.jpg"></p><p>ä¹‹åéœ€è¦ä¸º annotations-compiler å’Œ app æ¨¡å—å¼•å…¥ç›¸å…³ä¾èµ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">annotations-compiler æ¨¡å—</span><br><span class="line">compile <span class="string">'com.google.auto.service:auto-service:1.0-rc3'</span></span><br><span class="line"><span class="function">compile <span class="title">project</span><span class="params">(path: <span class="string">':annotations'</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">app æ¨¡å—</span></span><br><span class="line"><span class="function">compile <span class="title">project</span><span class="params">(path: <span class="string">':annotations'</span>)</span></span></span><br><span class="line"><span class="function">annotationProcessor <span class="title">project</span><span class="params">(<span class="string">':annotations-compiler'</span>)</span></span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­ auto-service çš„ä½œç”¨æ˜¯å¸®åŠ©æˆ‘ä»¬ç”Ÿæˆä¸‹åˆ—æ–‡ä»¶ï¼Œä¸»è¦ä½œç”¨æ˜¯å£°æ˜æ³¨è§£å¤„ç†å™¨ã€‚</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/META-INF.jpg"></p><p>annotationProcessor åˆ™æ˜¯ä¸ºæ¨¡å—æŒ‡å®šæ³¨è§£å¤„ç†å™¨</p><p>é…ç½®ä¹‹åé¦–å…ˆåœ¨ annotations æ¨¡å—å®šä¹‰ä¸€ä¸ª HelloWorld æ³¨è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.FIELD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.CLASS)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> HelloWorld &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨ annotations-compiler æ¨¡å—ç¼–å†™å¯¹åº”æ³¨è§£å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ‡è¯†ä¸€ä¸ªæ³¨è§£å¤„ç†å™¨</span></span><br><span class="line"><span class="meta">@AutoService</span>(Processor.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationsCompiler</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Elements mElements;</span><br><span class="line">  <span class="keyword">private</span> Filer mFiler;</span><br><span class="line">  <span class="keyword">private</span> Messager mMessager;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * ç”¨äºåˆå§‹åŒ– mElementsã€mFilerã€mMessager</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvi)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.init(processingEnvi);</span><br><span class="line"></span><br><span class="line">    mElements = processingEnvi.getElementUtils();</span><br><span class="line">    mFiler = processingEnvi.getFiler();</span><br><span class="line">    mMessager = processingEnvi.getMessager();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> elements å®é™…ä¸Šä¼ å…¥çš„éƒ½æ˜¯ &#123;<span class="doctag">@link</span> #getSupportedAnnotationTypes()&#125;</span></span><br><span class="line"><span class="comment">  * ä¸­æ”¯æŒçš„å¹¶ä¸”è¢«æ‰«æåˆ°ï¼ˆä½¿ç”¨è¿‡ï¼‰æ³¨è§£å…ƒç´ ï¼Œä¾‹å¦‚è¿™é‡Œè·å–åˆ°çš„ç±»å…ƒç´ å°±æ˜¯ HelloWorld æ³¨è§£</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> roundEnvi ä¸€ä¸ªæ³¨è§£å¤„ç†å·¥å…·æ¡†æ¶ï¼Œé€šè¿‡å®ƒå¯ä»¥æŸ¥è¯¢åˆ°ä½¿ç”¨äº†æ³¨è§£çš„å…ƒç´ </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> è¿”å›å¤„ç†ç»“æœ</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements,</span></span></span><br><span class="line"><span class="function"><span class="params">  RoundEnvironment roundEnvi)</span> </span>&#123;</span><br><span class="line">    String packageName;</span><br><span class="line">    String className;</span><br><span class="line">    <span class="comment">//è·å–ä½¿ç”¨äº† HelloWorld æ³¨è§£çš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> (Element element : roundEnvi.getElementsAnnotatedWith(HelloWorld.class)) &#123;</span><br><span class="line">      <span class="comment">//é€šè¿‡ Elements å»è·å–åŒ…å</span></span><br><span class="line">      packageName = mElements.getPackageOf(element).toString();</span><br><span class="line">      <span class="comment">//HelloWorld æ³¨è§£åªèƒ½è¢«ç”¨åœ¨æˆå‘˜å˜é‡ï¼Œæ‰€ä»¥é€šè¿‡è·å–å¤–å±‚å…ƒç´ å°±å¯ä»¥è·å–åˆ°ä½¿ç”¨æ³¨è§£çš„å…ƒç´ æ‰€åœ¨çš„ç±»</span></span><br><span class="line">      className = element.getEnclosingElement().getSimpleName() + <span class="string">"_HelloWorld"</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡ Filer æŒ‡å®šçš„è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ª java æºæ–‡ä»¶ï¼Œç„¶åå†™å…¥å¯¹åº”çš„ä»£ç </span></span><br><span class="line">        JavaFileObject javaFileObject = mFiler.createSourceFile(</span><br><span class="line">        packageName + <span class="string">"."</span> + className);</span><br><span class="line">        Writer writer = javaFileObject.openWriter();</span><br><span class="line">        writer.write(<span class="string">"package "</span> + packageName + <span class="string">";\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import android.content.Context;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"import android.widget.Toast;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"public class "</span> + className + <span class="string">" &#123;\n\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"\tpublic static void show(Context context) &#123;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"\t\tToast.makeText(context,"</span></span><br><span class="line">        + <span class="string">" \"HelloWorld\", Toast.LENGTH_SHORT).show();\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"\t&#125;\n"</span>);</span><br><span class="line">        writer.write(<span class="string">"\n&#125;"</span>);</span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> è¿”å›æ³¨è§£å¤„ç†å™¨æ”¯æŒçš„ Java ç‰ˆæœ¬</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SourceVersion.latestSupported();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> è¿”å›æ³¨è§£å¤„ç†å™¨æ”¯æŒçš„æ³¨è§£é›†åˆ</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; annotationTypes = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; annotation : getSupportedAnnotations()) &#123;</span><br><span class="line">      annotationTypes.add(annotation.getCanonicalName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> annotationTypes;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> è¿”å›æ”¯æŒçš„æ³¨è§£ç±»å‹é›†åˆ</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;Class&lt;? extends Annotation&gt;&gt; getSupportedAnnotations() &#123;</span><br><span class="line">    Set&lt;Class&lt;? extends Annotation&gt;&gt; annotationSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    annotationSet.add(HelloWorld.class);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> annotationSet;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è¯´ä¸‹å‡ ä¸ªæœ‰åŠ©äºç†è§£æ³¨è§£å¤„ç†å™¨çš„ç‚¹ï¼š</p><ul><li><p>Elements æ˜¯ä¸€ä¸ªè·å–ç¨‹åºå…ƒç´ ä¿¡æ¯çš„æ¥å£ï¼Œä¾‹å¦‚è·å–å…ƒç´ çš„åŒ…åã€åˆ¤æ–­æ˜¯å¦æ˜¯é‡å†™æ–¹æ³•ï¼Œä¾‹å¦‚</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/Elements.jpg"></p></li><li><p>Filer åˆ™æ˜¯ä¸€ä¸ªæ”¯æŒé€šè¿‡æ³¨è§£å¤„ç†å™¨åˆ›å»ºæ–‡ä»¶çš„æ¥å£ï¼Œå¯ä»¥ç”¨äºåˆ›å»º Classæ–‡ä»¶ã€æºæ–‡ä»¶ã€èµ„æºæ–‡ä»¶</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/Filer.jpg"></p></li><li><p>Messager åˆ™æ˜¯ä¸ºæ³¨è§£å¤„ç†å™¨æä¾›çš„è¾“å‡ºé”™è¯¯ä¿¡æ¯çš„æ¥å£ã€‚</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/Messager.jpg"></p></li><li><p>Element ä¸ Elements åŒºåˆ«åœ¨äº Element æ˜¯è·å–å•ä¸ªç¨‹åºå…ƒç´ ä¿¡æ¯çš„æ¥å£ï¼Œè€Œ Elements å¯ä»¥è·å–æ•´ä¸ªç¨‹åºçš„å…ƒç´ ä¿¡æ¯ã€‚é™¤äº† Element ä¹‹å¤–ï¼Œä¸Šè¿°ç¨‹åºè¿˜å¯ä»¥çœ‹åˆ° TypeElementï¼Œè€Œ TypeElement æ˜¯ä¸€ä¸ªç»§æ‰¿äº† Element æ¥å£çš„æ¥å£ï¼Œç”¨äºè¡¨ç¤ºç±»å…ƒç´ ã€‚å®é™…ä¸Š JDK è¿˜æä¾›äº†å¾ˆå¤šç»§æ‰¿è‡ª Element çš„æ¥å£ç”¨äºè¡¨ç¤ºç¨‹åºä¸­çš„å„é¡¹å…ƒç´ ï¼Œå…·ä½“çš„ Element ç»§æ‰¿ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/2018/01/15/JavaåŸºç¡€ä¹‹æ³¨è§£/Element.jpg"></p></li></ul><p>åœ¨ç¼–å†™å®Œæ³¨è§£å¤„ç†å™¨ä¹‹åï¼Œæœ€ååœ¨ App æ¨¡å—ä¸­ç¼–å†™å¯¹åº”çš„è°ƒç”¨ä»£ç å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//è·å¾—ç”Ÿæˆçš„ç±»çš„ Class å¯¹è±¡</span></span><br><span class="line">    Class&lt;?&gt; helloClass = Class.forName(getPackageName() + <span class="string">"."</span></span><br><span class="line">    + getClass().getSimpleName() + <span class="string">"_HelloWorld"</span>);</span><br><span class="line">    <span class="comment">//åˆ©ç”¨åå°„å–å¾— show æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•å³å¯</span></span><br><span class="line">    Method showMethod = helloClass.getMethod(<span class="string">"show"</span>, Context.class);</span><br><span class="line">    showMethod.invoke(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šç¼–è¯‘æ—¶æ³¨è§£çš„æ•´ä¸ªå¤„ç†è¿‡ç¨‹æ˜¯åˆ©ç”¨æ³¨è§£å¤„ç†å™¨å¯¹ç¨‹åºä¸­ä½¿ç”¨äº†æ³¨è§£çš„å…ƒç´ è¿›è¡Œéå†ï¼Œä»å…ƒç´ ä¸­æå–æ‰€éœ€çš„ä¿¡æ¯ï¼Œç„¶åç”Ÿæˆç±»æ–‡ä»¶ï¼Œæœ€ååœ¨ç¨‹åºä¸­åŠ è½½ç”Ÿæˆçš„ç±»å¹¶è°ƒç”¨å…¶ä¸­çš„æ–¹æ³•ã€‚</p><p>æœ€åç»™å‡ºæœ¬æ¬¡æµ‹è¯•çš„å·¥ç¨‹é“¾æ¥ <a href="https://github.com/firstdream10/Android-Study-Project/tree/master/Annotation" target="_blank" rel="noopener">Annotation æµ‹è¯•</a></p></li></ol><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æœ€åè®©æˆ‘ä»¬å›ç­”å¼€å§‹çš„å‡ ä¸ªé—®é¢˜</p><ol type="1"><li><p>æ³¨è§£æ˜¯ä¸€ç§ç”¨äºæè¿°ç¨‹åºå…ƒç´ ä¿¡æ¯çš„ä¿®é¥°ç¬¦ï¼Œå¯ä»¥ç”¨æ¥ä¿®é¥°åŒ…ã€ç±»ã€æ„é€ å™¨ã€æ–¹æ³•ã€æˆå‘˜å˜é‡ã€å‚æ•°ã€å±€éƒ¨å˜é‡ã€‚</p></li><li><p>å½“æˆ‘ä»¬éœ€è¦ä¸ºç¨‹åºä¸­çš„å…ƒç´ æä¾›ä¿¡æ¯ï¼Œå¹¶ä¸”è¿™äº›ä¿¡æ¯å¾—åˆ°å¤„ç†çš„æ—¶å€™ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨æ³¨è§£ã€‚</p></li><li><p>æŒ‰ç…§ç³»ç»Ÿå†…ç½®çš„æ³¨è§£ï¼Œå¯ä»¥åˆ†ä¸º<strong>åŸºæœ¬æ³¨è§£ã€å…ƒæ³¨è§£ã€è‡ªå®šä¹‰æ³¨è§£</strong>ã€‚æŒ‰ç…§æ˜¯å¦æœ‰æˆå‘˜å˜é‡å¯ä»¥åˆ†ä¸º<strong>æ ‡è®°æ³¨è§£ã€å…ƒæ•°æ®æ³¨è§£</strong>ã€‚æŒ‰ç…§å¤„ç†æ–¹å¼ï¼Œå¯ä»¥åˆ†ä¸º<strong>è¿è¡Œæ—¶æ³¨è§£ã€ç¼–è¯‘æ—¶æ³¨è§£</strong>ã€‚</p></li><li><p>æ³¨è§£çš„å¤„ç†è¿‡ç¨‹ä¸»è¦ä¸ºè¿è¡Œæ—¶é€šè¿‡åå°„å¤„ç†å’Œç¼–è¯‘æ—¶é€šè¿‡æ³¨è§£å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚</p></li></ol><h2 id="thanks">Thanks</h2><ul><li>ã€ŠJava ç¼–ç¨‹æ€æƒ³ã€‹</li><li>ã€Šç–¯ç‹‚ Java è®²ä¹‰ã€‹</li><li><a href="https://docs.oracle.com/javase/tutorial/java/annotations/index.html" target="_blank" rel="noopener">Annotation Tutorials</a></li><li><a href="http://blog.csdn.net/doc_sgl/article/details/50367083" target="_blank" rel="noopener">è‡ªå·±åŠ¨æ‰‹å®ç°Javaæ³¨è§£ï¼ˆJava Annotation in Actionï¼‰</a></li><li><a href="http://www.jianshu.com/p/b6b3283968e0" target="_blank" rel="noopener">æ³¨è§£å¤„ç†å™¨ï¼ˆAnnotation Processorï¼‰åŸç†ç®€æ</a></li><li><a href="http://www.cnblogs.com/whoislcj/p/6168641.html" target="_blank" rel="noopener">Androidæ³¨è§£ä½¿ç”¨ä¹‹é€šè¿‡annotationProcessoræ³¨è§£ç”Ÿæˆä»£ç å®ç°è‡ªå·±çš„ButterKnifeæ¡†æ¶</a></li><li><a href="http://www.cnblogs.com/whoislcj/p/6148410.html" target="_blank" rel="noopener">Androidæ³¨è§£ä½¿ç”¨ä¹‹æ³¨è§£ç¼–è¯‘android-aptå¦‚ä½•åˆ‡æ¢åˆ°annotationProcessor</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é—®é¢˜&quot;&gt;é—®é¢˜&lt;/h2&gt;
&lt;p&gt;å…³äºæ³¨è§£é¦–å…ˆè¯·æ€è€ƒä¸€ä¸‹ä»¥ä¸‹é—®é¢˜ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ³¨è§£æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/li&gt;
&lt;li&gt;æ³¨è§£çš„ä¸»è¦ä½¿ç”¨åœºæ™¯ï¼Ÿ&lt;/li&gt;
&lt;li&gt;æ³¨è§£å¯ä»¥åˆ†ä¸ºå“ªäº›ç±»å‹ï¼Ÿ&lt;/li&gt;
&lt;li&gt;æ³¨è§£çš„å¤„ç†è¿‡ç¨‹ï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬å°†å¯¹è¿™å‡ ä¸ªé—®é¢˜è¿›è¡Œæ¢è®¨&lt;/p&gt;
    
    </summary>
    
      <category term="JavaåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Java" scheme="http://www.ikroal.xyz/tags/Java/"/>
    
      <category term="æ³¨è§£" scheme="http://www.ikroal.xyz/tags/%E6%B3%A8%E8%A7%A3/"/>
    
  </entry>
  
  <entry>
    <title>2017å¹´å¹´ç»ˆæ€»ç»“</title>
    <link href="http://www.ikroal.xyz/2018/01/07/2018%E8%AE%A1%E5%88%92/"/>
    <id>http://www.ikroal.xyz/2018/01/07/2018è®¡åˆ’/</id>
    <published>2018-01-07T13:48:26.000Z</published>
    <updated>2018-03-04T15:36:06.917Z</updated>
    
    <content type="html"><![CDATA[<p>2017 å¿«ç»“æŸäº†ï¼Œæ­£å¥½è¶è¿™ä¸ªæ—¶é—´å¯¹è¿‡å»ä¸€å¹´åšä¸ªæ€»ç»“ï¼Œè¿‡å»ä¸€å¹´ä¸ŠåŠå¹´çš„è¡¨ç°åº”è¯¥èƒ½æœ‰ 70 åˆ†ï¼Œæ¯•ç«Ÿåœ¨åšæ¯•è®¾æœŸé—´åŠ²å¤´è¶³ï¼Œè€Œä¸”ä¹Ÿå­¦ä¹ åˆ°äº†ä¸å°‘ä¸œè¥¿ï¼Œè€Œå‚åŠ å·¥ä½œçš„ä¸‹åŠå¹´åˆ™ææ€•è¿ 30 åˆ†éƒ½ä¸åˆ°ã€‚å¤§è‡´åˆ†æäº†ä¸€ä¸‹é—®é¢˜æ‰€åœ¨<a id="more"></a></p><h4 id="é—®é¢˜">é—®é¢˜</h4><ol type="1"><li>ç¼ºä¹ä¸€ä¸ªæ˜ç¡®çš„å­¦ä¹ è·¯çº¿å’Œæ‰§è¡ŒåŠ› æ²¡æœ‰æ ¹æ®è‡ªèº«çš„å®é™…éœ€æ±‚åšä¸€ä¸ªè¯¦ç»†çš„è§„åˆ’ï¼Œå¹¶æ ¹æ®è§„åˆ’ä¸€æ­¥ä¸€æ­¥çš„æ‰å®æ¨è¿›å­¦ä¹ è®¡åˆ’ï¼Œåè€Œæ˜¯å„ä¸ªæ–¹é¢éƒ½æƒ³è¦è¿›è¡Œå­¦ä¹ ï¼Œå¼‚å¸¸çš„æ€¥åŠŸè¿‘åˆ©ï¼Œä»è€Œå¯¼è‡´èƒ½å¤Ÿæ·±å…¥çš„éƒ¨åˆ†æ¯”è¾ƒå°‘</li><li>å®è·µé—®é¢˜ å¯¹äºå®è·µè€Œè¨€ä¸€ä¸ªé—®é¢˜æ˜¯å¤ªè¿‡äºå°†é‡å¿ƒæ”¾åœ¨ UI æ•ˆæœä¸Šï¼Œå¹¶ä¸”åœ¨ä¸€äº›åŸç†æ€§çš„çŸ¥è¯†ç‚¹æ²¡æœ‰æŒæ¡çš„å¾ˆå¥½çš„æƒ…å†µä¸‹å¯¼è‡´åœ¨ UI æ–¹é¢æµªè´¹äº†å¾ˆå¤šæ—¶é—´ä¹Ÿæ¶ˆç£¨äº†å¤§éƒ¨åˆ†çš„ç²¾åŠ›ï¼Œæ‰€ä»¥å¯¼è‡´è‡ªå·±å®è·µè¿‡å°‘</li><li>åšå®¢çš„é—®é¢˜ åšå®¢ç»å¸¸æ–­æ–­ç»­ç»­ï¼Œé—®é¢˜åœ¨äºæ²¡æœ‰è§„åˆ’æ€§ï¼Œä¸è®ºæ˜¯è¦å†™çš„æ–‡ç« è¿˜æ˜¯æ–‡ç« æœ¬èº«çš„ç»“æ„éƒ½æ²¡æœ‰ä¸€ä¸ªå®Œæ•´çš„æ€è·¯ï¼Œæ‰€ä»¥ä»ä»¥å‰çš„åšå®¢å¯ä»¥çœ‹åˆ°æ‚ä¹±æ— ç« </li></ol><h4 id="æ–°çš„è§„åˆ’">æ–°çš„è§„åˆ’</h4><ol type="1"><li>åˆ¶å®šåˆç†å¯è¡Œçš„å­¦ä¹ è®¡åˆ’è¡¨ ç›®å‰å¤§è‡´æ€è·¯å¦‚ä¸‹<ul><li>åˆ¶å®šå…³äºåŸºç¡€æ–¹é¢çš„è®¡åˆ’ï¼Œç›®å‰å¤§è‡´åˆ†ä¸ºï¼šJava åŸºç¡€ã€Android åŸºç¡€ã€æ•°æ®ç»“æ„å’Œç®—æ³•ã€ç½‘ç»œåè®®ã€è®¾è®¡æ¨¡å¼ã€è¯»ä¹¦ç¬”è®°ã€å¸¸ç”¨æ¡†æ¶ã€‚è®¡åˆ’éœ€è¦åœ¨æŒç»­æ›´æ–°çš„è¿‡ç¨‹ä¸­è¿›è¡Œç»†åŒ–</li><li>ä»¥å‘¨ä¸ºå•ä½å°½å¯èƒ½è§£å†³ä¸€ä¸ªå¤§çš„çŸ¥è¯†ç‚¹ï¼Œå¹¶æ•´ç†æˆæ–‡ç« å‘è¡¨å‡ºå»ï¼ˆå¤šå¹³å°å¸Œæœ›æ¥å—åˆ«äººçš„æŒ‡æ­£ï¼‰</li><li>å…¶ä½™çš„å°çŸ¥è¯†ç‚¹å’Œè¿›é˜¶çŸ¥è¯†ç‚¹ä¼šå°†æ•´ç†åœ¨ Gitbook ä¸Š</li><li>æœ€åéœ€è¦å¯¹ç¬”è®°å’Œæ–‡ç« è¿›è¡Œè‰¯å¥½çš„åˆ†ç±»</li></ul></li><li>å®è·µé—®é¢˜ ä»Šå¹´å¯èƒ½ä¼šå®Œæˆä¸¤ä¸ª APPï¼Œä¸€ä¸ªæ˜¯å…³äºå•è¯è®°å¿†çš„ï¼ˆä¹‹å‰ç•™ä¸‹çš„çƒ‚æ‘Šå­ï¼Œéœ€è¦è¿›è¡Œé‡æ„ï¼‰ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ç½‘ç»œå£çº¸çš„ï¼Œé™¤æ­¤ä¹‹å¤–å¸Œæœ›æ¯ä¸ªæ˜ŸæœŸèƒ½å®‰æ’åŠå¤©ç»™è‡ªå·±å•çº¯çš„ç¼–ç æ—¶é—´ï¼Œä¸»è¦æ˜¯å’Œè‡ªå·±åšçš„ APP ç›¸å…³æˆ–è€…æ¨¡ä»¿åˆ«äººçš„ Demo</li><li>åšå®¢é—®é¢˜ ç›®å‰ä¸»è¦éœ€è¦è¿›è¡Œæ•´ç†ï¼Œä¹‹å‰çš„åšå®¢å·²ç»ä¿®æ­£äº†åˆ†ç±»ï¼Œåšå®¢çš„åˆ†ç±»å¤§è‡´ä¸æ•´ç†å‡ºæ¥çš„è®¡åˆ’è¡¨ç›¸å¯¹åº”ï¼Œåç»­å†™åšå®¢çš„æ—¶å€™å¸Œæœ›ç²¾ç›Šæ±‚ç²¾ï¼Œå…»æˆä¸€ä¸ªè‰¯å¥½çš„è¡Œæ–‡æ€è·¯</li></ol><p>ä¸ç®¡å¦‚ä½•ï¼Œæ–°çš„ä¸€å¹´éœ€è¦ GO FIGHTINGï¼</p><hr><p>2018-3-4 æ›´æ–°</p><p><a href="https://github.com/firstdream10/Learning-Way" target="_blank" rel="noopener">å­¦ä¹ è®¡åˆ’</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;2017 å¿«ç»“æŸäº†ï¼Œæ­£å¥½è¶è¿™ä¸ªæ—¶é—´å¯¹è¿‡å»ä¸€å¹´åšä¸ªæ€»ç»“ï¼Œè¿‡å»ä¸€å¹´ä¸ŠåŠå¹´çš„è¡¨ç°åº”è¯¥èƒ½æœ‰ 70 åˆ†ï¼Œæ¯•ç«Ÿåœ¨åšæ¯•è®¾æœŸé—´åŠ²å¤´è¶³ï¼Œè€Œä¸”ä¹Ÿå­¦ä¹ åˆ°äº†ä¸å°‘ä¸œè¥¿ï¼Œè€Œå‚åŠ å·¥ä½œçš„ä¸‹åŠå¹´åˆ™ææ€•è¿ 30 åˆ†éƒ½ä¸åˆ°ã€‚å¤§è‡´åˆ†æäº†ä¸€ä¸‹é—®é¢˜æ‰€åœ¨&lt;/p&gt;
    
    </summary>
    
      <category term="æ–°å¹´è®¡åˆ’" scheme="http://www.ikroal.xyz/categories/%E6%96%B0%E5%B9%B4%E8%AE%A1%E5%88%92/"/>
    
    
      <category term="æ–°å¹´è®¡åˆ’" scheme="http://www.ikroal.xyz/tags/%E6%96%B0%E5%B9%B4%E8%AE%A1%E5%88%92/"/>
    
  </entry>
  
  <entry>
    <title>Android å¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰ä¹‹ zygote è¿›ç¨‹</title>
    <link href="http://www.ikroal.xyz/2017/11/05/Android%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E7%AE%80%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://www.ikroal.xyz/2017/11/05/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆäºŒï¼‰/</id>
    <published>2017-11-05T15:30:49.000Z</published>
    <updated>2018-03-04T08:14:50.352Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>åœ¨ <a href="/2017/10/28/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰/" title="Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰">Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰</a>ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº† init è¿›ç¨‹æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Œæœ¬ç¯‡æ–‡ç« å°†ä¼šç»§ç»­åˆ†æ zygote å¯åŠ¨è¿‡ç¨‹ä»¥åŠä½œç”¨ã€‚<a id="more"></a></p><h2 id="zygote-å¯åŠ¨è¿‡ç¨‹">zygote å¯åŠ¨è¿‡ç¨‹</h2><p>zygote è¿›ç¨‹åˆ›å»ºä¹‹åä¼šé¦–å…ˆè¿›å…¥åˆ° app_main.cpp çš„ main å‡½æ•°å½“ä¸­å»ï¼Œæ‰€ä»¥é¦–å…ˆå¯¹ app_main è¿›è¡Œåˆ†æ</p><h3 id="app_main-åˆ†æ">app_main åˆ†æ</h3><p>frameworks/base/cmds/app_process/app_main.cpp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//åˆ›å»º AppRuntime å¯¹è±¡</span></span><br><span class="line">    <span class="function">AppRuntime <span class="title">runtime</span><span class="params">(argv[<span class="number">0</span>], computeArgBlockSize(argc, argv)</span>)</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè¿è¡Œæ—¶å‚æ•°ï¼Œå½“é‡åˆ°æ— æ³•è¯†åˆ«çš„é€‰é¡¹æ—¶åœæ­¢</span></span><br><span class="line">    bool zygote = <span class="keyword">false</span>;</span><br><span class="line">    bool startSystemServer = <span class="keyword">false</span>;</span><br><span class="line">    bool application = <span class="keyword">false</span>;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line"></span><br><span class="line">    ++i;  <span class="comment">// Skip unused "parent dir" argument.</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; argc) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* arg = argv[i++];</span><br><span class="line">      <span class="comment">//å¦‚æœä¼ å…¥çš„å‚æ•°æœ‰ â€--zygoteâ€œ åˆ™å°† zygote ç½®ä¸º true</span></span><br><span class="line">        <span class="keyword">if</span> (strcmp(arg, <span class="string">"--zygote"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            zygote = <span class="keyword">true</span>;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">          <span class="comment">//å¦‚æœä¼ å…¥çš„å‚æ•°æœ‰ "--start-system-server" åˆ™å°† startSystemServer ç½®ä¸º true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">"--start-system-server"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            startSystemServer = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(arg, <span class="string">"--application"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            application = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(arg, <span class="string">"--nice-name="</span>, <span class="number">12</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            niceName.setTo(arg + <span class="number">12</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strncmp(arg, <span class="string">"--"</span>, <span class="number">2</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            --i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">  <span class="comment">//é zygote æ¨¡å¼å¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (!className.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// We're not in zygote mode, the only argument we need to pass</span></span><br><span class="line">        <span class="comment">// to RuntimeInit is the application argument.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// The Remainder of args get passed to startup class main(). Make</span></span><br><span class="line">        <span class="comment">// copies of them before we overwrite them with the process name.</span></span><br><span class="line">        args.add(application ? String8(<span class="string">"application"</span>) : String8(<span class="string">"tool"</span>));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//zygote æ¨¡å¼ä¸‹çš„å¤„ç†</span></span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//å¦‚æœ startSystemServer ä¸º true åˆ™å°† "start-system-server" æ·»åŠ åˆ° args</span></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            args.add(String8(<span class="string">"start-system-server"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> prop[PROP_VALUE_MAX];</span><br><span class="line">        <span class="keyword">if</span> (property_get(ABI_LIST_PROPERTY, prop, NULL) == <span class="number">0</span>) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL(<span class="string">"app_process: Unable to determine ABI list from property %s."</span>,</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">11</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">String8 <span class="title">abiFlag</span><span class="params">(<span class="string">"--abi-list="</span>)</span></span>;</span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// In zygote mode, pass all remaining arguments to the zygote</span></span><br><span class="line">        <span class="comment">// main() method.</span></span><br><span class="line">        <span class="keyword">for</span> (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!niceName.isEmpty()) &#123;</span><br><span class="line">        runtime.setArgv0(niceName.string());</span><br><span class="line">        set_process_name(niceName.string());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å¦‚æœ zygote ä¸º true åˆ™å¯åŠ¨ zygote</span></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">      <span class="comment">//é€šè¿‡ runtime å¯¹è±¡å¯åŠ¨ zygote</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fprintf(stderr, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ main å‡½æ•°ä¸­é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ª AppRuntime å¯¹è±¡ï¼Œç„¶åå°±ä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°å¯¹ä¸€äº›æ ‡å¿—ä½è¿›è¡Œç›¸åº”çš„ç½®ä½ï¼Œè¿™é‡Œå€¼å¾—æ³¨æ„çš„ä¸€ä¸ªæ ‡å¿—ä½æ˜¯ startSystemServerï¼Œä¸Šæ–‡è¯´è¿‡ Android 5.0 ä¹‹åç³»ç»Ÿå¯èƒ½ä¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ï¼Œè€Œ SystemServer åªéœ€è¦å¯åŠ¨ä¸€æ¬¡ï¼Œæ‰€ä»¥é€šè¿‡è¿™ä¸ªæ ‡å¿—ä½æ§åˆ¶åªåœ¨å¯åŠ¨ä¸» zygote è¿›ç¨‹çš„æ—¶å€™å°† &quot;start-system-server&quot; å¢åŠ åˆ° argsï¼Œç„¶ååˆ™ä¼šé€šè¿‡ AppRuntime çš„ start å‡½æ•°è°ƒç”¨ Java å±‚çš„ zygote ä»£ç ã€‚</p><h3 id="androidruntime-åˆ†æ">AndroidRuntime åˆ†æ</h3><p>ç”±äº AppRuntime ç»§æ‰¿è‡ª AndroidRuntimeï¼Œæ‰€ä»¥æƒ³è¦äº†è§£ç³»ç»Ÿæ˜¯å¦‚ä½•è°ƒç”¨ Java å±‚çš„ zygote ä»£ç åˆ™éœ€è¦ç»§ç»­äº†è§£ AndroidRuntime çš„ start å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime</span><br></pre></td></tr></table></figure><p>AndroidRuntime ä½äº frameworks/base/core/jni</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Start the Android runtime.  This involves starting the virtual machine</span></span><br><span class="line"><span class="comment"> * and calling the "static void main(String[] args)" method in the class</span></span><br><span class="line"><span class="comment"> * named by "className".</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Passes the main function two arguments, the class name and the specified</span></span><br><span class="line"><span class="comment"> * options string.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">"start-system-server"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 'startSystemServer == true' means runtime is obsolete and not run from</span></span><br><span class="line"><span class="comment">     * init.rc anymore, so we print out the boot start event here.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">      <span class="comment">//åªæœ‰ startSystemServer == trueï¼Œoptions æ‰ä¼šæœ‰ start-system-server</span></span><br><span class="line">        <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">           <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">           <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//const char* kernelHack = getenv("LD_ASSUME_KERNEL");</span></span><br><span class="line">    <span class="comment">//ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* start the virtual machine */</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="comment">//åˆ›å»ºå¯åŠ¨ DVM</span></span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Register android functions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//æ³¨å†Œ JNI æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * We want to call main() with a String array with arguments in it.</span></span><br><span class="line"><span class="comment">     * At present we have two arguments, the class name and an option string.</span></span><br><span class="line"><span class="comment">     * Create an array to hold them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//å°† options è½¬åŒ–ä¸º java ä¸­çš„ String æ•°ç»„</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//åˆ›å»ºå¯¹è±¡æ•°ç»„ï¼Œç±»å‹ä¸º stringClassï¼ˆå³ String ç±»å‹ï¼‰ï¼Œé•¿åº¦ä¸º options.size() + 1</span></span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å°† options é€ä¸ªå¢åŠ åˆ°å¯¹è±¡æ•°ç»„å½“ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">        assert(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Start VM.  This thread becomes the main thread of the VM, and will</span></span><br><span class="line"><span class="comment">     * not return until the VM exits.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">    <span class="comment">//å¯»æ‰¾ç±»åä¸º slashClassName çš„ç±»</span></span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//æŸ¥æ‰¾ main æ–¹æ³•ï¼Œ([Ljava/lang/String;)V æ˜¯ main æ–¹æ³•çš„ç­¾å</span></span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//è°ƒç”¨ startClass ç±»å½“ä¸­çš„ main æ–¹æ³•ï¼Œä¼ å…¥å‚æ•° strArray</span></span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">            <span class="keyword">if</span> (env-&gt;ExceptionCheck())</span><br><span class="line">                threadExitUncaughtException(env);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ start å‡½æ•°çš„æ³¨é‡Šæˆ‘ä»¬å¯ä»¥å¤§è‡´äº†è§£åˆ° <strong>start å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯å¯åŠ¨è™šæ‹Ÿæœºå’Œåä¸º classname çš„ main æ–¹æ³•</strong>ã€‚</p><p>è€Œä¸Šæ–‡å¯ä»¥çŸ¥é“ï¼Œä¼ å…¥çš„ classname æ˜¯ &quot;com.android.internal.os.ZygoteInit&quot; ã€‚é‚£ä¹ˆæ•´ä¸ªçš„æ‰§è¡Œæµç¨‹å°±æ˜¯ï¼š</p><p>é¦–å…ˆä¼šåˆ¤æ–­ä¼ é€’è¿›æ¥çš„å‚æ•°æ˜¯å¦å­˜åœ¨ &quot;start-system-server&quot; ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¼šè¾“å‡ºå¯åŠ¨æ—¥å¿—ï¼Œç„¶åä¼šé€šè¿‡ startVm å‡½æ•°åˆ›å»ºå¯åŠ¨ DVMï¼Œåœ¨å¯åŠ¨ DVM ä¹‹åä¼šé€šè¿‡ startReg å‡½æ•°æ³¨å†Œ JNI æ–¹æ³•ï¼Œåœ¨æ³¨å†Œå®Œæ¯•ä¹‹åä¼šå°†ä¼ å…¥çš„ options å‚æ•°è½¬æ¢ä¸º Java çš„å¯¹è±¡æ•°ç»„ï¼Œè€Œä¹‹æ‰€ä»¥éœ€è¦è½¬æ¢æˆå¯¹è±¡æ•°ç»„æ˜¯å› ä¸ºåœ¨äº options éœ€è¦ä½œä¸º main æ–¹æ³•çš„å‚æ•°ä¼ å…¥ï¼Œä¹‹åå†é€šè¿‡ä¼ å…¥çš„ className å»è·å¾— jclass å¯¹è±¡ï¼Œå¹¶æ ¹æ® main æ–¹æ³•çš„ JNI ç­¾åå¾—åˆ° jmethodIDï¼Œæœ€ç»ˆé€šè¿‡CallStaticVoidMethod æ–¹æ³•å®Œæˆ main æ–¹æ³•çš„è°ƒç”¨ã€‚</p><h3 id="zygoteinit-åˆ†æ">ZygoteInit åˆ†æ</h3><p>frameworks/base/core/java/com/android/internal/os</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    String socketName = <span class="string">"zygote"</span>;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//æ³¨å†Œ socket</span></span><br><span class="line">        registerZygoteSocket(socketName);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//é¢„åŠ è½½ç±»å’Œèµ„æº</span></span><br><span class="line">        preload();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»º SystemServer è¿›ç¨‹</span></span><br><span class="line">            startSystemServer(abiList, socketName);</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">        runSelectLoop(abiList);</span><br><span class="line">      ...</span><br><span class="line">      </span><br><span class="line">        closeServerSocket();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        caller.run();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</span><br><span class="line">        closeServerSocket();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ª main æ–¹æ³•çš„æ‰§è¡Œæµç¨‹æ˜¯ï¼šé¦–å…ˆé€šè¿‡ registerZygoteSocket æ–¹æ³•å¯¹ socket è¿›è¡Œäº†æ³¨å†Œï¼Œæ³¨å†Œçš„ socket ç”¨äºå’Œ ActivityManagerService è¿›è¡Œé€šä¿¡ï¼Œç„¶åè°ƒç”¨ preload æ–¹æ³•å¯¹ç±»å’Œèµ„æºè¿›è¡ŒåŠ è½½ï¼Œä¹‹ååˆ™ä¼šè°ƒç”¨ startSystemServer åˆ›å»º SystemServer è¿›ç¨‹ï¼Œæœ€åé€šè¿‡ runSelectLoop ç­‰å¾…æ¥è‡ª ActivityManagerService çš„è¯·æ±‚ã€‚</p><p>è¿™é‡Œæœ€ä¸ºå…³é”®çš„æ˜¯ socket ä»¥åŠåˆ›å»º SystemServer è¿›ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥äº†è§£è¿™ä¸¤ä¸ªéƒ¨åˆ†ã€‚</p><h4 id="æ³¨å†Œ-socket-è¿‡ç¨‹">æ³¨å†Œ Socket è¿‡ç¨‹</h4><p>é¦–å…ˆæ˜¯æ³¨å†Œ Socket éƒ¨åˆ†ï¼Œ registerZygoteSocket ä¸»è¦æ˜¯åˆ©ç”¨æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºäº†ä¸€ä¸ª LocalServerSocket å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fileDesc;</span><br><span class="line">      <span class="comment">//socket åä¸º ANDROID_SOCKET_zygote</span></span><br><span class="line">        <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String env = System.getenv(fullSocketName);</span><br><span class="line">            fileDesc = Integer.parseInt(env);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">            fd.setInt$(fileDesc);</span><br><span class="line">          <span class="comment">//åˆ›å»º LocalServerSockt</span></span><br><span class="line">            sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¯åŠ¨-systemserver">å¯åŠ¨ SystemServer</h4><p>startSystemServer ä¸»è¦å·¥ä½œæ˜¯å¯¹è®¾ç½®çš„å‚æ•°è¿›è¡Œè§£æï¼Œç„¶åé€šè¿‡ forkSystemServer åˆ›å»º SystemServer è¿›ç¨‹ï¼Œæœ€ååœ¨ SystemServer è¿›ç¨‹ä¸­è°ƒç”¨ handleSystemServerProcess æ–¹æ³•å¤„ç†å‰©ä½™å·¥ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">/* Hardcoded command line to start the system server */</span></span><br><span class="line">  <span class="comment">//è®¾ç½® uid ä¸º 1000,è®¾ç½® gid ä¸º 1000ï¼Œå¯åŠ¨ com.android.server.SystemServer</span></span><br><span class="line">    String args[] = &#123;</span><br><span class="line">        <span class="string">"--setuid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgid=1000"</span>,</span><br><span class="line">        <span class="comment">/// M: ANR mechanism for system_server add shell(2000) group to access</span></span><br><span class="line">        <span class="comment">///    /sys/kernel/debug/tracing/tracing_on</span></span><br><span class="line">        <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,2000,"</span> +</span><br><span class="line">            <span class="string">"3001,3002,3003,3006,3007,3009,3010"</span>,</span><br><span class="line">        <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">        <span class="string">"--nice-name=system_server"</span>,</span><br><span class="line">        <span class="string">"--runtime-args"</span>,</span><br><span class="line">        <span class="string">"com.android.server.SystemServer"</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//å¯¹ args è¿›è¡Œè§£æ</span></span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Request to fork the system server process */</span></span><br><span class="line">      <span class="comment">//åˆ›å»º SystemServer è¿›ç¨‹</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                parsedArgs.permittedCapabilities,</span><br><span class="line">                parsedArgs.effectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* For child process */</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å¤„ç† SystemServer è¿›ç¨‹å‰©ä½™å·¥ä½œ</span></span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚">ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚</h4><p>runSelectLoop çš„ä¸»è¦å·¥ä½œæ˜¯é€šè¿‡ ZygoteConnection çš„ acceptCommandPeer æ–¹æ³•ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œç„¶åè°ƒç”¨ runOnce æ–¹æ³•å¯¹æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line"></span><br><span class="line">    fds.add(sServerSocket.getFileDescriptor());</span><br><span class="line">    peers.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å¾ªç¯å¤„ç†è¿æ¥è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">            pollFds[i].fd = fds.get(i);</span><br><span class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.poll(pollFds, -<span class="number">1</span>);<span class="comment">//æ— é™ç­‰å¾…èƒ½å¤Ÿè¿›è¡Œ I/O æ“ä½œ</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="comment">//è¯´æ˜æ²¡æœ‰æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚æˆ–æ•°æ®å¤„ç†è¯·æ±‚</span></span><br><span class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;<span class="comment">//å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚</span></span><br><span class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                peers.add(newPeer);</span><br><span class="line">                fds.add(newPeer.getFileDesciptor());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();<span class="comment">//å¤„ç†å®¢æˆ·ç«¯æ•°æ®å¤„ç†è¯·æ±‚ï¼Œåˆ›å»ºå¯¹åº”çš„è¿›ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (done) &#123;<span class="comment">//å¤„ç†å®Œæ¯•åˆ™è¿›è¡Œç§»é™¤</span></span><br><span class="line">                    peers.remove(i);</span><br><span class="line">                    fds.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚">å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</h4><p>å¯¹äº runOnce è€Œè¨€ä¸»è¦åšçš„å·¥ä½œæ˜¯ä»è¿æ¥ä¸­è¯»å–å‚æ•°ï¼Œç„¶åæ ¹æ®å‚æ•°åˆ›å»ºç›¸åº”çš„è¿›ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">runOnce</span><span class="params">()</span> <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line"></span><br><span class="line">    String args[];</span><br><span class="line">    Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        args = readArgumentList();<span class="comment">//è¯»å–å‚æ•°</span></span><br><span class="line">        descriptors = mSocket.getAncillaryFileDescriptors();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"IOException on command socket "</span> + ex.getMessage());</span><br><span class="line">        closeSocket();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// EOF reached.</span></span><br><span class="line">        closeSocket();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        parsedArgs = <span class="keyword">new</span> Arguments(args);<span class="comment">//æ„é€  Arguments å¯¹è±¡</span></span><br><span class="line">      </span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//åˆ›å»ºè¿›ç¨‹</span></span><br><span class="line">        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,</span><br><span class="line">                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,</span><br><span class="line">                parsedArgs.appDataDir);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">        logAndPrintError(newStderr, <span class="string">"Exception creating pipe"</span>, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        logAndPrintError(newStderr, <span class="string">"Invalid zygote arguments"</span>, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ZygoteSecurityException ex) &#123;</span><br><span class="line">        logAndPrintError(newStderr,</span><br><span class="line">                <span class="string">"Zygote security policy prevents request: "</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// in child</span></span><br><span class="line">            IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">            serverPipeFd = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//è¿›å…¥å­è¿›ç¨‹çš„å¤„ç†æµç¨‹</span></span><br><span class="line">            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// should never get here, the child is expected to either</span></span><br><span class="line">            <span class="comment">// throw ZygoteInit.MethodAndArgsCaller or exec().</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// in parent...pid of &lt; 0 means failure</span></span><br><span class="line">            IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">            childPipeFd = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(childPipeFd);</span><br><span class="line">        IoUtils.closeQuietly(serverPipeFd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“">æ€»ç»“</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬å¤§è‡´èƒ½å¤ŸçŸ¥æ™“ Zygote è¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹å’Œä¸»è¦ä½œç”¨äº†ï¼š</p><ol type="1"><li>ç³»ç»Ÿåœ¨å¯åŠ¨ Zygote çš„è¿‡ç¨‹ä¸­é¦–å…ˆå¯åŠ¨äº†è™šæ‹Ÿæœºï¼Œç„¶åé€šè¿‡ JNI è°ƒç”¨äº† ZygoteInit ä¸­çš„ main æ–¹æ³•ï¼Œç”±æ­¤ç³»ç»Ÿä» C++ çš„ FrameWork å±‚åˆ°äº† Java çš„ FrameWork å±‚ï¼Œä¹‹ååœ¨åˆ™æ³¨å†Œäº†ç”¨äºå’Œ ActvityManagerService é€šä¿¡çš„ Socketï¼Œå®Œæˆæ³¨å†Œä¹‹ååˆ™ä¼šè°ƒç”¨ startSystemServer å¯åŠ¨ SystemServer è¿›ç¨‹ï¼Œæœ€å Zygote è¿›ç¨‹å°†ä¼šé€šè¿‡ runSelectLoop å¯¹æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¿›è¡Œç›‘å¬ã€‚</li><li>æ€»çš„æ¥è¯´ Zygote çš„ä¸»è¦ä½œç”¨å¯åŠ¨ SystemServer è¿›ç¨‹ä»¥åŠæ ¹æ®å®¢æˆ·ç«¯çš„è¿æ¥åˆ›å»ºç›¸åº”çš„è¿›ç¨‹ã€‚</li></ol><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="http://blog.csdn.net/itachi85/article/details/55047104" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼ˆäºŒï¼‰è§£æZygoteè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹</a></li><li><a href="http://gityuan.com/2016/02/13/android-zygote/" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨-zygoteç¯‡</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;åœ¨ &lt;a href=&quot;/2017/10/28/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰/&quot; title=&quot;Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰&quot;&gt;Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰&lt;/a&gt;ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº† init è¿›ç¨‹æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Œæœ¬ç¯‡æ–‡ç« å°†ä¼šç»§ç»­åˆ†æ zygote å¯åŠ¨è¿‡ç¨‹ä»¥åŠä½œç”¨ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Androidè¿›é˜¶" scheme="http://www.ikroal.xyz/categories/Android%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="æºç åˆ†æ" scheme="http://www.ikroal.xyz/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Android å¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰ä¹‹ init è¿›ç¨‹</title>
    <link href="http://www.ikroal.xyz/2017/10/28/Android%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E7%AE%80%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://www.ikroal.xyz/2017/10/28/Androidå¯åŠ¨è¿‡ç¨‹ç®€æï¼ˆä¸€ï¼‰/</id>
    <published>2017-10-28T05:51:42.000Z</published>
    <updated>2019-05-13T09:12:40.090Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é—®é¢˜">é—®é¢˜</h2><p>åœ¨è¿›å…¥åˆ° Android å¯åŠ¨è¿‡ç¨‹ä¹‹å‰å…ˆè®©æˆ‘ä»¬æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ 1. Android ç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ 2. init ã€zygote è¿›ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å„è‡ªå‘æŒ¥äº†ä»€ä¹ˆä½œç”¨ï¼Ÿ 3. AMSã€PMS ç­‰è¿™äº›æœåŠ¡æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Ÿ 4. Launcher æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Ÿ</p><p>æ­¤ç¯‡æ–‡ç« å°†é’ˆå¯¹ init éƒ¨åˆ†ç»™å‡ºåˆ†æ<a id="more"></a></p><h2 id="å¯åŠ¨æµç¨‹ç®€è¿°">å¯åŠ¨æµç¨‹ç®€è¿°</h2><p>åœ¨äº†è§£ init éƒ¨åˆ†ä¹‹å‰ï¼Œé¦–å…ˆç®€å•ä»‹ç»ä¸‹ç³»ç»Ÿçš„å¯åŠ¨æµç¨‹ä»¥ä¾¿æŠ“ä½ä¸»çº¿ï¼Œå½“æˆ‘ä»¬é€šè¿‡ç”µæºé”®å¼€å¯ç³»ç»Ÿçš„æ—¶å€™ï¼Œç³»ç»Ÿé¦–å…ˆä¼šåŠ è½½ bootloader ç¨‹åºåˆ° RAM ä¸­ï¼Œç„¶åé€šè¿‡ bootloader å°†å†…æ ¸ç¨‹åºåŠ è½½åˆ° RAM ä¸­ï¼Œä¹‹åå†…æ ¸ç¨‹åºä¼šåˆ›å»ºinit è¿›ç¨‹ï¼Œåœ¨ init è¿›ç¨‹ä¸­ä¼šåˆ›å»º zygote è¿›ç¨‹ï¼Œè€Œ zygote è¿›ç¨‹åˆ™ä¼šåˆ›å»º DVM å¹¶ä¸”å¯åŠ¨ SystemServer è¿›ç¨‹ï¼Œé€šè¿‡SystemServer ç³»ç»Ÿä¼šå¯åŠ¨ä¸€ç³»åˆ—çš„æœåŠ¡ï¼ŒåŒ…æ‹¬å¸¸è§çš„ AMSã€PMS ç­‰ï¼Œæœ€åå†é€šè¿‡ AMS è¿›å…¥åˆ°æˆ‘ä»¬ç†ŸçŸ¥çš„ Launcher ç¨‹åºã€‚ æ‰€ä»¥æ•´ä¸ªæµç¨‹çš„å…³é”®ç‚¹åœ¨äº <strong>init è¿›ç¨‹å¦‚ä½•åˆ›å»º zygoteã€zygote è¿›ç¨‹å¦‚ä½•åˆ›å»º SystemServerã€SystemServer è¿›ç¨‹å¦‚ä½•å¯åŠ¨ AMSã€AMS å¦‚ä½•å¯åŠ¨ Launcherã€‚</strong></p><h2 id="init-å¯åŠ¨æµç¨‹åˆ†æ">init å¯åŠ¨æµç¨‹åˆ†æ</h2><p>ç”±äº bootloader å’Œå†…æ ¸ä¸æ˜¯å…³å¿ƒçš„é‡ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œåªæ˜¯ç®€å•ä»‹ç»å®ƒä»¬çš„ä½œç”¨ã€‚</p><h3 id="åŠ è½½è¿è¡Œ-bootloader">åŠ è½½è¿è¡Œ BootLoader</h3><p>åœ¨ç”µæºä¸Šç”µä¹‹åï¼ŒCPU ä¸­çš„æ“ä½œæ§åˆ¶å™¨å°†å‘å‡ºæ§åˆ¶ä¿¡å·ï¼Œå°†ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰çš„å†…å®¹é€è‡³åœ°å€å¯„å­˜å™¨ï¼ˆARï¼‰ï¼Œä¹‹åå¯åŠ¨å¯¹ä¸»å­˜çš„è¯»æ“ä½œï¼Œæœ€ç»ˆå°† BootLoader åŠ è½½åˆ° RAM å½“ä¸­ã€‚ç„¶å BootLoader å¼€å§‹æ‰§è¡Œï¼Œä¸»è¦è´Ÿè´£ç¡¬ä»¶çš„åˆå§‹åŒ–ï¼Œå°†å†…æ ¸ç¨‹åºåŠ è½½åˆ°å†…å­˜ã€‚</p><h3 id="init-è¿›ç¨‹çš„å¯åŠ¨">init è¿›ç¨‹çš„å¯åŠ¨</h3><p>å†…æ ¸å¯åŠ¨ä¹‹åå°†ä¼šåˆå§‹åŒ–è½¯ç¡¬ä»¶ç¯å¢ƒï¼ŒåŠ è½½é©±åŠ¨ç¨‹åºï¼ŒæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶ååˆ›å»º init è¿›ç¨‹ï¼Œinit ä½œä¸ºç³»ç»Ÿä¸­çš„ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œå…¶è¿›ç¨‹å·ä¸º 1ï¼Œåœ¨åˆ›å»º init è¿›ç¨‹ä¹‹æ—¶ï¼Œç³»ç»Ÿä¼šæ‰§è¡Œä½äº <strong>system/core/init </strong>ä¸‹çš„ init.cpp ç¨‹åº</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">    <span class="comment">//åˆ›å»ºç”¨æˆ·ç©ºé—´ç›®å½•å¹¶æŒ‚è½½</span></span><br><span class="line">    <span class="keyword">if</span> (is_first_stage) &#123;</span><br><span class="line">        mount(<span class="string">"tmpfs"</span>, <span class="string">"/dev"</span>, <span class="string">"tmpfs"</span>, MS_NOSUID, <span class="string">"mode=0755"</span>);</span><br><span class="line">        mkdir(<span class="string">"/dev/pts"</span>, <span class="number">0755</span>);</span><br><span class="line">        mkdir(<span class="string">"/dev/socket"</span>, <span class="number">0755</span>);</span><br><span class="line">        mount(<span class="string">"devpts"</span>, <span class="string">"/dev/pts"</span>, <span class="string">"devpts"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">define</span> MAKE_STR(x) __STRING(x)</span></span><br><span class="line">        mount(<span class="string">"proc"</span>, <span class="string">"/proc"</span>, <span class="string">"proc"</span>, <span class="number">0</span>, <span class="string">"hidepid=2,gid="</span> MAKE_STR(AID_READPROC));</span><br><span class="line">        mount(<span class="string">"sysfs"</span>, <span class="string">"/sys"</span>, <span class="string">"sysfs"</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">    signal_handler_init();</span><br><span class="line"></span><br><span class="line">    property_load_boot_defaults();</span><br><span class="line">    export_oem_lock_status();</span><br><span class="line">    <span class="comment">//å¯åŠ¨å±æ€§æœåŠ¡</span></span><br><span class="line">    start_property_service();</span><br><span class="line">  </span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">    Action::set_function_map(&amp;function_map);</span><br><span class="line"></span><br><span class="line">    Parser&amp; parser = Parser::GetInstance();</span><br><span class="line">    parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</span><br><span class="line">    parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</span><br><span class="line">    parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</span><br><span class="line">    <span class="comment">//è§£æ init.rc æ–‡ä»¶</span></span><br><span class="line">    parser.ParseConfig(<span class="string">"/init.rc"</span>);</span><br><span class="line">   ...</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° init è¿›ç¨‹ä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š<strong>åˆ›å»ºç”¨æˆ·ç©ºé—´æ–‡ä»¶å¤¹å¹¶æŒ‚è½½ã€å¯åŠ¨å±æ€§æœåŠ¡ã€è§£æä½äº systemæ–‡ä»¶å¤¹ä¸‹çš„ init.rc æ–‡ä»¶</strong>ã€‚ è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨è§£æ init.rc æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œå› ä¸º zygote è¿›ç¨‹å°±æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åˆ›å»ºçš„ã€‚</p><h4 id="android-init-language">Android Init Language</h4><p>ç”±äº init.rc æ˜¯ä¸€ä¸ªç”¨ Android åˆå§‹åŒ–è¯­è¨€ï¼ˆAILï¼‰ç¼–å†™çš„æ–‡ä»¶ï¼Œä¸ºäº†æ›´å¥½çš„ç†è§£ rc æ–‡ä»¶çš„è§£æè¿‡ç¨‹éœ€è¦äº†è§£ä¸€éƒ¨åˆ† AIL è¯­æ³•ã€‚ AIL ä¸»è¦æœ‰äº”ç§ç±»å‹è¯­å¥ Actionsã€Commandsã€Servicesã€Optionsã€Importsï¼Œåœ¨ AIL ä¸­æ¯ä¸ªéƒ¨åˆ†(è¯­å¥å—)è¡¨ç¤ºä¸ºä¸€ä¸ª Sectionï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">on boot</span><br><span class="line">    ifup lo</span><br><span class="line">    hostname localhost</span><br><span class="line">    domainname localdomain</span><br></pre></td></tr></table></figure><p>äº”ç§è¯­å¥ä¸­åªæœ‰ Actionsã€Servicesã€Import å¯ä»¥ç”¨äºç¡®å®šä¸€ä¸ª Sectionã€‚å…¶ä¸­ Actions ç”±ä¸€ç³»åˆ— command ç»„æˆï¼ŒActions æ‹¥æœ‰ä¸€ä¸ª trigger ç”¨äºç¡®å®šä½•æ—¶æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">on &lt;trigger&gt;</span><br><span class="line">    &lt;command&gt;</span><br><span class="line">    &lt;command&gt;</span><br><span class="line">    &lt;command&gt;</span><br><span class="line"> </span><br><span class="line">on early-init //è§¦å‘å™¨ early-init</span><br><span class="line">    write /proc/1/oom_score_adj -1000 //command</span><br><span class="line">    write /proc/sys/kernel/sysrq 0</span><br></pre></td></tr></table></figure><p>Services ç”±ä¸€äº› option ç»„æˆï¼Œå…¶åœ¨åˆå§‹åŒ–çš„æ—¶å€™å¯åŠ¨ï¼Œå¹¶å¯ä»¥åœ¨é€€å‡ºåé‡å¯ï¼ˆå¯é€‰ï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*  //æœåŠ¡åã€æ‰§è¡Œè·¯å¾„ã€å‚æ•°</span><br><span class="line">        &lt;option&gt;  </span><br><span class="line">        &lt;option&gt; </span><br><span class="line">        </span><br><span class="line">service ueventd /sbin/ueventd </span><br><span class="line">    class core</span><br><span class="line">    critical</span><br><span class="line">    seclabel u:r:ueventd:s0</span><br></pre></td></tr></table></figure><p>Services å®šä¹‰äº†è‡ªèº«çš„æœåŠ¡åã€æ‰§è¡Œè·¯å¾„ä»¥åŠæ‰§è¡Œæ—¶ä¼ å…¥çš„å‚æ•°ï¼Œoption ç”¨äºæŒ‡å®šä½•æ—¶å’Œæ€æ ·å¯åŠ¨ serviceï¼Œå…³äºä½•æ—¶å¯åŠ¨è¿™é‡Œè¿›è¡Œä¸€ä¸‹è¯´æ˜ï¼ŒActions ä¸­æœ‰ä¸€æ¡å‘½ä»¤æ˜¯ class_start <æœåŠ¡ç±»åˆ«å> ç”¨äºå¯åŠ¨æ‰€æœ‰æœªè¿è¡Œçš„ç›¸åŒç±»åˆ«çš„ serviceï¼Œè€Œ option å¯ä»¥é€šè¿‡ class <ç±»åˆ«å> å¯¹ service çš„ç±»åˆ«åè¿›è¡ŒæŒ‡å®šã€‚<strong>æ‰€ä»¥ service çš„å¯åŠ¨ä¸€èˆ¬æ˜¯é€šè¿‡ action è§¦å‘ä¹‹åæ‰§è¡Œ class_start å‘½ä»¤è¿›è¡Œå¯åŠ¨çš„ã€‚</strong> AIL çš„ä»‹ç»å°±åˆ°è¿™äº†ï¼Œ<strong>å¦‚æœæƒ³è¦è¯¦ç»†äº†è§£è¯·é˜…è¯» system/core/init ä¸‹çš„ readme.txt æ–‡ä»¶</strong></ç±»åˆ«å></æœåŠ¡ç±»åˆ«å></p><h4 id="init.rc-è§£æ">init.rc è§£æ</h4><p>system/core/rootdir/init.rc ç°åœ¨æ¥ç€åˆ†æ init.rc æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶çš„é¦–éƒ¨å¯ä»¥çœ‹åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> /init.environ.rc</span><br><span class="line"><span class="keyword">import</span> /init.usb.rc</span><br><span class="line"><span class="keyword">import</span> /init.$&#123;ro.hardware&#125;.rc</span><br><span class="line"><span class="keyword">import</span> /init.usb.configfs.rc</span><br><span class="line"><span class="keyword">import</span> /init.$&#123;ro.zygote&#125;.rc</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°éœ€è¦å¯åŠ¨çš„ zygoteï¼Œä½†æ˜¯ä¸å…¶å®ƒå¼•å…¥çš„ rc æ–‡ä»¶ç›¸æ¯” zygote éƒ¨åˆ†å¹¶æ²¡æœ‰ä½¿ç”¨ç¡®å®šçš„å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨ ${ro.zygote} å˜é‡å»æ›¿ä»£ï¼Œè¿™æ˜¯å› ä¸ºä» Android åœ¨ 5.0 ä»¥åå¼€å§‹æ”¯æŒ 64 ä½ç¨‹åºï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®ç³»ç»Ÿä¸­ ro.zygote å±æ€§çš„å€¼åŠ¨æ€å¼•å…¥ã€‚ro.zygote çš„å€¼å¯ä»¥é€šè¿‡ adb shell getprop è¿›è¡ŒæŸ¥è¯¢ï¼Œæˆ‘çš„æ‰‹æœºæŸ¥è¯¢ç»“æœæ˜¯ï¼š</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/zygote-value.png"></p><p>è¿™è¯´æ˜æ‰‹æœºä¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ app_process64 (ä¸»æ¨¡å¼)ã€app_process32ï¼Œé€šè¿‡ adb shell ps | grep zygote å¯ä»¥çœ‹åˆ°ç¡®å®å­˜åœ¨ä¸¤ä¸ª zygote è¿›ç¨‹</p><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/zygote-process.png"></p><p>æ¥ç€æŸ¥çœ‹ä¸ init.rc åŒä¸€ç›®å½•ä¸‹çš„ init.zygote64_32.rc æ–‡ä»¶ system/core/rootdir/init.zygote64_32.rc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">socket</span> <span class="title">zygote</span> <span class="title">stream</span> 660 <span class="title">root</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">android_power</span>/<span class="title">request_state</span> <span class="title">wake</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">write</span> /<span class="title">sys</span>/<span class="title">power</span>/<span class="title">state</span> <span class="title">on</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">audioserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">cameraserver</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">media</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">netd</span></span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">foreground</span>/<span class="title">tasks</span> /<span class="title">sys</span>/<span class="title">fs</span>/<span class="title">cgroup</span>/<span class="title">stune</span>/<span class="title">foreground</span>/<span class="title">tasks</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">service</span> <span class="title">zygote_secondary</span> /<span class="title">system</span>/<span class="title">bin</span>/<span class="title">app_process32</span> -<span class="title">Xzygote</span> /<span class="title">system</span>/<span class="title">bin</span> --<span class="title">zygote</span> --<span class="title">socket</span>-<span class="title">name</span></span>=zygote_secondary</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">main</span></span></span><br><span class="line"><span class="class">    <span class="title">socket</span> <span class="title">zygote_secondary</span> <span class="title">stream</span> 660 <span class="title">root</span> <span class="title">system</span></span></span><br><span class="line"><span class="class">    <span class="title">onrestart</span> <span class="title">restart</span> <span class="title">zygote</span></span></span><br><span class="line"><span class="class">    <span class="title">writepid</span> /<span class="title">dev</span>/<span class="title">cpuset</span>/<span class="title">foreground</span>/<span class="title">tasks</span> /<span class="title">dev</span>/<span class="title">stune</span>/<span class="title">foreground</span>/<span class="title">tasks</span></span></span><br></pre></td></tr></table></figure><p>å‰æ–‡è¯´è¿‡ service çš„å¯åŠ¨å’Œç±»åˆ«åç›¸å…³ï¼Œè¿™é‡Œä¸¤ä¸ª zygote service çš„ç±»åˆ«åéƒ½æ˜¯ mainï¼Œæ‰€ä»¥è¦æƒ³çŸ¥é“ zygote æ€ä¹ˆè¢«å¯åŠ¨çš„æˆ‘ä»¬å¯ä»¥åœ¨ init.rc ä¸­æœç´¢ class_start mainï¼Œå¯ä»¥å‘ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">on nonencrypted</span><br><span class="line">    # A/B update verifier that marks a successful boot.</span><br><span class="line">    exec - root -- /system/bin/update_verifier nonencrypted</span><br><span class="line">    class_start main</span><br><span class="line">    class_start late_start</span><br></pre></td></tr></table></figure><p>ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å½“ nonencrypted è¿™ä¸ªè§¦å‘å™¨è¢«è§¦å‘çš„æ—¶å€™ zygote å°±ä¼šè¢«å¯åŠ¨ï¼Œæ‰€ä»¥å¯åŠ¨ zygote çš„é—®é¢˜å°±è½¬å˜ä¸º<strong>è¿™ä¸ªè§¦å‘å™¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿclass_start å¯¹åº”çš„å¤„ç†å‡½æ•°æ˜¯ä»€ä¹ˆï¼Ÿ</strong>è¦æƒ³çŸ¥é“ç­”æ¡ˆï¼Œå¿…é¡»å›åˆ° init.cpp çš„è§£æè¿‡ç¨‹å½“ä¸­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Parser&amp; parser = Parser::GetInstance();</span><br><span class="line">parser.AddSectionParser(<span class="string">"service"</span>,<span class="built_in">std</span>::make_unique&lt;ServiceParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"on"</span>, <span class="built_in">std</span>::make_unique&lt;ActionParser&gt;());</span><br><span class="line">parser.AddSectionParser(<span class="string">"import"</span>, <span class="built_in">std</span>::make_unique&lt;ImportParser&gt;());</span><br><span class="line">parser.ParseConfig(<span class="string">"/init.rc"</span>);</span><br></pre></td></tr></table></figure><p>init.rc äº¤ç”±ä¸€ä¸ª Parser å¯¹è±¡è¿›è¡Œè§£æï¼Œè€Œ Parser çš„å®ç°åœ¨ system/core/init/init_parser.cpp æ–‡ä»¶ä¸­ï¼Œè®©æˆ‘ä»¬è¿›å…¥åˆ° init_parser.cpp ä¸­æŸ¥çœ‹ AddSectionParser çš„å®ç°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Parser::AddSectionParser(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name,</span><br><span class="line">                              <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;SectionParser&gt; parser) &#123;</span><br><span class="line">    section_parsers_[name] = <span class="built_in">std</span>::move(parser);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//init_parser.h ä¸­ section_parsers_ çš„å®šä¹‰</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;SectionParser&gt;&gt; section_parsers_;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ª parser æœ€ç»ˆè¢«ä¿å­˜åœ¨ section_parsers_ ä¸­ï¼Œsection_parsers_ æ˜¯ä»€ä¹ˆï¼ŸæŸ¥çœ‹ init_parser.h ä¸­çš„å®šä¹‰å¯ä»¥çŸ¥é“ï¼Œsection_parsers_ æ˜¯ä¸€ä¸ª map é›†åˆï¼Œæ‰€ä»¥ section_parsers_ çš„ä½œç”¨æ˜¯å°† parser ä¸å¯¹åº”çš„ Section è¿›è¡Œç»‘å®šã€‚ åœ¨æ·»åŠ å®Œæ‰€æœ‰çš„ parser ä¹‹åå°±ä¼šè°ƒç”¨ Parser çš„ ParseConfig æ–¹æ³•</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Parser::ParseConfig(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_dir(path.c_str())) &#123;</span><br><span class="line">        <span class="keyword">return</span> ParseConfigDir(path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ParseConfigFile(path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ParseConfig ä¸­ä¼šå¯¹ path è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯ç›®å½•åˆ™è°ƒç”¨ ParseConfigDir è¿›è¡Œé€’å½’ç„¶åå†é€šè¿‡ ParseConfigFile è¿›è¡Œè§£æã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Parser::ParseConfigDir(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">    INFO(<span class="string">"Parsing directory %s...\n"</span>, path.c_str());</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;DIR, <span class="keyword">int</span>(*)(DIR*)&gt; config_dir(opendir(path.c_str()), closedir);</span><br><span class="line">    <span class="keyword">if</span> (!config_dir) &#123;</span><br><span class="line">        ERROR(<span class="string">"Could not import directory '%s'\n"</span>, path.c_str());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    dirent* current_file;</span><br><span class="line">    <span class="keyword">while</span> ((current_file = readdir(config_dir.get()))) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> current_path =</span><br><span class="line">            android::base::StringPrintf(<span class="string">"%s/%s"</span>, path.c_str(), current_file-&gt;d_name);</span><br><span class="line">        <span class="comment">// Ignore directories and only process regular files.</span></span><br><span class="line">        <span class="keyword">if</span> (current_file-&gt;d_type == DT_REG) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ParseConfigFile(current_path)) &#123; <span class="comment">//è°ƒç”¨ ParseConfigFile è¿›è¡Œè§£æ</span></span><br><span class="line">                ERROR(<span class="string">"could not import file '%s'\n"</span>, current_path.c_str());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨ ParseConfigFile ä¸­é€šè¿‡ ParseData è¿›è¡Œè§£æ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Parser::ParseConfigFile(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; path) &#123;</span><br><span class="line">    INFO(<span class="string">"Parsing file %s...\n"</span>, path.c_str());</span><br><span class="line">    Timer t;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> data;</span><br><span class="line">  <span class="comment">//ä» rc æ–‡ä»¶ä¸­è¯»å–å†…å®¹ä¿å­˜åœ¨ data ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!read_file(path.c_str(), &amp;data)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    data.push_back(<span class="string">'\n'</span>); <span class="comment">// <span class="doctag">TODO:</span> fix parse_config.</span></span><br><span class="line">    ParseData(path, data); <span class="comment">//è°ƒç”¨ ParseData è¿›è¡Œè§£æ</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ParseData è§£æè¿‡ç¨‹å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Parser::ParseData(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; data) &#123;</span><br><span class="line">    <span class="comment">//<span class="doctag">TODO:</span> Use a parser with const input and remove this copy</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt; data_copy(data.begin(), data.end()); <span class="comment">//å°† rc ä¸­çš„å†…å®¹ä¿å­˜åœ¨ vector ä¸­ä¾¿äºé€ä¸ªå­—ç¬¦è¿›è¡Œè§£æ</span></span><br><span class="line">    data_copy.push_back(<span class="string">'\0'</span>);</span><br><span class="line">  </span><br><span class="line">    parse_state state;</span><br><span class="line">    state.filename = filename.c_str();</span><br><span class="line">    state.line = <span class="number">0</span>;</span><br><span class="line">    state.ptr = &amp;data_copy[<span class="number">0</span>];</span><br><span class="line">    state.nexttoken = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    SectionParser* section_parser = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; args; <span class="comment">//å­˜æ”¾çš„æ˜¯æ¯è¡Œçš„å†…å®¹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (next_token(&amp;state)) &#123;</span><br><span class="line">        <span class="keyword">case</span> T_EOF:</span><br><span class="line">            <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">                section_parser-&gt;EndSection();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">case</span> T_NEWLINE:</span><br><span class="line">            state.line++;</span><br><span class="line">            <span class="comment">//å¦‚æœ args ä¸ºç©ºåˆ™ä¸è¿›è¡Œè§£æï¼ˆrc æ–‡ä»¶ä¸­é—´å­˜åœ¨ç©ºè¡Œï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (args.empty()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯ä¸€ä¸ª section çš„èµ·å§‹ä½ç½®ï¼ˆé€šè¿‡èƒ½ä¸èƒ½è·å¾—è§£æå™¨ï¼Œå¯ä»¥åˆ¤æ–­ args[0] æ˜¯ä¸æ˜¯ serviceã€onã€import å…¶ä¸­ä¸€ä¸ªï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (section_parsers_.count(args[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="keyword">if</span> (section_parser) &#123;</span><br><span class="line">                  <span class="comment">//å¦‚æœä¸Šæ¬¡å­˜åœ¨è§£æåˆ™ç»“æŸè§£æ</span></span><br><span class="line">                    section_parser-&gt;EndSection();</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="comment">//å–å‡ºå¯¹åº”çš„è§£æå™¨</span></span><br><span class="line">                section_parser = section_parsers_[args[<span class="number">0</span>]].get();</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</span><br><span class="line">              <span class="comment">//è¿›è¡Œ Section è§£æ</span></span><br><span class="line">                <span class="keyword">if</span> (!section_parser-&gt;ParseSection(args, &amp;ret_err)) &#123;</span><br><span class="line">                    parse_error(&amp;state, <span class="string">"%s\n"</span>, ret_err.c_str());</span><br><span class="line">                    section_parser = <span class="literal">nullptr</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (section_parser) &#123; <span class="comment">//ä¸æ˜¯çš„è¯è¯´æ˜ args ä¸­æ˜¯ä¸€ä¸ª section çš„å­å—ï¼Œåˆ™è¿›è¡Œ Line è§£æ</span></span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">string</span> ret_err;</span><br><span class="line">                <span class="keyword">if</span> (!section_parser-&gt;ParseLineSection(args, state.filename,</span><br><span class="line">                                                      state.line, &amp;ret_err)) &#123;</span><br><span class="line">                    parse_error(&amp;state, <span class="string">"%s\n"</span>, ret_err.c_str());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è§£æå®Œæˆåæ¸…ç©º</span></span><br><span class="line">            args.clear();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> T_TEXT:</span><br><span class="line">            args.emplace_back(state.text);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ParseData ä¸­é€šè¿‡è°ƒç”¨ system/core/init/parser.cpp ä¸­çš„ next_token å‡½æ•°å¯¹ rc å†…å®¹è¿›è¡Œåˆ†æï¼Œå¦‚æœæ˜¯ T_TEXT åˆ™ä¼šä¿å­˜åœ¨ args ä¸­ï¼Œå¦‚æœæ˜¯ T_NEWLINE åˆ™ä¼šäº¤ç”±å¯¹åº”çš„è§£æå™¨è¿›è¡Œè§£æã€‚init.rc çš„å¤§è‡´è§£æè¿‡ç¨‹å¦‚æ­¤ï¼Œä½†æ˜¯åˆ°è¿™é‡Œæˆ‘ä»¬ä¾æ—§æ²¡èƒ½æ‰¾åˆ°æ‰€éœ€è¦çš„ç­”æ¡ˆï¼Œæ‰€ä»¥éœ€è¦ç»§ç»­æŸ¥çœ‹ ActionParser å’Œ ServiceParser çš„è§£æè¿‡ç¨‹ã€‚</p><h4 id="actionparser-è§£æè¿‡ç¨‹">ActionParser è§£æè¿‡ç¨‹</h4><p>ActionParser ä½äº system/core/init/action.cpp ä¸­ï¼Œä»å‰é¢çš„è§£æè¿‡ç¨‹æ¥çœ‹ï¼Œæœ€åçš„è§£ææ€»æ˜¯è°ƒç”¨äº†å¯¹åº” parser çš„ ParseSectionã€ParseLineSection ä»¥åŠ EndSectionï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸»è¦çœ‹ä¸‹è¿™ä¸¤ä¸ªéƒ¨åˆ† ParseSection çš„ä¸»è¦å·¥ä½œæ˜¯åˆ›å»º Action å¯¹è±¡ï¼Œä¸ºå¯¹è±¡æ·»åŠ è§¦å‘å™¨ï¼Œå¹¶å°† action_ ç§»åŠ¨è‡³å½“å‰ Action å¯¹è±¡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ActionParser::ParseSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">                                <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; triggers(args.begin() + <span class="number">1</span>, args.end());</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> action = <span class="built_in">std</span>::make_unique&lt;Action&gt;(<span class="literal">false</span>);</span><br><span class="line">  <span class="comment">//ä¸º action å¢åŠ è§¦å‘å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (!action-&gt;InitTriggers(triggers, err)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//å°† aciton_ æŒ‡é’ˆç§»åŠ¨åˆ°å½“å‰çš„ action</span></span><br><span class="line">    action_ = <span class="built_in">std</span>::move(action);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//action_ åœ¨ action.h ä¸­çš„å®šä¹‰</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Action&gt; action_;</span><br></pre></td></tr></table></figure><p>ParseLineSection çš„ä¸»è¦å·¥ä½œä¸ºæŸ¥æ‰¾å¯¹åº” command çš„å¤„ç†å‡½æ•°ï¼Œå°†åˆ›å»ºçš„ Command å¯¹è±¡æ·»åŠ åˆ°åˆ°commands_ï¼Œç”±äº commands_ æ˜¯ Action çš„ä¸€ä¸ªåŸŸï¼Œæ‰€ä»¥å®é™…ä¸Š ParseLineSection åœ¨å¡«å……å½“å‰ Action å¯¹è±¡çš„åŸŸã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ActionParser::ParseLineSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">                                    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line,</span><br><span class="line">                                    <span class="built_in">std</span>::<span class="built_in">string</span>* err) <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="comment">//å°†è§£æçš„ command å¢åŠ åˆ°å½“å‰ action çš„ commands_ ä¸­</span></span><br><span class="line">    <span class="keyword">return</span> action_ ? action_-&gt;AddCommand(args, filename, line, err) : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Action::AddCommand(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">                        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line, <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">//æŸ¥æ‰¾å¯¹åº”çš„ command çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> function = function_map_-&gt;FindFunction(args[<span class="number">0</span>], args.size() - <span class="number">1</span>, err);</span><br><span class="line">    <span class="keyword">if</span> (!function) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    AddCommand(function, args, filename, line);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Action::AddCommand(BuiltinFunction f,</span><br><span class="line">                        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">                        <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line) &#123;</span><br><span class="line">  <span class="comment">//commands_ å¢åŠ  command å’Œå¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    commands_.emplace_back(f, args, filename, line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//commands_ åœ¨ action.h ä¸­çš„å®šä¹‰</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Command&gt; commands_;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Command åœ¨ action.h ä¸­çš„å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Command</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Command(BuiltinFunction f, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">            <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">InvokeFunc</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">BuildCommandString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">BuildSourceString</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    BuiltinFunction func_;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; args_;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> filename_;</span><br><span class="line">    <span class="keyword">int</span> line_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>EndSection çš„ä¸»è¦å·¥ä½œæ˜¯å°†è§£æå®Œæˆçš„ action ï¼ˆåŸŸå¡«å……å®Œæ¯•çš„ Action å¯¹è±¡ï¼‰æ·»åŠ åˆ° ActionManager çš„ acitons_ ä¸­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ActionParser::EndSection() &#123;</span><br><span class="line">    <span class="keyword">if</span> (action_ &amp;&amp; action_-&gt;NumCommands() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ActionManager::GetInstance().AddAction(<span class="built_in">std</span>::move(action_));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ActionManager::AddAction(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Action&gt; action) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_action_it != actions_.end()) &#123;</span><br><span class="line">        (*old_action_it)-&gt;CombineAction(*action);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//å°†è§£æä¹‹åçš„ action å¯¹è±¡å¢åŠ åˆ° actions_ é“¾è¡¨ä¸­ï¼Œç”¨äºéå†æ‰§è¡Œã€‚</span></span><br><span class="line">        actions_.emplace_back(<span class="built_in">std</span>::move(action));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ActionManager åœ¨ action.h ä¸­çš„å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActionManager</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">static</span> ActionManager&amp; <span class="title">GetInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddAction</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Action&gt; action)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">QueueEventTrigger</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; trigger)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">QueuePropertyTrigger</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; value)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">QueueAllPropertyTriggers</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">QueueBuiltinAction</span><span class="params">(BuiltinFunction func, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ExecuteOneCommand</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">HasMoreCommands</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DumpState</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ActionManager();</span><br><span class="line"></span><br><span class="line">    ActionManager(ActionManager <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="keyword">operator</span>=(ActionManager <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Action&gt;&gt; actions_; <span class="comment">//actions_ çš„å®šä¹‰</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">queue</span>&lt;<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Trigger&gt;&gt; trigger_queue_;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">queue</span>&lt;<span class="keyword">const</span> Action*&gt; current_executing_actions_;</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">size_t</span> current_command_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä»¥ä¸Šåˆ†ææˆ‘ä»¬èƒ½å¤ŸçŸ¥é“ class_start çš„å¤„ç†å‡½æ•°å’Œ function_map_ ç›¸å…³ï¼ŒæŸ¥çœ‹ function_map_ åœ¨ action.h ä¸­çš„å®šä¹‰å¯ä»¥çœ‹åˆ°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> KeywordMap&lt;BuiltinFunction&gt;* function_map_;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set_function_map</span><span class="params">(<span class="keyword">const</span> KeywordMap&lt;BuiltinFunction&gt;* function_map)</span> </span>&#123;</span><br><span class="line">    function_map_ = function_map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¦æƒ³çŸ¥é“å¤„ç†å‡½æ•°æ˜¯ä»€ä¹ˆåªéœ€è¦çŸ¥é“ set_function_map åœ¨å“ªé‡Œè°ƒç”¨ï¼Ÿè®©æˆ‘ä»¬å†æ¬¡å›åˆ° init.cpp ä¸­ï¼Œå¯ä»¥çœ‹åˆ°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> BuiltinFunctionMap function_map;</span><br><span class="line">Action::set_function_map(&amp;function_map);</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ° BuiltinFunctionMapï¼ŒBuiltinFunctionMap çš„å®ç°æˆ‘ä»¬å¯ä»¥åœ¨ builtins.cpp ä¸­æ‰¾åˆ°ï¼Œå…¶å…·ä½“çš„å®ç° system/core/init/builtins.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BuiltinFunctionMap::Map&amp; BuiltinFunctionMap::<span class="built_in">map</span>() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> kMax = <span class="built_in">std</span>::numeric_limits&lt;<span class="built_in">std</span>::<span class="keyword">size_t</span>&gt;::max();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map builtin_functions = &#123;</span><br><span class="line">        ...</span><br><span class="line">        &#123;<span class="string">"class_start"</span>,             &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_class_start&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"class_stop"</span>,              &#123;<span class="number">1</span>,     <span class="number">1</span>,    do_class_stop&#125;&#125;,</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> builtin_functions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œå°±å¯ä»¥ç¡®å®š class_start å¯¹åº”çš„å¤„ç†å‡½æ•°æ˜¯ do_class_startï¼Œdo_class_start ä¹Ÿå¯åœ¨ builtins.cpp ä¸­æ‰¾åˆ°ã€‚ ç®€å•æ€»ç»“ä¸‹è§£æ Action çš„è¿‡ç¨‹ï¼Œ<strong>å®é™…ä¸Šæ˜¯åˆ›å»ºä¸€ä¸ª Action å¯¹è±¡ï¼Œç„¶åä¸º Action å¯¹è±¡æ·»åŠ  Trigger ä»¥åŠå¯¹åº”çš„ Commandï¼Œå…¶ä¸­åœ¨æ·»åŠ  Command çš„è¿‡ç¨‹ä¸­è¿˜ä¸º Command æŒ‡å®šäº†å¤„ç†å‡½æ•°ï¼Œæœ€ååœ¨å°† Action å¯¹è±¡å¢åŠ åˆ° ActionManager vector ç±»å‹çš„ actions_ é“¾è¡¨å½“ä¸­å»ã€‚</strong> #### ServiceParser è§£æè¿‡ç¨‹</p><p>ä¸å‰æ–‡ä¸€è‡´ï¼Œæ¥ç€çœ‹é‚£ä¸‰ä¸ªå‡½æ•° ParseSection çš„ä¸»è¦å·¥ä½œæ˜¯åˆ›å»º Service å¯¹è±¡ï¼Œå°† service_ ç§»åŠ¨è‡³å½“å‰ Service å¯¹è±¡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ServiceParser::ParseSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">                                 <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">//è·å–æœåŠ¡å</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; name = args[<span class="number">1</span>];</span><br><span class="line">    ...</span><br><span class="line">  <span class="comment">//ä¿å­˜æœåŠ¡åå¤–çš„å‚æ•°ï¼ˆå¦‚æ‰§è¡Œè·¯å¾„ç­‰ï¼‰</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; str_args(args.begin() + <span class="number">2</span>, args.end());</span><br><span class="line">  <span class="comment">//å°† service_ æŒ‡é’ˆæŒ‡å‘å½“å‰ Service å¯¹è±¡</span></span><br><span class="line">    service_ = <span class="built_in">std</span>::make_unique&lt;Service&gt;(name, <span class="string">"default"</span>, str_args);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//service_ åœ¨ service.h ä¸­çš„å®šä¹‰</span></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;Service&gt; service_;</span><br></pre></td></tr></table></figure><p>ParseLineSection çš„ä¸»è¦å·¥ä½œæ˜¯ä¸º Service ä¸­æ¯ä¸ª option æŒ‡å®šå¤„ç†å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> ServiceParser::ParseLineSection(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args,</span><br><span class="line">                                     <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; filename, <span class="keyword">int</span> line,</span><br><span class="line">                                     <span class="built_in">std</span>::<span class="built_in">string</span>* err) <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="comment">//ä¸º Service ä¸­çš„æ¯ä¸€ä¸ª Option æŒ‡å®šå¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> service_ ? service_-&gt;HandleLine(args, err) : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> Service::HandleLine(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args, <span class="built_in">std</span>::<span class="built_in">string</span>* err) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> OptionHandlerMap handler_map;</span><br><span class="line">  <span class="comment">//å¯»æ‰¾å¯¹åº” option çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">auto</span> handler = handler_map.FindFunction(args[<span class="number">0</span>], args.size() - <span class="number">1</span>, err);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">this</span>-&gt;*handler)(args, err);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EndSection çš„ä¸»è¦å·¥ä½œæ˜¯å°†è§£æå®Œæˆçš„ service ï¼ˆåŸŸå¡«å……å®Œæ¯•çš„ Service å¯¹è±¡ï¼‰æ·»åŠ åˆ° ServiceManager çš„ services_ ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ServiceParser::EndSection() &#123;</span><br><span class="line">    <span class="keyword">if</span> (service_) &#123;</span><br><span class="line">        ServiceManager::GetInstance().AddService(std::move(service_));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ServiceManager::AddService(std::unique_ptr&lt;Service&gt; service) &#123;</span><br><span class="line">    Service* old_service = FindServiceByName(service-&gt;name());</span><br><span class="line">    <span class="keyword">if</span> (old_service) &#123;</span><br><span class="line">        ERROR(<span class="string">"ignored duplicate definition of service '%s'"</span>,</span><br><span class="line">              service-&gt;name().c_str());</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//å°†è§£æä¹‹å service å¯¹è±¡å¢åŠ åˆ° services_ é“¾è¡¨ä¸­</span></span><br><span class="line">    services_.emplace_back(std::move(service));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ServiceManager åœ¨ service.h ä¸­çš„å®šä¹‰</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceManager</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">static</span> ServiceManager&amp; GetInstance();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">AddService</span><span class="params">(std::unique_ptr&lt;Service&gt; service)</span></span>;</span><br><span class="line">    Service* MakeExecOneshotService(<span class="keyword">const</span> std::vector&lt;std::string&gt;&amp; args);</span><br><span class="line">    Service* FindServiceByName(<span class="keyword">const</span> std::string&amp; name) <span class="keyword">const</span>;</span><br><span class="line">    Service* FindServiceByPid(pid_t pid) <span class="keyword">const</span>;</span><br><span class="line">    Service* FindServiceByKeychord(<span class="keyword">int</span> keychord_id) <span class="keyword">const</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ForEachService</span><span class="params">(std::function&lt;<span class="keyword">void</span>(Service*)</span>&gt; callback) <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ForEachServiceInClass</span><span class="params">(<span class="keyword">const</span> std::string&amp; classname,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">void</span> (*func)</span><span class="params">(Service* svc)</span>) <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ForEachServiceWithFlags</span><span class="params">(unsigned matchflags,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">void</span> (*func)</span><span class="params">(Service* svc)</span>) <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">ReapAnyOutstandingChildren</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">RemoveService</span><span class="params">(<span class="keyword">const</span> Service&amp; svc)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">DumpState</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    ServiceManager();</span><br><span class="line">    <span class="function">bool <span class="title">ReapOneProcess</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> exec_count_; <span class="comment">// Every service needs a unique name.</span></span><br><span class="line">    std::vector&lt;std::unique_ptr&lt;Service&gt;&gt; services_; <span class="comment">//services_ çš„å®šä¹‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„å¯ä»¥çœ‹ä¸‹ option çš„å¤„ç†å‡½æ•°ï¼Œè™½ç„¶ OptionHandlerMap ä¸å¯åŠ¨ zygote æ— å…³ï¼Œä½†æ˜¯è¿˜æ˜¯çœ‹ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Service::OptionHandlerMap::Map&amp; Service::OptionHandlerMap::<span class="built_in">map</span>() <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="built_in">std</span>::<span class="keyword">size_t</span> kMax = <span class="built_in">std</span>::numeric_limits&lt;<span class="built_in">std</span>::<span class="keyword">size_t</span>&gt;::max();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> Map option_handlers = &#123;</span><br><span class="line">        &#123;<span class="string">"class"</span>,       &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleClass&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"console"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleConsole&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"critical"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleCritical&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"disabled"</span>,    &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleDisabled&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"group"</span>,       &#123;<span class="number">1</span>,     NR_SVC_SUPP_GIDS + <span class="number">1</span>, &amp;Service::HandleGroup&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"ioprio"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleIoprio&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"keycodes"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleKeycodes&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"oneshot"</span>,     &#123;<span class="number">0</span>,     <span class="number">0</span>,    &amp;Service::HandleOneshot&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"onrestart"</span>,   &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleOnrestart&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"seclabel"</span>,    &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleSeclabel&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"setenv"</span>,      &#123;<span class="number">2</span>,     <span class="number">2</span>,    &amp;Service::HandleSetenv&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"socket"</span>,      &#123;<span class="number">3</span>,     <span class="number">6</span>,    &amp;Service::HandleSocket&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"user"</span>,        &#123;<span class="number">1</span>,     <span class="number">1</span>,    &amp;Service::HandleUser&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">"writepid"</span>,    &#123;<span class="number">1</span>,     kMax, &amp;Service::HandleWritepid&#125;&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> option_handlers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸è§£æ Action ç±»ä¼¼ï¼Œ<strong>åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å…ˆåˆ›å»º Service å¯¹è±¡ï¼Œè§£æå‡º Service çš„åå­—å’Œå¯¹åº”çš„å‚æ•°æ·»åŠ åˆ°å¯¹è±¡å½“ä¸­ï¼Œå¹¶ä¸”ç»™æ¯ä¸ª Option æŒ‡å®šäº†ç›¸åº”çš„å¤„ç†å‡½æ•°</strong> åˆ°è¿™é‡Œ rc æ–‡ä»¶çš„è§£æå°±ç»“æŸäº†ï¼Œé€šè¿‡ rc æ–‡ä»¶çš„è§£æä½¿å¾—æ¯ä¸ª action éƒ½æœ‰äº†å¯¹åº”çš„æ‰§è¡Œå‡½æ•°ï¼Œ<strong>æ‰€ä»¥æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯è¿™äº› action æ˜¯å¦‚ä½•è¢«è§¦å‘çš„ï¼ˆä¹Ÿå³æ˜¯ command å‘½ä»¤æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼‰ï¼Ÿ</strong></p><h4 id="actions-çš„è§¦å‘">Actions çš„è§¦å‘</h4><p>è®©æˆ‘ä»¬ç»§ç»­å›åˆ° init.cpp ä¸­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ActionManager&amp; am = ActionManager::GetInstance();</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!waiting_for_exec) &#123;</span><br><span class="line">        am.ExecuteOneCommand();</span><br><span class="line">        restart_processes();</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° action çš„ command çš„æ‰§è¡Œæ˜¯é€šè¿‡ ActionManager çš„ ExecuteOneCommand å‡½æ•°ï¼Œè€ŒActionManager çš„ ExecuteOneCommand æœ€ç»ˆè°ƒç”¨äº† Action çš„ ExecuteOneCommand system/core/init/action.cpp</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> ActionManager::ExecuteOneCommand() &#123;</span><br><span class="line">    <span class="comment">//å¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­ä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">while</span> (current_executing_actions_.empty() &amp;&amp; !trigger_queue_.empty()) &#123;</span><br><span class="line">        <span class="comment">//éå† actions_</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; action : actions_) &#123;</span><br><span class="line">            <span class="keyword">if</span> (trigger_queue_.front()-&gt;CheckTriggers(*action)) &#123;</span><br><span class="line">                <span class="comment">//å°† action åŠ å…¥åˆ° current_executing_actions_ ä¸­</span></span><br><span class="line">                current_executing_actions_.emplace(action.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        trigger_queue_.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ¯æ¬¡åªæ‰§è¡Œä¸€ä¸ª action</span></span><br><span class="line">    <span class="keyword">auto</span> action = current_executing_actions_.front();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (current_command_ == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> trigger_name = action-&gt;BuildTriggersString();</span><br><span class="line">        INFO(<span class="string">"processing action (%s)\n"</span>, trigger_name.c_str());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰§è¡Œ action çš„ command</span></span><br><span class="line">    action-&gt;ExecuteOneCommand(current_command_);</span><br><span class="line">  </span><br><span class="line">    ++current_command_;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Action::ExecuteOneCommand(<span class="built_in">std</span>::<span class="keyword">size_t</span> command) <span class="keyword">const</span> &#123;</span><br><span class="line">  <span class="comment">//æ‰§è¡Œ action å¯¹è±¡ä¸­ä¿å­˜çš„ command</span></span><br><span class="line">    ExecuteCommand(commands_[command]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> Action::ExecuteCommand(<span class="keyword">const</span> Command&amp; command) <span class="keyword">const</span> &#123;</span><br><span class="line">    Timer t;</span><br><span class="line">  <span class="comment">//è°ƒç”¨ command å¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">int</span> result = command.InvokeFunc();</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šè¿°åˆ†æå¯ä»¥çŸ¥é“ï¼Œinit è¿›ç¨‹æœ€ç»ˆè¿›å…¥åˆ°æ— é™å¾ªç¯ä¸­ï¼Œç„¶åæŒ‰ç…§ ActionManager ä¸­ actions_ ä¿å­˜çš„ action é¡ºåºä¾æ¬¡å¯¹æ¯ä¸ª Action è¿›è¡Œå¤„ç†ï¼Œè€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ system/core/init/builtins.cpp ä¸‹ç”¨äºå¯åŠ¨ zygote çš„ do_class_start å‡½æ•°å°†ä¼šè¢«æ‰§è¡Œ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_class_start</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; args)</span> </span>&#123;</span><br><span class="line">    ServiceManager::GetInstance().</span><br><span class="line">        ForEachServiceInClass(args[<span class="number">1</span>], [] (Service* s) &#123; s-&gt;StartIfNotDisabled(); &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>do_class_start å‡½æ•°ä¸­è°ƒç”¨ Service çš„ StartIfNotDisabledï¼ŒStartIfNotDisabled åœ¨ service.cpp çš„å®ç°å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Service::StartIfNotDisabled() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(flags_ &amp; SVC_DISABLED)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Start();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        flags_ |= SVC_DISABLED_START;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>StartIfNotDisabled æœ€ç»ˆè°ƒç”¨äº† Service çš„ Start å‡½æ•°ï¼ŒStart å‡½æ•°åˆ›å»ºäº† zygote çš„è¿›ç¨‹ï¼Œå¹¶ä¸”æ‰§è¡Œäº† init.zygote64_32.rc ä¸­å®šä¹‰çš„æ‰§è¡Œè·¯å¾„ä¸‹çš„æ–‡ä»¶</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Service::Start() &#123;</span><br><span class="line">    ....</span><br><span class="line">   <span class="comment">//åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">       <span class="comment">//æ‰§è¡Œå¯¹åº” service å¯¹åº”çš„æ‰§è¡Œæ–‡ä»¶ï¼Œargs_[0].c_str() å°±æ˜¯æ‰§è¡Œè·¯å¾„</span></span><br><span class="line">        <span class="keyword">if</span> (execve(args_[<span class="number">0</span>].c_str(), (<span class="keyword">char</span>**) &amp;strs[<span class="number">0</span>], (<span class="keyword">char</span>**) ENV) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ERROR(<span class="string">"cannot execve('%s'): %s\n"</span>, args_[<span class="number">0</span>].c_str(), strerror(errno));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _exit(<span class="number">127</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å®Œæˆè¿™ä¸€åˆ‡ä¹‹åå°†ä¼šè¿›å…¥ frameworks/base/cmds/app_process/app_main.cpp ä¸­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ....</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zygote) &#123;</span><br><span class="line">      <span class="comment">//å¯åŠ¨ zygote</span></span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        runtime.start(<span class="string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error: no class name or --zygote supplied.\n"</span>);</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL(<span class="string">"app_process: no class name or --zygote supplied."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° zygote æœ€ç»ˆåœ¨ app_main çš„ main å‡½æ•°ä¸­è¢«å¯åŠ¨ã€‚</p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>åˆ°è¿™é‡Œæˆ‘ä»¬å°±èƒ½å¤Ÿå›ç­”å¯¹ init éƒ¨åˆ†ç›¸å…³çš„é—®é¢˜äº† 1. init çš„ä½œç”¨ init æ˜¯ç³»ç»Ÿä¸­çš„ç¬¬ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯<strong>åˆ›å»ºç”¨æˆ·ç©ºé—´æ–‡ä»¶å¤¹å¹¶æŒ‚è½½ã€å¯åŠ¨å±æ€§æœåŠ¡ã€è§£æ init.rc æ–‡ä»¶å¹¶å¯åŠ¨ zygote è¿›ç¨‹</strong>ã€‚ 2. init å¯åŠ¨ zygote çš„è¿‡ç¨‹ init è¿›ç¨‹é€šè¿‡è§£æ init.rc æ–‡ä»¶å°† action ä¿å­˜åœ¨ ActionManager çš„ actions_ é“¾è¡¨ä¸­ï¼Œç„¶åé€šè¿‡éå† actions_ é“¾è¡¨ï¼Œæ‰§è¡Œ action å‘½ä»¤å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œä»è€Œè½¬è‡³ builtins.cpp çš„ do_class_start å‡½æ•°ï¼Œä¹‹åé€šè¿‡ Service çš„ StartIfNotDisabled è°ƒç”¨ Service çš„ Start å‡½æ•°ï¼Œæœ€ç»ˆé€šè¿‡ Start å‡½æ•°åˆ›å»º zygote è¿›ç¨‹ï¼Œæ‰§è¡Œå¯¹åº”çš„ app_main.cpp æ–‡ä»¶å¯åŠ¨ zygoteã€‚</p><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="http://blog.csdn.net/gaugamela/article/details/52133186" target="_blank" rel="noopener">Android7.0 initè¿›ç¨‹æºç åˆ†æ</a></li><li><a href="http://blog.csdn.net/hongbochen1223/article/details/56331690" target="_blank" rel="noopener">Android Init Language(androidåˆå§‹åŒ–è¯­è¨€)</a></li><li><a href="http://blog.csdn.net/itachi85/article/details/54783506" target="_blank" rel="noopener">Androidç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼ˆä¸€ï¼‰è§£æinitè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é—®é¢˜&quot;&gt;é—®é¢˜&lt;/h2&gt;
&lt;p&gt;åœ¨è¿›å…¥åˆ° Android å¯åŠ¨è¿‡ç¨‹ä¹‹å‰å…ˆè®©æˆ‘ä»¬æ€è€ƒä»¥ä¸‹å‡ ä¸ªé—®é¢˜ 1. Android ç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ 2. init ã€zygote è¿›ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­å„è‡ªå‘æŒ¥äº†ä»€ä¹ˆä½œç”¨ï¼Ÿ 3. AMSã€PMS ç­‰è¿™äº›æœåŠ¡æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Ÿ 4. Launcher æ˜¯å¦‚ä½•è¢«å¯åŠ¨çš„ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æ­¤ç¯‡æ–‡ç« å°†é’ˆå¯¹ init éƒ¨åˆ†ç»™å‡ºåˆ†æ&lt;/p&gt;
    
    </summary>
    
      <category term="Androidè¿›é˜¶" scheme="http://www.ikroal.xyz/categories/Android%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="æºç åˆ†æ" scheme="http://www.ikroal.xyz/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Android åŸºç¡€ä¹‹ Selector çš„ç”¨æ³•</title>
    <link href="http://www.ikroal.xyz/2017/09/24/Selector%E7%9A%84%E7%94%A8%E6%B3%95/"/>
    <id>http://www.ikroal.xyz/2017/09/24/Selectorçš„ç”¨æ³•/</id>
    <published>2017-09-24T07:58:15.000Z</published>
    <updated>2019-05-13T09:00:30.704Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>Selectorï¼ˆé€‰æ‹©å™¨ï¼‰å¸¸å¸¸è¢«ç”¨ä½œæ§ä»¶çš„èƒŒæ™¯ï¼Œæ˜¯ä¸€ç§çŠ¶æ€åˆ—è¡¨ï¼Œä¸€èˆ¬åˆ†ä¸º Drawable-selector å’Œ Color-selectorï¼Œæ¥ä¸‹æ¥åˆ†åˆ«è¯´è¯´è¿™ä¸¤è€…çš„ä½¿ç”¨æ–¹æ³•ã€‚<a id="more"></a></p><h2 id="drawable-selector">Drawable-selector</h2><ol type="1"><li><p>é¦–å…ˆéœ€è¦åœ¨ res/drawable æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ª Drawable Resource File æ–‡ä»¶ï¼Œå¡«å…¥æ–‡ä»¶åå³å¯ï¼Œåˆ›å»ºä¹‹åçš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åœ¨ selector æ ‡ç­¾ä¸‹æ–°å»ºä¸€ä¸ª item æ ‡ç­¾ï¼Œitem æ ‡ç­¾è¡¨ç¤ºä¸€ç§çŠ¶æ€ï¼Œå¦‚æœä¸æŒ‡æ˜çŠ¶æ€ï¼Œé‚£ä¹ˆæ§ä»¶åœ¨ä»»ä½•çŠ¶æ€ä¸‹éƒ½ä¼šåŠ è½½ item å†…çš„ æ ·å¼ï¼Œå¸¸ç”¨çš„çŠ¶æ€è®¾ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>android:state_pressed è®¾ç½®ä¸º true æ—¶ä»£è¡¨æŒ‰å‹æ§ä»¶çš„æ—¶å€™ä½¿ç”¨ item æ ·å¼</li><li>android:state_selected è®¾ç½®ä¸º true æ—¶ä»£è¡¨æ§ä»¶è¢«é€‰ä¸­çš„æ—¶å€™ä½¿ç”¨ item æ ·å¼</li><li>android:state_checked è®¾ç½®ä¸º true æ—¶ä»£è¡¨æ§ä»¶å¤„äº checked çŠ¶æ€çš„æ—¶å€™ä½¿ç”¨ item æ ·å¼</li></ul></li><li><p>æ¥ä¸‹æ¥åœ¨ item å†…éƒ¨åˆ›å»º shape æ ‡ç­¾ç”¨äºæŒ‡å®šç»˜åˆ¶çš„å›¾å½¢ç±»åˆ«ï¼Œæ€»å…±æœ‰å››ç§å›¾å½¢å¯ä»¥é€‰æ‹©åˆ†åˆ«æ˜¯ï¼šrectangleã€ovalã€lineã€ringã€‚åœ¨ç¡®å®šéœ€è¦ç»˜åˆ¶çš„ shape ç±»å‹ä¹‹åï¼Œå°±å¯ä»¥åœ¨ shape æ ‡ç­¾å†…éƒ¨å¯¹ shape çš„å„é¡¹å±æ€§è¿›è¡Œé…ç½®ï¼Œæ€»å…±æœ‰å…­ç§æ ‡ç­¾å±æ€§ã€‚</p><ul><li>size ç”¨æ¥è®¾ç½® shape çš„å¤§å°</li><li>solid ç”¨æ¥è®¾ç½®å¡«å…… shape çš„é¢œè‰²</li><li>corners ç”¨æ¥è®¾ç½® shape çš„è§’åº¦</li><li>stroke ç”¨æ¥ç»™ shape æè¾¹ï¼Œå¯ä»¥ææˆè™šçº¿æˆ–å®çº¿</li><li>padding è®¾ç½®å†…è¾¹è·</li><li>gradient è®¾ç½® shape çš„æ¸å˜é¢œè‰²</li></ul></li><li><p>è®¾ç½®å¥½ç›¸åº”çš„å±æ€§ä¹‹åå°±å¯ä»¥é€šè¿‡è®¾ç½®æ§ä»¶çš„ android:drawble å±æ€§è¿›è¡Œä½¿ç”¨äº†ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªä¾‹å­</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_pressed</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shape</span> <span class="attr">android:shape</span>=<span class="string">"rectangle"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"5dp"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">stroke</span> <span class="attr">android:width</span>=<span class="string">"1dp"</span> <span class="attr">android:color</span>=<span class="string">"#00faff"</span> <span class="attr">android:dashGap</span>=<span class="string">"10dp"</span> <span class="attr">android:dashWidth</span>=<span class="string">"10dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span> <span class="attr">android:width</span>=<span class="string">"150dp"</span> <span class="attr">android:height</span>=<span class="string">"150dp"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"#bcb7b7"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:state_pressed</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">shape</span> <span class="attr">android:shape</span>=<span class="string">"oval"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">corners</span> <span class="attr">android:radius</span>=<span class="string">"360dp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">stroke</span> <span class="attr">android:width</span>=<span class="string">"1dp"</span> <span class="attr">android:color</span>=<span class="string">"#00fcb5"</span> <span class="attr">android:dashGap</span>=<span class="string">"10dp"</span> <span class="attr">android:dashWidth</span>=<span class="string">"10dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">size</span> <span class="attr">android:width</span>=<span class="string">"300dp"</span> <span class="attr">android:height</span>=<span class="string">"300dp"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">"#ffff"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ç»˜åˆ¶äº†ä¸¤ç§çŠ¶æ€ï¼Œä¸€ç§æ˜¯é»˜è®¤çŠ¶æ€ä¸‹çš„åœ†ï¼Œç™½è‰²å¡«å……ã€è™šçº¿æè¾¹ã€åŠå¾„æ˜¯ 300dpã€‚å¦ä¸€ç§æ˜¯è¢«æŒ‰ä¸‹çš„çŠ¶æ€ï¼Œç°è‰²å¡«å……ã€è™šçº¿æè¾¹ã€é•¿å’Œå®½ä¸åœ†ä¸€è‡´ã€‚å…·ä½“æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/ikroal/blog-images/master/selector-circle.png"><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/selector-square.png"></p></li></ol><h2 id="color-selector">Color-selector</h2><p>Color-selector å®šä¹‰åœ¨ resæ–‡ä»¶å¤¹ä¸‹ï¼Œä½¿ç”¨è¿‡ç¨‹åŸºæœ¬ä¸ Drawable-selector ä¸€è‡´ï¼Œä¸åŒåœ¨äº Color-selector åªæ˜¯ç”¨äºå®šä¹‰æ§ä»¶çš„é¢œè‰²ï¼Œæ‰€ä»¥åªéœ€è¦é…ç½® item æ ‡ç­¾çš„ color å±æ€§å³å¯ï¼Œå…·ä½“çš„ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"#000000"</span> <span class="attr">android:state_pressed</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"#ffff"</span> <span class="attr">android:state_pressed</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡æŒ‡å®š item çš„çŠ¶æ€å’Œé¢œè‰²ï¼Œå³å¯åšåˆ°æŒ‰å‹å’Œæ¾å¼€æ—¶æ§ä»¶çš„é¢œè‰²å˜åŒ–ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;Selectorï¼ˆé€‰æ‹©å™¨ï¼‰å¸¸å¸¸è¢«ç”¨ä½œæ§ä»¶çš„èƒŒæ™¯ï¼Œæ˜¯ä¸€ç§çŠ¶æ€åˆ—è¡¨ï¼Œä¸€èˆ¬åˆ†ä¸º Drawable-selector å’Œ Color-selectorï¼Œæ¥ä¸‹æ¥åˆ†åˆ«è¯´è¯´è¿™ä¸¤è€…çš„ä½¿ç”¨æ–¹æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="AndroidåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Android%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="Drawble" scheme="http://www.ikroal.xyz/tags/Drawble/"/>
    
  </entry>
  
  <entry>
    <title>é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™åŠå•ä¾‹æ¨¡å¼</title>
    <link href="http://www.ikroal.xyz/2017/09/17/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%85%AD%E5%A4%A7%E5%8E%9F%E5%88%99%E5%8F%8A%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
    <id>http://www.ikroal.xyz/2017/09/17/é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™åŠå•ä¾‹æ¨¡å¼/</id>
    <published>2017-09-16T17:05:58.000Z</published>
    <updated>2018-03-04T15:45:34.507Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™">é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™</h2><h3 id="å•ä¸€èŒè´£åŸåˆ™">å•ä¸€èŒè´£åŸåˆ™</h3><p>å•ä¸€èŒè´£åŸåˆ™ (SRP) æ˜¯æŒ‡å°±ä¸€ä¸ªç±»è€Œè¨€ï¼Œåº”è¯¥ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› </p><blockquote><p>ç®€å•è€Œè¨€å°±æ˜¯ä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€é¡¹èŒè´£ï¼Œè€Œä¸æ˜¯å…·æœ‰å¤šé¡¹èŒè´£ï¼Œæ¯”å¦‚ä¸€ä¸ªç±»æ—¢è´Ÿè´£å›¾ç‰‡ç¼“å­˜çš„å¤„ç†åŒæ—¶è¿˜è´Ÿè´£æ˜¾ç¤ºå›¾ç‰‡ï¼Œå®é™…ä¸Šåº”è¯¥æ‹†åˆ†æˆä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªç±»è´Ÿè´£å›¾ç‰‡çš„ç¼“å­˜ï¼Œå¦å¤–ä¸€ä¸ªç±»è´Ÿè´£å›¾ç‰‡æ˜¾ç¤ºã€‚å¦‚æœä¸€ä¸ªç±»å…¼å…·å¤ªå¤šçš„èŒè´£ä¸ä»…å¯¼è‡´äº†è€¦åˆæ€§ï¼Œè€Œä¸”åœ¨ä¸€ä¸ªèŒè´£å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è¿˜å¯èƒ½å‰Šå¼±å…¶å®ƒçš„èŒè´£åŠŸèƒ½ã€‚</p></blockquote><a id="more"></a><h3 id="å¼€é—­åŸåˆ™">å¼€é—­åŸåˆ™</h3><p>å¼€é—­åŸåˆ™ (OCP) æ˜¯æŒ‡è½¯ä»¶ä¸­çš„å¯¹è±¡å¯¹äºä¿®æ”¹åº”è¯¥æ˜¯å°é—­çš„ï¼Œå¯¹äºæ‰©å±•åº”è¯¥æ˜¯å¼€æ”¾çš„ã€‚</p><blockquote><p>å¦‚æœä¸€ä¸ªç±»ä¸ºäº†å®ç°æ–°çš„åŠŸèƒ½ä¸æ–­çš„å¯¹ç±»ä¸­çš„åŸæœ‰ä»£ç è¿›è¡Œä¿®æ”¹å’Œå¢åŠ ï¼Œä¸ä»…å¯èƒ½å¼•å…¥ Bugï¼Œè¿˜æœ‰å¯èƒ½ä¼šå¯¼è‡´ç±»è¶Šæ¥è¶Šåºå¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªå›¾ç‰‡çš„ç¼“å­˜ç±»éœ€è¦å®ç°å†…å­˜ç¼“å­˜ã€SD å¡ç¼“å­˜ã€ä¸¤ç§æ–¹å¼æ··åˆçš„ç¼“å­˜æ–¹æ³•ï¼Œåœ¨å›¾ç‰‡æ˜¾ç¤ºç±»ä¸­éœ€è¦è‡ªç”±é€‰æ‹©ä½•ç§æ–¹å¼è¿›è¡Œç¼“å­˜æ˜¾ç¤ºã€‚æ¯”è¾ƒå¥½çš„ä¸€ç§æ–¹å¼æ˜¯ï¼šç”±äºä¸‰ç§ç¼“å­˜æ–¹å¼å®é™…ä¸ŠåŸºæœ¬åŠŸèƒ½ä¸€è‡´ï¼Œæ‰€ä»¥å¯ä»¥å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç„¶ååœ¨å›¾ç‰‡æ˜¾ç¤ºç±»ä¸­ä¹‰ä¸€ä¸ªæ¥å£ç”¨äºæŒ‡å‘ä¸‰ä¸ªç±»å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå½“éœ€è¦é‡‡ç”¨å“ªç§æ–¹å¼å»è¿›è¡Œç¼“å­˜çš„æ—¶å€™ï¼Œåªéœ€è¦ä½¿ç”¨ set æ–¹æ³•è¿›è¡Œä¾èµ–æ³¨å…¥å°†æ¥å£æŒ‡å‘ç›¸åº”æ–¹å¼çš„å¯¹è±¡å³å¯ï¼Œå¹¶ä¸”å¦‚æœè¦å®ç°å…¶å®ƒä¸åŒçš„ç¼“å­˜æ–¹å¼åªéœ€è¦å¯¹æ¥å£è¿›è¡Œå®ç°å³å¯ã€‚è¿™æ ·å®ç°çš„ä»£ç è€¦åˆæ€§å¼±æ‰©å±•æ€§å¼ºã€‚</p></blockquote><h3 id="é‡Œæ°æ›¿æ¢åŸåˆ™">é‡Œæ°æ›¿æ¢åŸåˆ™</h3><p>é‡Œæ°æ›¿æ¢åŸåˆ™æ˜¯æŒ‡æ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡</p><blockquote><p>ä¸€ä¸ªåŸºç±»çš„å­ç±»æ‹¥æœ‰åŸºç±»çš„å±æ€§å’Œæ–¹æ³•ï¼ˆç§æœ‰çš„é™¤å¤–ï¼‰ï¼Œæ‰€ä»¥åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åŸºç±»èƒ½å¹²çš„å­ç±»éƒ½èƒ½åšï¼Œè¿™æ ·å¯ä»¥ä¿è¯å¾ˆå¥½çš„æ‰©å±•æ€§ï¼Œå› ä¸ºå¯ä»¥åœ¨åŸºç±»çš„åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•å®ç°ä¸åŒåŠŸèƒ½çš„å­ç±»ã€‚å› æ­¤é‡Œæ°æ›¿æ¢åŸåˆ™æœ‰åˆ©äºæé«˜æ‰©å±•æ€§ï¼ŒåŒæ—¶ä¸ºå¼€é—­åŸåˆ™æä¾›äº†ä¿éšœã€‚</p></blockquote><h3 id="ä¾èµ–å€’ç½®åŸåˆ™">ä¾èµ–å€’ç½®åŸåˆ™</h3><p>ä¾èµ–å€’ç½®åŸåˆ™æ˜¯ç”¨äºè§£è€¦çš„ä¸€ç§æ–¹å¼ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š</p><ol type="1"><li>é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–åº•å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡</li><li>æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚</li><li>ç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡</li></ol><blockquote><p>ç¬¬ä¸€ç‚¹æ˜¯æŒ‡å½“é«˜å±‚çš„æ¨¡å—ä½¿ç”¨åº•å±‚çš„æ¨¡å—æ—¶å€™ï¼Œä¸åº”è¯¥ç›´æ¥ä½¿ç”¨åº•å±‚æ¨¡å—ç±»çš„å…·ä½“å¯¹è±¡ï¼Œè€Œåº”è¯¥ä½¿ç”¨å…¶æ¥å£æˆ–è€…æ˜¯æŠ½è±¡ç±»ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å…¶æ‰©å±•æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´é«˜å±‚æ¨¡å—ä¸åº•å±‚æ¨¡å—ä¹‹é—´åº”è¯¥é€šè¿‡æ¥å£å‘ç”Ÿè”ç³»ï¼Œè€Œä¸åº”è¯¥å­˜åœ¨ç›´æ¥å…³è”ã€‚</p></blockquote><h3 id="æ¥å£éš”ç¦»åŸåˆ™">æ¥å£éš”ç¦»åŸåˆ™</h3><p>æ¥å£éš”ç¦»åŸåˆ™æ˜¯æŒ‡ç±»é—´çš„å…³ç³»åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Š</p><blockquote><p>æœ€å°çš„æ¥å£å®é™…ä¸Šå°±æ˜¯æŠ½è±¡çš„ä¸€ç§è¡¨è¾¾ï¼Œä¸€ä¸ªæ¥å£ä¸‹é¢å¯èƒ½å¯èƒ½ä¼šå®ç°å¾ˆå¤šç§æ¥å£ï¼Œæˆ–è€…æ˜¯å¾ˆå¤šå±‚çº§æ¥å£ï¼Œè¦å¯¹è¿™äº›æ¥å£ç›¸åŒçš„åŠŸèƒ½éƒ¨åˆ†è¿›è¡Œæ“ä½œçš„æ—¶å€™åªéœ€è¦å¯¹æœ€é¡¶å±‚çš„æ¥å£æ“ä½œå³å¯ï¼Œè­¬å¦‚å½“å…³é—­è¾“å…¥è¾“å‡ºæµçš„æ—¶å€™ï¼ŒJava ä¸­æœ‰å¾ˆå¤šç§æµï¼Œå­—èŠ‚æµã€å­—ç¬¦æµã€ç¼“å†²æµã€‚è¿™ä¸ªæ—¶å€™ä¸ºäº†å‡å°‘ä¾èµ–ã€è€¦åˆæ€§ä»¥åŠå¢åŠ æ‰©å±•æ€§ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ©ç”¨ Cloaseable æ¥å£æŒ‡å‘å„ç§æµçš„å¯¹è±¡è¿›è¡Œå…³é—­æ“ä½œå³å¯ã€‚</p></blockquote><h3 id="è¿ªç±³ç‰¹åŸåˆ™">è¿ªç±³ç‰¹åŸåˆ™</h3><p>è¿ªç±³ç‰¹åŸåˆ™æ˜¯æŒ‡ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶å®ƒå¯¹è±¡æœ‰æœ€å°‘çš„äº†è§£</p><blockquote><p>ä¸€ä¸ªç±»åº”è¯¥å°½å¯èƒ½å°‘çš„åˆ©ç”¨åˆ°å…¶å®ƒç±»å®Œæˆç›¸åŒçš„ä»»åŠ¡ï¼Œè¿™æ ·å¯ä»¥é™ä½è€¦åˆæ€§</p></blockquote><h2 id="å•ä¾‹æ¨¡å¼">å•ä¾‹æ¨¡å¼</h2><h3 id="å®šä¹‰">å®šä¹‰</h3><p>æ‰€è°“å•ä¾‹ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€ä¸ªç±»åœ¨ç³»ç»Ÿä¸­åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶ä¸”å¯ä»¥è‡ªè¡Œå®ä¾‹åŒ–å‘ç³»ç»Ÿæä¾›è¿™ä¸ªå®ä¾‹</p><h3 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</h3><p>é€‚ç”¨äºæŸä¸ªç±»æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹è±¡çš„åœºæ™¯ï¼Œé¿å…åˆ›å»ºå¤šä¸ªå¯¹è±¡æ¶ˆè€—è¿‡å¤šçš„èµ„æºã€‚</p><blockquote><ol type="1"><li><p>æ„é€ å‡½æ•°ä¸å¯¹å¤–å¼€æ”¾ï¼Œä¸€èˆ¬ä¸º private</p></li><li><p>é€šè¿‡ä¸€ä¸ªé™æ€æ–¹æ³•æˆ–è€…æšä¸¾è¿”å›å•ä¾‹ç±»å¯¹è±¡</p></li><li><p>ç¡®ä¿å•ä¾‹ç±»å¯¹è±¡æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œå°¤å…¶æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹</p></li><li><p>ç¡®ä¿å•ä¾‹ç±»å¯¹è±¡åœ¨ååºåˆ—åŒ–æ—¶ä¸ä¼šé‡æ–°æ„å»ºå¯¹è±¡</p></li></ol><p>ä¹Ÿå³æ˜¯è¯´å•ä¾‹æ¨¡å¼çš„å¯¹è±¡å¿…é¡»ç”±è¯¥ç±»çš„é™æ€æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–å’Œæä¾›ï¼Œå¹¶ä¸”ä¸èƒ½å‡ºç°å¤šä¸ªå¯¹è±¡ã€‚</p></blockquote><h3 id="ä¼˜ç¼ºç‚¹">ä¼˜ç¼ºç‚¹</h3><ol type="1"><li>ä¼˜ç‚¹</li></ol><ul><li>å•ä¾‹æ¨¡å¼åœ¨å†…å­˜ä¸­åªå­˜åœ¨ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€æ”¯ã€‚</li><li>å‡å°‘äº†ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ï¼Œå½“ä¸€ä¸ªå¯¹è±¡çš„äº§ç”Ÿéœ€è¦è¾ƒå¤šçš„èµ„æºçš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡äº§ç”Ÿä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œç„¶åæ°¸é©»å†…å­˜æ¥è§£å†³ã€‚</li><li>å•ä¾‹æ¨¡å¼å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ã€‚</li><li>å•ä¾‹æ¨¡å¼å¯ä»¥åœ¨ç³»ç»Ÿè®¾ç½®å…¨å±€çš„è®¿é—®ç‚¹ï¼Œä¼˜åŒ–å’Œå…±äº«èµ„æºè®¿é—®</li></ul><ol start="2" type="1"><li>ç¼ºç‚¹</li></ol><ul><li><strong>å•ä¾‹æ¨¡å¼ä¸€èˆ¬æ²¡æœ‰æ¥å£ï¼Œæ‰©å±•å¾ˆå›°éš¾ã€‚</strong></li><li><strong>å•ä¾‹å¯¹è±¡å¦‚æœæŒæœ‰ Contextï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å¼•å‘å†…å­˜æ³„æ¼ï¼Œæ­¤æ—¶ä¼ é€’ç»™å•ä¾‹å¯¹è±¡çš„ Context æœ€å¥½æ˜¯ Application Context</strong></li></ul><h3 id="å¸¸ç”¨çš„å®ç°æ–¹å¼">å¸¸ç”¨çš„å®ç°æ–¹å¼</h3><ol type="1"><li>é¥¿æ±‰æ¨¡å¼</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CEO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CEO sCeo = <span class="keyword">new</span> CEO();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CEO</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CEO <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sCeo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>è¯¥ç§æ–¹å¼å®ç°çš„å•ä¾‹æ¨¡å¼å½“ç±»è¢«åŠ è½½çš„æ—¶å€™å°±ä¼šåˆå§‹åŒ–ä¸€ä¸ª CEO å¯¹è±¡ï¼Œç„¶åå¤–éƒ¨å¯ä»¥é€šè¿‡ newInstance é™æ€æ–¹æ³•è¿›è¡Œè·å–ã€‚</p><p>ç”±äºå•ä¾‹æ¨¡å¼éœ€è¦ç±»èƒ½å¤Ÿè‡ªè¡Œè¿›è¡Œå®ä¾‹åŒ–ï¼Œæ‰€ä»¥è¿”å›å€¼ä¸€å®šæ˜¯ç±»å˜é‡ä»¥åŠé€šè¿‡é™æ€æ–¹æ³•è¿›è¡Œè¿”å›ã€‚</p></blockquote><ol start="2" type="1"><li>æ‡’æ±‰æ¨¡å¼</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sSingleInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SingleInstance <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sSingleInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sSingleInstance = <span class="keyword">new</span> SingleInstance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sSingleInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>é‡‡ç”¨æ‡’æ±‰æ¨¡å¼å®ç°çš„å•ä¾‹æ¨¡å¼å¯ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™æ‰å°†å¯¹è±¡å®ä¾‹åŒ–ï¼Œä½†æ˜¯ç”±äºæ¯æ¬¡è°ƒç”¨ newInstance æ–¹æ³•çš„æ—¶å€™éƒ½ä¼šè¿›è¡ŒåŒæ­¥ï¼ˆæ¯”ä¸éœ€è¦åŒæ­¥çš„æ…¢ 100 å€ï¼‰ï¼Œæ‰€ä»¥é€ æˆäº†ä¸å¿…è¦çš„åŒæ­¥å¼€é”€ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p></blockquote><ol start="3" type="1"><li>Double Check Lock</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleInstance sSingleInstance = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sSingleInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SingleInstance.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (sSingleInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    sSingleInstance = <span class="keyword">new</span> SingleInstance();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sSingleInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>ç¬¬ä¸€æ¬¡çš„åˆ¤æ–­é¿å…äº†åœ¨å¯¹è±¡éç©ºæƒ…å†µä¸‹è¿›è¡ŒåŒæ­¥å¯¼è‡´ä¸å¿…è¦å¼€é”€çš„é—®é¢˜ï¼Œç¬¬äºŒæ¬¡åˆ¤æ–­æ˜¯ç”±äºå¯èƒ½å­˜åœ¨çº¿ç¨‹ Aï¼ŒB åŒæ—¶åˆ¤æ–­äº†å¯¹è±¡ä¸ºç©ºï¼Œç„¶åä¾æ¬¡è¿›å…¥åŒæ­¥å—ä¸­ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ä¸è¿›è¡Œåˆ¤æ–­åˆ™å¯èƒ½å¯¼è‡´åˆ›å»ºå‡ºä¸¤ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç¬¬äºŒæ¬¡åˆ¤æ–­ã€‚</p><p>è¿™ä¸ªæ¨¡å¼å­˜åœ¨çš„ä¸€ä¸ªé—®é¢˜æ˜¯ mSingleInstance = new SingleInstance() ä¸æ˜¯åŸå­æ“ä½œï¼Œå…¶åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šç»™å®ä¾‹å¯¹è±¡åˆ†é…å†…å­˜ï¼›è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æˆå‘˜å­—æ®µï¼›å°†å®ä¾‹å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´ã€‚å¹¶ä¸”åä¸¤æ­¥çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥å¯èƒ½å‡ºç° A çº¿ç¨‹æ‰§è¡Œå®Œç¬¬ä¸‰æ­¥ï¼Œæ²¡æœ‰æ‰§è¡Œå®Œç¬¬äºŒæ­¥çš„æƒ…å†µä¸‹ï¼Œç¨‹åºåˆ‡æ¢è‡³ B çº¿ç¨‹ï¼ŒB çº¿ç¨‹åˆ¤æ–­å½“å‰å¯¹è±¡éç©ºå–èµ°å¯¹è±¡ï¼Œä½†ç”±äºå¯¹è±¡çš„æˆå‘˜å­—æ®µæ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°é”™è¯¯ã€‚</p><p>è§£å†³åŠæ³•æ˜¯åœ¨ sInstance å‰åŠ ä¸Š volatile å…³é”®å­—ã€‚</p></blockquote><ol start="4" type="1"><li>é™æ€å†…éƒ¨ç±»</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInstance</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleInstance <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingleHolder.sSingleInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SingleInstance sSingleInstance = <span class="keyword">new</span> SingleInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>é‡‡ç”¨è¿™ç§æ–¹å¼å®ç°çš„å•ä¾‹æ¨¡å¼å¾ˆå¥½çš„é¿å…äº† DCL ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œç”±äºå†…éƒ¨ç±»åªæœ‰åœ¨ä½¿ç”¨å®ƒçš„æˆå‘˜ä»¥åŠæ–¹æ³•çš„æ—¶å€™æ‰ä¼šè¿›è¡Œè½½å…¥ï¼Œæ‰€ä»¥å¯ä»¥åšåˆ°ä½¿ç”¨çš„æ—¶å€™æ‰å®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œä¸”èƒ½å¤Ÿç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</p></blockquote><ol start="5" type="1"><li>æšä¸¾å•ä¾‹</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> SingletonEnum &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"do sth."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>åœ¨ä»»ä½•æƒ…å†µä¸‹æšä¸¾å®ä¾‹éƒ½æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œè€Œä¸”åˆ›å»ºè¿‡ç¨‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p></blockquote><ol start="6" type="1"><li>å®¹å™¨å®ç°å•ä¾‹</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, Object&gt; objectMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerService</span><span class="params">(String key, Object instance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!objectMap.containsKey(key)) &#123;</span><br><span class="line">            objectMap.put(key, instance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getService</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> objectMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>é‡‡ç”¨å®¹å™¨å®ç°çš„å•ä¾‹æ¨¡å¼å¯ä»¥å¯¹å¤šç§å¯¹è±¡çš„å•ä¾‹è¿›è¡Œç®¡ç†ï¼Œä¾‹å¦‚ Android å½“ä¸­çš„ getSystemService å°±æ˜¯è¿™æ ·å®ç°çš„å•ä¾‹æ¨¡å¼ã€‚</p></blockquote><h2 id="æ€»ç»“">æ€»ç»“</h2><ol type="1"><li>å‰å››ç§æ–¹å¼å®ç°çš„å•ä¾‹æ¨¡å¼å­˜åœ¨åœ¨ååºåˆ—åŒ–ï¼ˆåå°„æ‰§è¡Œæ— å‚æ„é€ å‡½æ•°ï¼‰çš„æƒ…å†µä¸‹å¯èƒ½ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œæˆ‘ä»¬éœ€è¦é‡å†™ readResolve æ–¹æ³•ï¼Œè¿™æ ·åœ¨è¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¿™ä¸ªæ–¹æ³•è·å–å¯¹è±¡å®ä¾‹ã€‚</li></ol><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span><span class="keyword">throws</span> ObjectStreamException</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sSingleInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ol start="2" type="1"><li>å•ä¾‹æ¨¡å¼çš„æ ¸å¿ƒåœ¨äºå°†æ„é€ å‡½æ•°è¿›è¡Œç§æœ‰åŒ–ï¼Œå¹¶ä¸”é€šè¿‡ä¸€ä¸ªé™æ€æ–¹æ³•è¿”å›å”¯ä¸€çš„å¯¹è±¡å®ä¾‹ï¼Œåœ¨è¿™ä¸ªè·å–çš„è¿‡ç¨‹å½“ä¸­éœ€è¦ä¿è¯<strong>çº¿ç¨‹å®‰å…¨ã€é˜²æ­¢ååºåˆ—åŒ–</strong>å¯¼è‡´ç”Ÿæˆå®ä¾‹å¯¹è±¡ç­‰é—®é¢˜ã€‚</li></ol><hr>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™&quot;&gt;é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™&lt;/h2&gt;
&lt;h3 id=&quot;å•ä¸€èŒè´£åŸåˆ™&quot;&gt;å•ä¸€èŒè´£åŸåˆ™&lt;/h3&gt;
&lt;p&gt;å•ä¸€èŒè´£åŸåˆ™ (SRP) æ˜¯æŒ‡å°±ä¸€ä¸ªç±»è€Œè¨€ï¼Œåº”è¯¥ä»…æœ‰ä¸€ä¸ªå¼•èµ·å®ƒå˜åŒ–çš„åŸå› &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ç®€å•è€Œè¨€å°±æ˜¯ä¸€ä¸ªç±»åº”è¯¥åªæœ‰ä¸€é¡¹èŒè´£ï¼Œè€Œä¸æ˜¯å…·æœ‰å¤šé¡¹èŒè´£ï¼Œæ¯”å¦‚ä¸€ä¸ªç±»æ—¢è´Ÿè´£å›¾ç‰‡ç¼“å­˜çš„å¤„ç†åŒæ—¶è¿˜è´Ÿè´£æ˜¾ç¤ºå›¾ç‰‡ï¼Œå®é™…ä¸Šåº”è¯¥æ‹†åˆ†æˆä¸¤ä¸ªç±»ï¼Œä¸€ä¸ªç±»è´Ÿè´£å›¾ç‰‡çš„ç¼“å­˜ï¼Œå¦å¤–ä¸€ä¸ªç±»è´Ÿè´£å›¾ç‰‡æ˜¾ç¤ºã€‚å¦‚æœä¸€ä¸ªç±»å…¼å…·å¤ªå¤šçš„èŒè´£ä¸ä»…å¯¼è‡´äº†è€¦åˆæ€§ï¼Œè€Œä¸”åœ¨ä¸€ä¸ªèŒè´£å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è¿˜å¯èƒ½å‰Šå¼±å…¶å®ƒçš„èŒè´£åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://www.ikroal.xyz/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Androidæºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜" scheme="http://www.ikroal.xyz/tags/Android%E6%BA%90%E7%A0%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E8%A7%A3%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>Android è‡ªå®šä¹‰æ§ä»¶ä¹‹ç™¾åˆ†æ¯”åœ†ç¯</title>
    <link href="http://www.ikroal.xyz/2017/09/10/Android%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6%E4%B9%8B%E7%99%BE%E5%88%86%E6%AF%94%E5%9C%86%E7%8E%AF/"/>
    <id>http://www.ikroal.xyz/2017/09/10/Androidè‡ªå®šä¹‰æ§ä»¶ä¹‹ç™¾åˆ†æ¯”åœ†ç¯/</id>
    <published>2017-09-10T01:01:22.000Z</published>
    <updated>2019-05-13T08:32:57.771Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2><p>æœ€è¿‘åšä¸€ä¸ªç®€å•çš„æµ‹è¯• APP çš„æ—¶å€™éœ€è¦å°†æ‰‹æœºçš„å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µæ˜¾ç¤ºå‡ºæ¥ï¼Œåˆšå¥½çœ‹è§ 360 æ¸…ç†å¤§å¸ˆçš„å­˜å‚¨ç©ºé—´æ˜¯ä»¥ç™¾åˆ†æ¯”åœ†ç¯çš„æ–¹å¼å®ç°çš„ï¼Œæ‰€ä»¥å¤§è‡´æ¨¡ä»¿äº†ä¸€ä¸‹å®ƒçš„å®ç°è¿‡ç¨‹ã€‚<a id="more"></a></p><h2 id="æ•ˆæœå›¾">æ•ˆæœå›¾</h2><p>é¦–å…ˆæ”¾ä¸Šæ•ˆæœå›¾ï¼Œç„¶åæˆ‘ä»¬å†æ ¹æ®æ•ˆæœå›¾è¿›è¡Œåˆ†æ <img src="https://raw.githubusercontent.com/ikroal/blog-images/master/ring-origin-result.png"></p><h2 id="å®ç°æ€è·¯">å®ç°æ€è·¯</h2><p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç»˜åˆ¶ä¸€ä¸ªè¿™æ ·çš„ç™¾åˆ†æ¯”åœ†ç¯ä¸»è¦æœ‰æ¶‰åŠåˆ°ä¸‰ä¸ªå…ƒç´ ï¼š 1. èƒŒæ™¯ç©ºå¿ƒåœ†ï¼šä»£è¡¨ç€æ€»çš„è¿›åº¦ 2. åœ†å¼§ï¼šä»£è¡¨ç€å½“å‰è¿›åº¦ 3. æ–‡å­—ï¼šéœ€è¦å±…ä¸­ï¼Œè¡¨ç¤ºå…·ä½“çš„è¿›åº¦</p><p>åœ¨äº†è§£åˆ°æ¶‰åŠåˆ°çš„å…ƒç´ ä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ç»˜åˆ¶å„ä¸ªå…ƒç´ éœ€è¦å“ªäº›å‚æ•°ï¼Œç”±äºç»˜åˆ¶éƒ½é€šè¿‡ onDraw æ–¹æ³•ä¸­çš„ canvas å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ canvas å¯¹è±¡çš„æ–¹æ³•å»ç¡®å®šæ‰€éœ€è¦çš„å‚æ•°ã€‚</p><ul><li>ç»˜åˆ¶åœ†ï¼šæŸ¥çœ‹ drawCircle å¯ä»¥çŸ¥é“æ€»å…±éœ€è¦å››ä¸ªå‚æ•°ï¼š<strong>åœ†å¿ƒ Xã€Y åæ ‡ã€åŠå¾„é•¿åº¦ä»¥åŠç”»ç¬” Paint</strong>ï¼›</li><li>ç»˜åˆ¶åœ†å¼§ï¼šæŸ¥çœ‹ drawArc å¯ä»¥çŸ¥é“æ€»å…±éœ€è¦å››ä¸ªå‚æ•°ï¼š<strong>Recfã€åœ†å¼§çš„èµ·å§‹è§’åº¦ã€ä»èµ·å§‹è§’åº¦é¡ºæ—¶é’ˆæ‰«è¿‡çš„è§’åº¦ä»¥åŠå¿…é¡»çš„ Paint</strong>ï¼Œè¿™é‡Œçš„ Recf ç¡®å®šäº†ä¸€ä¸ªçŸ©å½¢åŒºåŸŸï¼Œç„¶åç¡®å®šäº†ä¸€ä¸ªå†…æ¥æ¤­åœ†ï¼Œè€Œåœ†å¼§çš„ç»˜åˆ¶å®é™…ä¸Šæ˜¯åœ¨æ¤­åœ†ä¸Šé¢è¿›è¡Œæˆªå–ï¼›</li><li>ç»˜åˆ¶æ–‡æœ¬ï¼šæŸ¥çœ‹ drawText å¯ä»¥çŸ¥é“ï¼Œéœ€è¦å››ä¸ªå‚æ•°ï¼š<strong>æ–‡æœ¬å†…å®¹ã€è¿›è¡Œç»˜åˆ¶çš„ Xã€Y åæ ‡ç‚¹ä»¥åŠPaint</strong>ã€‚</li></ul><h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2><p>åœ¨äº†è§£äº†ç»˜åˆ¶å…ƒç´ æ‰€éœ€è¦çš„å‚æ•°ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä¸€æ­¥æ­¥è¿›è¡Œç»˜åˆ¶äº†ï¼š 1. é¦–å…ˆæ˜¯ç»˜åˆ¶åœ†ï¼Œè¿™é‡Œæˆ‘ä»¬å®šä¹‰äº†å››ä¸ªå‚æ•°åˆ†åˆ«è¡¨ç¤ºåœ†å¿ƒ Xï¼ŒY çš„åæ ‡ã€åŠå¾„ä»¥åŠç»˜åˆ¶æ‰€éœ€è¦çš„ç”»ç¬”ï¼Œç„¶åå¯¹è¿™äº›å‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆåœ¨ onDraw è¿›è¡Œç»˜åˆ¶ã€‚</p><pre><code><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RingPercentDemo</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCircleX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCircleY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mRadius;</span><br><span class="line">    <span class="keyword">private</span> Paint mCirclePaint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        mCircleX = <span class="number">300</span>;</span><br><span class="line">        mCircleY = <span class="number">300</span>;</span><br><span class="line">        mRadius = <span class="number">260</span>;</span><br><span class="line">        mCirclePaint = <span class="keyword">new</span> Paint();</span><br><span class="line">        mCirclePaint.setColor(Color.BLUE);</span><br><span class="line">        mCirclePaint.setStrokeWidth(<span class="number">10</span>);</span><br><span class="line">        mCirclePaint.setStyle(Style.STROKE); <span class="comment">//ç»˜åˆ¶ç©ºå¿ƒåœ†æ‰€ä»¥ä¸éœ€è¦å¡«å……</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        canvas.drawCircle(mCircleX, mCircleY, mRadius, mCirclePaint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre><ol start="2" type="1"><li><p>æ¥ä¸‹æ¥æ˜¯ç»˜åˆ¶åœ†ç¯ï¼Œä»æ•ˆæœå›¾ä¸Šå¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ†ç¯å®é™…ä¸Šæ˜¯åœ¨åœ†ä¸Šæˆªå–ä¸€æ®µåœ†å¼§è¡¨ç¤ºï¼Œæ‰€ä»¥ç»˜åˆ¶åœ†ç¯çš„çŸ©å½¢åŒºåŸŸå¯ä»¥ç¡®å®šä¸‹æ¥ï¼Œåœ¨ç¡®å®šäº†çŸ©å½¢åŒºåŸŸä¹‹ååªéœ€è¦è‡ªå·±è®¾å®šèµ·å§‹çš„è§’åº¦å’Œæ‰«è¿‡çš„è§’åº¦å³å¯ä»¥ç»˜åˆ¶å‡ºåœ¨åœ†ä¸Šçš„åœ†å¼§ã€‚</p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RingPercentDemo</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> RectF mRecF;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mStartAngle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">float</span> mSweepAngle;</span><br><span class="line">    <span class="keyword">private</span> Paint mRingPaint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        mRecF = <span class="keyword">new</span> RectF(mCircleX - mRadius, mCircleY - mRadius,</span><br><span class="line">            mCircleX + mRadius, mCircleY + mRadius);</span><br><span class="line">        mStartAngle = -<span class="number">90f</span>;</span><br><span class="line">        mSweepAngle = <span class="number">120f</span>;</span><br><span class="line">        mRingPaint = <span class="keyword">new</span> Paint();</span><br><span class="line">        mRingPaint.setColor(Color.RED);</span><br><span class="line">        mRingPaint.setStrokeWidth(<span class="number">20</span>);</span><br><span class="line">        mRingPaint.setStyle(Style.STROKE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        canvas.drawArc(mRecF, mStartAngle, mSweepAngle,</span><br><span class="line">            <span class="keyword">false</span>, mRingPaint); <span class="comment">//è®¾ç½®ä¸º false ä¸ä¸ä¸­å¿ƒç‚¹è¿›è¡Œè¿æ¥</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li><li><p>æœ€åæ˜¯ç»˜åˆ¶æ–‡æœ¬ï¼Œç”±äºè¦ç»˜åˆ¶åœ¨åœ†çš„ä¸­å¿ƒï¼Œæ‰€ä»¥æ–‡æœ¬çš„åæ ‡æˆ‘ä»¬é¦–å…ˆè®¾ç½®ä¸ºåœ†çš„ä¸­å¿ƒï¼Œç„¶åç»˜åˆ¶çš„é£æ ¼é€‰ä¸º Align.CENTERï¼Œè¿™æ ·æ–‡æœ¬å°†ä»¥è®¾å®šçš„åæ ‡ç‚¹å‘ä¸¤è¾¹å»¶ä¼¸ä¿è¯äº† X å¤„äºä¸­å¿ƒä½ç½®ã€‚</p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RingPercentDemo</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextY;</span><br><span class="line">    <span class="keyword">private</span> Paint mTextPaint;</span><br><span class="line">    <span class="keyword">private</span> String mTextStr;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        mTextPaint = <span class="keyword">new</span> Paint();</span><br><span class="line">        mTextPaint.setColor(Color.BLACK);</span><br><span class="line">        mTextPaint.setStyle(Style.FILL);</span><br><span class="line">        mTextPaint.setTextSize(<span class="number">40</span>);</span><br><span class="line">        mTextPaint.setTextAlign(Align.CENTER);</span><br><span class="line">        mTextPaint.setTextSize(mRadius / <span class="number">2</span>);</span><br><span class="line">        mTextX = mCircleX;</span><br><span class="line">        mTextY = mCircleY;</span><br><span class="line">        mTextStr = <span class="string">"33%"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        canvas.drawText(mTextStr, mTextX, mTextY, mTextPaint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®é™…æ•ˆæœå›¾ï¼š <img src="https://i.imgur.com/9ZYvei1.jpg" alt="tips1"> è¿™ä¸ªæ—¶å€™æˆ‘ä»¬èƒ½å¤Ÿå‘ç°æ–‡æœ¬å®è´¨ä¸Šä¸åœ¨ä¸­å¿ƒä½ç½®ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨è®¾å®šçš„åæ ‡æ˜¯ç”¨äºç¡®å®šç»˜åˆ¶çš„<strong>åŸºå‡†çº¿</strong>è€Œä¸æ˜¯ç»˜åˆ¶çš„ä¸­å¿ƒç‚¹ï¼Œæ‰€ä»¥è‡ªç„¶æ–‡æœ¬ä¸å¯èƒ½ç»˜åˆ¶åœ¨æ­£ä¸­å¿ƒï¼Œå…·ä½“å¯ä»¥å€Ÿç”¨ä¸‹å›¾æ¥è¿›è¡Œæè¿°ï¼š <img src="https://i.imgur.com/vOewNzN.jpg"> ä»è¿™å°±å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œæ–‡æœ¬çš„ä¸­å¿ƒå’Œè®¾å®šçš„åæ ‡ä¹‹é—´æ˜¯å­˜åœ¨ä¸€ä¸ªåç§»é‡çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä½¿æ–‡æœ¬å¤„äºçœŸæ­£çš„ä¸­å¿ƒï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å¾—åˆ°è¿™ä¸ªåç§»é‡ï¼Œç„¶åå°†ä¹‹å‰è®¾å®šçš„åŸºå‡†çº¿ä¸‹ç§»ã€‚åœ¨è®¡ç®—åç§»é‡ä¹‹å‰é¦–å…ˆéœ€è¦äº†è§£å­—ä½“æ˜¯å¦‚ä½•è¿›è¡Œæµ‹é‡çš„ï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://i.imgur.com/xwZqHv9.jpg"> å…¶ä¸­ Top è¡¨ç¤ºåŸºå‡†çº¿ä»¥ä¸Šå¯ç»˜åˆ¶çš„æœ€å¤§è·ç¦»ï¼ˆè´Ÿæ•°ï¼‰ï¼ŒBottom è¡¨ç¤ºåŸºå‡†çº¿ä»¥ä¸‹å¯ç»˜åˆ¶çš„æœ€å¤§è·ç¦»ï¼ˆæ­£æ•°ï¼‰ï¼ŒAscent è¡¨ç¤ºåŸºå‡†çº¿ä»¥ä¸Šæ¨èçš„å¯ç»˜åˆ¶çš„è·ç¦»ï¼ŒDescent è¡¨ç¤ºåŸºå‡†çº¿ä»¥ä¸‹æ¨èçš„å¯ç»˜åˆ¶çš„è·ç¦»ã€‚ äº†è§£å®Œè¿™ä¸€åˆ‡ä¹‹åå¦‚ä½•è®¡ç®—åç§»é‡å°±å¾ˆç®€å•äº†ï¼Œé€šè¿‡ FontMetrics è·å– Bottom å’Œ Topï¼Œç„¶åé€šè¿‡ ((Bottom - Top) / 2) - Bottom æœ€ç»ˆå–å¾—åç§»é‡ã€‚ä»£ç åšå¦‚ä¸‹ä¿®æ”¹ï¼š</p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RingPercentDemo</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextX;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTextY;</span><br><span class="line">    <span class="keyword">private</span> Paint mTextPaint;</span><br><span class="line">    <span class="keyword">private</span> String mTextStr;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        FontMetrics fontMetrics = mTextPaint.getFontMetrics();</span><br><span class="line">        <span class="keyword">float</span> offsetY = ((fontMetrics.bottom - fontMetrics.top) / <span class="number">2</span>) - fontMetrics.bottom;</span><br><span class="line">        mTextY = (<span class="keyword">int</span>) (mCircleY + offsetY);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¹‹åçš„æ•ˆæœï¼š <img src="https://i.imgur.com/M9hzVs4.jpg" alt="tip2"></p><h2 id="æ”¹è¿›">æ”¹è¿›</h2><h3 id="è‡ªå®šä¹‰å±æ€§">è‡ªå®šä¹‰å±æ€§</h3><p>ç»è¿‡ä¸Šè¿°è¿‡ç¨‹ï¼Œè™½ç„¶åœ†ç¯ç™¾åˆ†æ¯”çš„æ•ˆæœå·²ç»å®ç°ï¼Œä½†æ˜¯è·Ÿæ•ˆæœå›¾ä¸­çš„è¿˜æ˜¯å·®çš„å¾ˆè¿œï¼Œè€Œä¸”ä¹Ÿä¸èƒ½å¤Ÿçµæ´»ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©è‡ªå®šä¹‰å±æ€§å»æ”¹è¿›æˆ‘ä»¬çš„åœ†ç¯ã€‚</p><ol type="1"><li><p>é¦–å…ˆéœ€è¦åœ¨ values æ–‡ä»¶å¤¹ä¸‹åˆ›å»º attrs.xml æ–‡ä»¶åœ¨é‡Œé¢å£°æ˜æˆ‘ä»¬éœ€è¦å®šä¹‰çš„å±æ€§ï¼š <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"RingPercentDemo"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"radius"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"color"</span> <span class="attr">name</span>=<span class="string">"circleColor"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"circleStrokeWidth"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"circleStyle"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"color"</span> <span class="attr">name</span>=<span class="string">"ringColor"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"ringStrokeWidth"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"startAngle"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"sweepAngle"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">format</span>=<span class="string">"integer"</span> <span class="attr">name</span>=<span class="string">"rate"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure></p></li><li><p>ç„¶ååœ¨æ„é€ å‡½æ•°è·å–åˆ°è‡ªå®šä¹‰çš„å±æ€§çš„å±æ€§å€¼</p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RingPercentDemo</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line"></span><br><span class="line">        TypedArray typedArray = context.obtainStyledAttributes(</span><br><span class="line">            attrs, R.styleable.RingPercentDemo);</span><br><span class="line"></span><br><span class="line">        mRadius = typedArray.getInteger(R.styleable.RingPercentDemo_radius, <span class="number">60</span>);</span><br><span class="line">        mCircleColor = typedArray.getColor(</span><br><span class="line">            R.styleable.RingPercentDemo_circleColor, Color.GREEN);</span><br><span class="line">        mCircleStrokeWidth = typedArray.getInteger(</span><br><span class="line">            R.styleable.RingPercentDemo_circleStrokeWidth, <span class="number">5</span>);</span><br><span class="line">        mCircleStyle = typedArray.getInteger(</span><br><span class="line">            R.styleable.RingPercentDemo_circleStyle, <span class="number">0</span>);</span><br><span class="line">        mRingColor = typedArray.getColor(</span><br><span class="line">            R.styleable.RingPercentDemo_ringColor, Color.RED);</span><br><span class="line">        mRingStrokeWidth = typedArray.getColor(</span><br><span class="line">            R.styleable.RingPercentDemo_ringStrokeWidth, <span class="number">10</span>);</span><br><span class="line">        mStartAngle = typedArray.getInteger(</span><br><span class="line">            R.styleable.RingPercentDemo_startAngle, -<span class="number">90</span>);</span><br><span class="line">        mSweepAngle = typedArray.getInteger(</span><br><span class="line">            R.styleable.RingPercentDemo_sweepAngle, <span class="number">90</span>);</span><br><span class="line">        mRate = typedArray.getInteger(R.styleable.RingPercentDemo_rate, <span class="number">100</span>);</span><br><span class="line">        typedArray.recycle();</span><br><span class="line"></span><br><span class="line">        init();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p></li><li><p>åœ¨è·å–åˆ°è¿™äº›å±æ€§å€¼ä¹‹ååªéœ€è¦ç»™å¯¹åº”çš„ Paint å’Œå˜é‡è®¾ç½®å¯¹åº”çš„å€¼å³å¯ã€‚</p></li></ol><h3 id="å›ºå®šåœ†å¿ƒå’ŒåŠ¨æ€å˜åŒ–">å›ºå®šåœ†å¿ƒå’ŒåŠ¨æ€å˜åŒ–</h3><ol type="1"><li><p>åœ†å¿ƒçš„ä½ç½®æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿä¸€ç›´å¤„äº View çš„ä¸­å¿ƒï¼Œæ‰€ä»¥éœ€è¦é‡å†™ onMeasure æ–¹æ³•ï¼Œåœ¨ onMeasure æ–¹æ³•é€šè¿‡è·å– View çš„é«˜åº¦å’Œå®½åº¦å¾—åˆ°äº† View çš„ä¸­å¿ƒç‚¹åæ ‡ï¼Œä»è€Œä½¿å¾—åœ†å¿ƒä¸€ç›´åœ¨ View çš„ä¸­å¿ƒã€‚</p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">    setMeasuredDimension(measuse(widthMeasureSpec), measuse(heightMeasureSpec));</span><br><span class="line"></span><br><span class="line">    mCircleX = getMeasuredWidth() / <span class="number">2</span>;</span><br><span class="line">    mCircleY = getMeasuredHeight() / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ¤æ–­è®¾å®šçš„åœ†æ˜¯å¦è¶…å‡ºæ˜¾ç¤ºèŒƒå›´ï¼Œå¦‚æœè¶…å‡ºéœ€è¦ç¼©å°</span></span><br><span class="line">    <span class="keyword">if</span> (mCircleX &lt; mRadius) &#123;</span><br><span class="line">        mRadius = mCircleX - mCircleStrokeWidth - mRingStrokeWidth;</span><br><span class="line">        mTextPaint.setTextSize(mRadius / <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mCircleY &lt; mRadius) &#123;</span><br><span class="line">        mRadius = mCircleY - mCircleStrokeWidth - mRingStrokeWidth;</span><br><span class="line">        mTextPaint.setTextSize(mRadius / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FontMetrics fontMetrics = mTextPaint.getFontMetrics();</span><br><span class="line">    <span class="keyword">int</span> offsetY = (<span class="keyword">int</span>) (((fontMetrics.bottom - fontMetrics.top)) / <span class="number">2</span> - fontMetrics.bottom);</span><br><span class="line">    mTextX = mCircleX;</span><br><span class="line">    mTextY = mCircleY + offsetY;</span><br><span class="line"></span><br><span class="line">    mRecF = <span class="keyword">new</span> RectF(mCircleX - mRadius, mCircleY - mRadius,</span><br><span class="line">        mCircleX + mRadius, mCircleY + mRadius);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li><li><p>åœ¨è§£å†³äº†åœ†å¿ƒçš„é—®é¢˜ä¹‹åï¼Œè¿˜éœ€è¦ä¸ºåœ†å¼§æä¾›åŠ¨æ€å˜åŒ–çš„æ•ˆæœï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡ä¸æ–­é‡ç»˜è¾¾æˆç›®æ ‡ã€‚</p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line"></span><br><span class="line">    canvas.drawCircle(mCircleX, mCircleY, mRadius, mCirclePaint);</span><br><span class="line">    canvas.drawArc(mRecF, mStartAngle, mCurrentAngle, <span class="keyword">false</span>, mRingPaint);</span><br><span class="line">    canvas.drawText(mTextStr, mTextX, mTextY, mTextPaint);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCurrentAngle &lt; mSweepAngle) &#123;</span><br><span class="line">        mCurrentAngle += <span class="number">3.6</span>;</span><br><span class="line">        mTextStr = mCurrentAngle * <span class="number">100</span> / <span class="number">360</span> + <span class="string">"%"</span>;</span><br><span class="line">        postInvalidateDelayed(mRate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li></ol><p><a href="https://github.com/firstdream10/RingPercent" target="_blank" rel="noopener">ç›¸å…³æµ‹è¯•å·¥ç¨‹</a></p><h2 id="æ€»ç»“">æ€»ç»“</h2><p>æ¶‰åŠåˆ° View çš„ç»˜åˆ¶éœ€è¦å¯¹å…ƒç´ è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åè¿›è¡Œå•ç‹¬å¤„ç†ï¼Œè¿™æ ·æ€è·¯ä¼šæ¯”è¾ƒæ¸…æ™°</p><h2 id="thanks">Thanks</h2><ol type="1"><li><a href="http://www.cnblogs.com/slgkaifa/p/7101297.html" target="_blank" rel="noopener">android canvas drawText()æ–‡å­—å±…ä¸­</a></li><li><a href="http://blog.csdn.net/nugongahou110/article/details/49159189" target="_blank" rel="noopener">Androidè‡ªå®šä¹‰æ§ä»¶ä¹‹ç™¾åˆ†æ¯”åœ†ç¯è¿›åº¦æ¡</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰è¨€&quot;&gt;å‰è¨€&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘åšä¸€ä¸ªç®€å•çš„æµ‹è¯• APP çš„æ—¶å€™éœ€è¦å°†æ‰‹æœºçš„å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µæ˜¾ç¤ºå‡ºæ¥ï¼Œåˆšå¥½çœ‹è§ 360 æ¸…ç†å¤§å¸ˆçš„å­˜å‚¨ç©ºé—´æ˜¯ä»¥ç™¾åˆ†æ¯”åœ†ç¯çš„æ–¹å¼å®ç°çš„ï¼Œæ‰€ä»¥å¤§è‡´æ¨¡ä»¿äº†ä¸€ä¸‹å®ƒçš„å®ç°è¿‡ç¨‹ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="AndroidåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Android%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="è‡ªå®šä¹‰æ§ä»¶" scheme="http://www.ikroal.xyz/tags/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>Android è¿›é˜¶ä¹‹ Binder æµ…è§£</title>
    <link href="http://www.ikroal.xyz/2017/09/03/Android%E8%BF%9B%E9%98%B6%E4%B9%8BBinder%E6%B5%85%E8%A7%A3/"/>
    <id>http://www.ikroal.xyz/2017/09/03/Androidè¿›é˜¶ä¹‹Binderæµ…è§£/</id>
    <published>2017-09-03T13:43:27.000Z</published>
    <updated>2019-05-13T08:27:23.804Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ä»€ä¹ˆæ˜¯-binder">ä»€ä¹ˆæ˜¯ Binder</h4><p>Binder æ˜¯ Android ä¸­ä¸€ç§è·¨è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰æ–¹å¼ã€‚<a id="more"></a> #### Binder çš„åŸç† Binderé€šä¿¡é‡‡ç”¨C/Sæ¶æ„ï¼Œä»ç»„ä»¶è§†è§’æ¥è¯´ï¼ŒåŒ…å« Clientã€Serverã€ServiceManager ä»¥åŠ binder é©±åŠ¨ï¼Œå…¶ä¸­ ServiceManager ç”¨äºç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚æ¶æ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/ikroal/blog-images/master/binder-principle.png"></p><ul><li>æ­¤å¤„çš„ Service Manager æ˜¯æŒ‡ Native å±‚çš„ ServiceManagerï¼ˆC++ï¼‰</li><li>æ³¨å†ŒæœåŠ¡(addService)ï¼šServer è¿›ç¨‹è¦å…ˆæ³¨å†Œ Service åˆ° ServiceManagerã€‚è¯¥è¿‡ç¨‹ï¼šServer æ˜¯å®¢æˆ·ç«¯ï¼ŒServiceManager æ˜¯æœåŠ¡ç«¯ã€‚</li><li>è·å–æœåŠ¡(getService)ï¼šClient è¿›ç¨‹ä½¿ç”¨æŸä¸ª Service å‰ï¼Œé¡»å…ˆå‘ ServiceManager ä¸­è·å–ç›¸åº”çš„ Serviceã€‚è¯¥è¿‡ç¨‹ï¼šClient æ˜¯å®¢æˆ·ç«¯ï¼ŒServiceManager æ˜¯æœåŠ¡ç«¯ã€‚</li><li>ä½¿ç”¨æœåŠ¡ï¼šClient æ ¹æ®å¾—åˆ°çš„ Service ä¿¡æ¯å»ºç«‹ä¸ Service æ‰€åœ¨çš„ Server è¿›ç¨‹é€šä¿¡çš„é€šè·¯ï¼Œç„¶åå°±å¯ä»¥ç›´æ¥ä¸ Service äº¤äº’ã€‚è¯¥è¿‡ç¨‹ï¼šClient æ˜¯å®¢æˆ·ç«¯ï¼ŒServer æ˜¯æœåŠ¡ç«¯ã€‚</li></ul><h4 id="binder-çš„ç»“æ„">Binder çš„ç»“æ„</h4><p>åœ¨å­¦ä¹  Binder çš„ç»“æ„çš„æ—¶å€™ï¼Œå¯ä»¥åˆ©ç”¨ AIDL å»ç”Ÿæˆ Binderï¼Œè¿™é‡Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ªå®ç°äº† Parcelable æ¥å£çš„ Book ç±»ï¼Œç„¶ååœ¨ main æ–‡ä»¶å¤¹ä¸‹åˆ›å»º AIDL æ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«åˆ›å»º Book.aidlã€IBookManager.aidlã€‚ä¸‰ä¸ªæ–‡ä»¶çš„ä»£ç åˆ†åˆ«å¦‚ä¸‹ï¼š <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Book.java</span></span><br><span class="line"><span class="keyword">package</span> com.rookieyang.aidltest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Parcel;</span><br><span class="line"><span class="keyword">import</span> android.os.Parcelable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by firstdream on 2017/9/4.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mBookId;</span><br><span class="line">    <span class="keyword">private</span> String mBookName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(<span class="keyword">int</span> mBookId, String mBookName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mBookId = mBookId;</span><br><span class="line">        <span class="keyword">this</span>.mBookName = mBookName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeToParcel</span><span class="params">(Parcel parcel, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        parcel.writeInt(mBookId);</span><br><span class="line">        parcel.writeString(mBookName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">describeContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Parcelable.Creator&lt;Book&gt; CREATOR = <span class="keyword">new</span> Creator&lt;Book&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Book <span class="title">createFromParcel</span><span class="params">(Parcel parcel)</span> </span>&#123;</span><br><span class="line">            Book book = <span class="keyword">new</span> Book(parcel.readInt(), parcel.readString());</span><br><span class="line">            <span class="keyword">return</span> book;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Book[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Book[size];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Book.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.rookieyang.aidltest;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line">parcelable Book;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IBookManager.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.rookieyang.aidltest;</span><br><span class="line"></span><br><span class="line"><span class="comment">//éœ€è¦å¯¼å…¥ Book ç±»</span></span><br><span class="line"><span class="keyword">import</span> com.rookieyang.aidltest.Book;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Demonstrates some basic types that you can use as parameters</span></span><br><span class="line"><span class="comment">     * and return values in AIDL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addBook</span><span class="params">(in Book book)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨ç»è¿‡ä¸Šè¿°çš„è¿‡ç¨‹ä¹‹åï¼Œç‚¹å‡»ç¼–è¯‘å³å¯ç”Ÿæˆ Binder æ–‡ä»¶ï¼Œä»¥ IBookManager.aidl ç”Ÿæˆçš„ IBookManager.java ä¸ºä¾‹ï¼Œ IBookManager.java ä¸­å®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿è‡ª IInterface çš„ IBookManager æ¥å£ï¼Œåœ¨ IBookManager å†…åŒ…å«äº†ç»§æ‰¿è‡ª Binder å®ç°äº† IBookManager æ¥å£çš„å†…éƒ¨ç±» Stub å’Œ å®ç°äº† IBookManager æ¥å£çš„ Stub çš„å†…éƒ¨ç±» Proxyã€‚æ•´ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/ikroal/blog-images/master/IBookManager.png"> ä¸‹é¢é’ˆå¯¹ IBookManager.java è¿›è¡Œå…·ä½“çš„åˆ†æï¼š</p><ul><li>IBookManager æ¥å£ï¼Œè¿™ä¸ªæ¥å£ä¸åœ¨ IBookManager.aidl ä¸­ä¸€è‡´<ul><li>getBookList()</li><li>addBook(Book book)</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IBookManager</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Demonstrates some basic types that you can use as parameters</span></span><br><span class="line"><span class="comment">     * and return values in AIDL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Stub ç±»<ul><li>DESCRIPTOR</li><li>Binder çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€èˆ¬ç”¨å½“å‰ Binder çš„ç±»åè¡¨ç¤º</li><li>TRANSACTION_getBookList å’Œ TRANSACTION_addBook</li><li>ä¸¤ä¸ªidç”¨äºæ ‡è¯†åœ¨transactè¿‡ç¨‹ä¸­å®¢æˆ·ç«¯æ‰€è¯·æ±‚çš„åˆ°åº•æ˜¯å“ªä¸ªæ–¹æ³•</li><li>asInterface(IBinder obj)</li><li>ç”¨äºå°†æœåŠ¡ç«¯çš„ Binder å¯¹è±¡è½¬æ¢æˆå®¢æˆ·ç«¯æ‰€éœ€çš„ AIDL æ¥å£ç±»å‹çš„å¯¹è±¡ï¼Œè¿™ç§è½¬æ¢è¿‡ç¨‹æ˜¯åŒºåˆ†è¿›ç¨‹çš„ï¼Œå¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½äºåŒä¸€è¿›ç¨‹ï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•è¿”å›çš„å°±æ˜¯æœåŠ¡ç«¯çš„ Stub å¯¹è±¡æœ¬èº«ï¼Œå¦åˆ™è¿”å›çš„æ˜¯ç³»ç»Ÿå°è£…åçš„ Stub.proxy å¯¹è±¡ã€‚</li><li>asBinder</li><li>æ­¤æ–¹æ³•ç”¨äºè¿”å›å½“å‰ Binder å¯¹è±¡ã€‚</li><li>onTransact</li><li>è¿™ä¸ªæ–¹æ³•è¿è¡Œåœ¨æœåŠ¡ç«¯ä¸­çš„ Binder çº¿ç¨‹æ± ä¸­ï¼Œå½“å®¢æˆ·ç«¯å‘èµ·è·¨è¿›ç¨‹è¯·æ±‚æ—¶ï¼Œè¿œç¨‹è¯·æ±‚ä¼šé€šè¿‡ç³»ç»Ÿåº•å±‚å°è£…åäº¤ç”±æ­¤æ–¹æ³•æ¥å¤„ç†ã€‚</li><li>æœåŠ¡ç«¯é€šè¿‡ code å¯ä»¥ç¡®å®šå®¢æˆ·ç«¯æ‰€è¯·æ±‚çš„ç›®æ ‡æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œæ¥ç€ä» data ä¸­å–å‡ºç›®æ ‡æ–¹æ³•æ‰€éœ€çš„å‚æ•°ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æœ‰å‚æ•°çš„è¯ï¼‰ï¼Œç„¶åæ‰§è¡Œç›®æ ‡æ–¹æ³•ã€‚å½“ç›®æ ‡æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œå°±å‘ reply ä¸­å†™å…¥è¿”å›å€¼ï¼ˆå¦‚æœç›®æ ‡æ–¹æ³•æœ‰è¿”å›å€¼çš„è¯ï¼‰ï¼ŒonTransact æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯è¿™æ ·çš„ã€‚</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">    <span class="title">IBookManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DESCRIPTOR = <span class="string">"com.rookieyang.binderdemo.IBookManager"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Construct the stub at attach it to the interface.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stub</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.attachInterface(<span class="keyword">this</span>, DESCRIPTOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cast an IBinder object into an IBookManager interface,</span></span><br><span class="line"><span class="comment">     * generating a proxy if needed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBookManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((obj == <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        IInterface iin = obj.queryLocalInterface(DESCRIPTOR);</span><br><span class="line">        <span class="keyword">if</span> (((iin != <span class="keyword">null</span>) &amp;&amp; (iin <span class="keyword">instanceof</span> IBookManager))) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((IBookManager) iin);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IBookManager.Stub.Proxy(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">            <span class="keyword">case</span> INTERFACE_TRANSACTION: &#123;</span><br><span class="line">                reply.writeString(DESCRIPTOR);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> TRANSACTION_getBookList: &#123;</span><br><span class="line">                data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                List&lt;Book&gt; _result = <span class="keyword">this</span>.getBookList();</span><br><span class="line">                reply.writeNoException();</span><br><span class="line">                reply.writeTypedList(_result);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> TRANSACTION_addBook: &#123;</span><br><span class="line">                data.enforceInterface(DESCRIPTOR);</span><br><span class="line">                Book _arg0;</span><br><span class="line">                <span class="keyword">if</span> ((<span class="number">0</span> != data.readInt())) &#123;</span><br><span class="line">                    <span class="comment">//ååºåˆ—åŒ–</span></span><br><span class="line">                    _arg0 = Book.CREATOR.createFromParcel(data);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    _arg0 = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.addBook(_arg0);</span><br><span class="line">                reply.writeNoException();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTransact(code, data, reply, flags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_getBookList = (IBinder.FIRST_CALL_TRANSACTION + <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TRANSACTION_addBook = (IBinder.FIRST_CALL_TRANSACTION + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Proxy ç±»<ul><li>getBookList</li><li>è¿™ä¸ªæ–¹æ³•è¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼Œå½“å®¢æˆ·ç«¯è¿œç¨‹è°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼Œå®ƒçš„å†…éƒ¨å®ç°æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆåˆ›å»ºè¯¥æ–¹æ³•æ‰€éœ€è¦çš„è¾“å…¥å‹ Parcel å¯¹è±¡ _data ã€è¾“å‡ºå‹ Parcel å¯¹è±¡ _reply å’Œè¿”å›å€¼å¯¹è±¡ Listï¼›ç„¶åæŠŠè¯¥æ–¹æ³•çš„å‚æ•°ä¿¡æ¯å†™å…¥ _data ä¸­ï¼ˆå¦‚æœæœ‰å‚æ•°çš„è¯ï¼‰ï¼›æ¥ç€è°ƒç”¨ transact æ–¹æ³•æ¥å‘èµ· RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰è¯·æ±‚ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼›ç„¶åæœåŠ¡ç«¯çš„ onTransact æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œç›´åˆ° RPC è¿‡ç¨‹è¿”å›åï¼Œå½“å‰çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œå¹¶ä» _reply ä¸­å–å‡º RPC è¿‡ç¨‹çš„è¿”å›ç»“æœï¼›æœ€åè¿”å› _reply ä¸­çš„æ•°æ®ã€‚</li><li>addBook</li><li>è¿™ä¸ªæ–¹æ³•è¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼Œå®ƒçš„æ‰§è¡Œè¿‡ç¨‹å’Œ getBookList æ˜¯ä¸€æ ·çš„ï¼ŒaddBook æ²¡æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦ä» _reply ä¸­å–å‡ºè¿”å›å€¼ã€‚</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">IBookManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> IBinder mRemote;</span><br><span class="line"></span><br><span class="line">    Proxy(IBinder remote) &#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getInterfaceDescriptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DESCRIPTOR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Demonstrates some basic types that you can use as parameters</span></span><br><span class="line"><span class="comment">     * and return values in AIDL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Book&gt; <span class="title">getBookList</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel _data = Parcel.obtain();</span><br><span class="line">        Parcel _reply = Parcel.obtain();</span><br><span class="line">        java.util.List&lt;Book&gt; _result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">            mRemote.transact(Stub.TRANSACTION_getBookList, _data, _reply, <span class="number">0</span>);</span><br><span class="line">            _reply.readException();</span><br><span class="line">            _result = _reply.createTypedArrayList(Book.CREATOR);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            _reply.recycle();</span><br><span class="line">            _data.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBook</span><span class="params">(Book book)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel _data = Parcel.obtain();</span><br><span class="line">        Parcel _reply = Parcel.obtain();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            _data.writeInterfaceToken(DESCRIPTOR);</span><br><span class="line">            <span class="keyword">if</span> ((book != <span class="keyword">null</span>)) &#123;</span><br><span class="line">                _data.writeInt(<span class="number">1</span>);</span><br><span class="line">                book.writeToParcel(_data, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _data.writeInt(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRemote.transact(Stub.TRANSACTION_addBook, _data, _reply, <span class="number">0</span>);</span><br><span class="line">            _reply.readException();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            _reply.recycle();</span><br><span class="line">            _data.recycle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="binder-çš„å·¥ä½œæœºåˆ¶">Binder çš„å·¥ä½œæœºåˆ¶</h4><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/binder-execute.png"> &gt; ä»¥ä¸Šè¿°ä¸ºä¾‹ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ getBookList æ–¹æ³•æ—¶ï¼Œåœ¨æ–¹æ³•å†…éƒ¨å®šä¹‰äº† Parcel å¯¹è±¡ï¼Œç„¶åé€šè¿‡è°ƒç”¨ transact å‘èµ·è¿œç¨‹è¯·æ±‚ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶åˆ°åè°ƒç”¨ onTransact æ–¹æ³•ï¼Œæ ¹æ®ä¼ é€’è¿‡æ¥çš„ Code è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå°†ç»“æœå†™å…¥ Parcel å¯¹è±¡å½“ä¸­ï¼Œå¤„ç†å®Œæˆä¹‹ååœ¨ å®¢æˆ·ç«¯çš„ transact å°†ç»“æœå–å‡ºæ¥å¹¶è¿”å›ã€‚</p><h4 id="binder-ä½¿ç”¨çš„ä¸€äº›æ³¨æ„ç‚¹">Binder ä½¿ç”¨çš„ä¸€äº›æ³¨æ„ç‚¹</h4><p>Binder ä¸€èˆ¬å’Œ Service é…åˆä½¿ç”¨ï¼Œä½œä¸º bindService æ‰§è¡Œæ—¶çš„è¿”å›ï¼Œæœ€ååœ¨ ServiceConnect å½“ä¸­è·å–è¿”å›çš„ Binderï¼š <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ServiceConnection serviceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName componentName, IBinder iBinder)</span> </span>&#123;</span><br><span class="line">        mCalcAidl = ICalcAIDL.Stub.asInterface(iBinder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> </span>&#123;</span><br><span class="line">        mCalcAidl = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><blockquote><p>ä¸åŒè¿›ç¨‹æ—¶è¿”å›çš„ iBinder æ˜¯ ICalcAIDL.Stub.Proxyï¼Œè€Œç›¸åŒè¿›ç¨‹ä¸­åˆ™æ˜¯ ICalcAIDL.Stubã€‚æ˜¯è¿”å› Stub è¿˜æ˜¯è¿”å› Proxy åœ¨åº•å±‚å·²ç»åšäº†åˆ¤æ–­ï¼Œä¸æ˜¯åœ¨ onServiceConnected æ–¹æ³•ä¸­è¿›è¡Œçš„åˆ¤æ–­</p></blockquote><p>åœ¨æœåŠ¡ä¸­ä½¿ç”¨æ—¶ï¼Œå®šä¹‰çš„ AIDL æ–‡ä»¶åŒ…åå¿…é¡»ç›¸åŒï¼Œä¸ç„¶å°†æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ AIDLï¼Œä»è€Œå¯¼è‡´æ— æ³•è¿›è¡Œé€šä¿¡ï¼Œå¹¶ä¸”ä½¿ç”¨æ—¶éœ€è¦é€šè¿‡ ICalcAIDL.Stub å®ç°åœ¨ AIDL ä¸­å®šä¹‰çš„æ¥å£ï¼Œä»è€Œä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ICalcAIDL.Stub mBinder = <span class="keyword">new</span> Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x + y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x - y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“">æ€»ç»“</h4><blockquote><p>ç²—ç•¥çš„è¯´ï¼ŒClient é€šè¿‡ Binder å½“ä¸­çš„ Proxy è¿›è¡Œäº† IPC çš„è¯·æ±‚ï¼Œè€Œ Server åˆ™é€šè¿‡ Stub å½“ä¸­çš„ onTransact å¯¹è·¨è¿›ç¨‹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œä¹‹æ‰€ä»¥èƒ½è¿›è¡Œè·¨è¿›ç¨‹è¯·æ±‚çš„åŸå› åœ¨äºåº•å±‚èƒ½å¤Ÿé€šè¿‡å¯åºåˆ—åŒ–çš„æ•°æ®ï¼Œä¸Šè¿°çš„ Book ç±»å®ç°äº† Parcelable æ¥å£ï¼Œè€ŒåŸºæœ¬ç±»å‹æ˜¯è¢«çœ‹ä½œå¯åºåˆ—åŒ–çš„ï¼Œæ‰€ä»¥è¿™äº›æ•°æ®åœ¨åº•å±‚èƒ½å¤Ÿè¿›è¡Œä¼ è¾“ï¼Œè‡ªç„¶å°±å¯ä»¥é€šè¿‡ Binder å®Œæˆ IPCã€‚</p></blockquote><hr><h4 id="å‚è€ƒ">å‚è€ƒ</h4><ol type="1"><li>Android å¼€å‘è‰ºæœ¯æ¢ç´¢-IPC æœºåˆ¶</li><li><a href="http://blog.csdn.net/lmj623565791/article/details/38461079/" target="_blank" rel="noopener">Android aidl Binderæ¡†æ¶æµ…æ</a></li><li><a href="http://weishu.me/2016/01/12/binder-index-for-newer/" target="_blank" rel="noopener">Binderå­¦ä¹ æŒ‡å—</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;ä»€ä¹ˆæ˜¯-binder&quot;&gt;ä»€ä¹ˆæ˜¯ Binder&lt;/h4&gt;
&lt;p&gt;Binder æ˜¯ Android ä¸­ä¸€ç§è·¨è¿›ç¨‹é€šä¿¡ï¼ˆIPCï¼‰æ–¹å¼ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Androidè¿›é˜¶" scheme="http://www.ikroal.xyz/categories/Android%E8%BF%9B%E9%98%B6/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="IPC" scheme="http://www.ikroal.xyz/tags/IPC/"/>
    
  </entry>
  
  <entry>
    <title>Android åŸºç¡€ä¹‹ Service</title>
    <link href="http://www.ikroal.xyz/2017/08/27/Android%E5%9F%BA%E7%A1%80%E4%B9%8BService/"/>
    <id>http://www.ikroal.xyz/2017/08/27/AndroidåŸºç¡€ä¹‹Service/</id>
    <published>2017-08-27T10:04:55.000Z</published>
    <updated>2019-05-13T08:24:03.455Z</updated>
    
    <content type="html"><![CDATA[<h4 id="service-çš„å«ä¹‰åŠä½œç”¨">Service çš„å«ä¹‰åŠä½œç”¨</h4><p>Service æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨åå°æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œæ“ä½œè€Œä¸éœ€è¦æä¾›ç”¨æˆ·ç•Œé¢çš„åº”ç”¨ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ Service æ˜¯ä¸ºäº†å»å¤„ç†é‚£äº›ä¸éœ€è¦å’Œç”¨æˆ·äº¤äº’ä½†åˆè€—æ—¶çš„æ“ä½œã€‚ä½†æ˜¯å¦‚æœ Service åªæ˜¯ä¸ºäº†æ‰§è¡Œé‚£äº›è€—æ—¶çš„æ“ä½œçš„è¯ï¼Œå…¶å®åªç”¨çº¿ç¨‹ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„ç›®çš„ï¼Œä¹‹æ‰€ä»¥éœ€è¦å•ç‹¬ç”¨ Service æ¥è¿›è¡Œå®ç°çš„åŸå› åœ¨äº Service ç›¸è¾ƒä¹‹çº¿ç¨‹è€Œè¨€ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ï¼Œå¹¶ä¸” Service é€šè¿‡ç»‘å®šå¯åŠ¨çš„æ—¶å€™æ˜¯å¯æ§çš„ï¼Œå¦‚æœç³»ç»Ÿä¸æ˜¯æç«¯ä¸å¤Ÿç”¨ï¼Œä¸€èˆ¬è€Œè¨€æ˜¯ä¸ä¼šæ€æ­» Serviceï¼Œä½†æ˜¯çº¿ç¨‹å¯èƒ½å­˜åœ¨è¢«ç³»ç»Ÿå›æ”¶çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥ Service çš„å¯é æ€§è¦æ¯”çº¿ç¨‹é«˜ã€‚<a id="more"></a> å¦å¤–å…³äº Serviceï¼Œå®˜ç½‘ä¸Šè¿˜æœ‰å¦‚ä¸‹çš„æç¤ºï¼š &gt; æœåŠ¡åœ¨å…¶æ‰˜ç®¡è¿›ç¨‹çš„ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œå®ƒæ—¢ä¸åˆ›å»ºè‡ªå·±çš„çº¿ç¨‹ï¼Œä¹Ÿä¸åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œï¼ˆé™¤éå¦è¡ŒæŒ‡å®šï¼‰ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœæœåŠ¡å°†æ‰§è¡Œä»»ä½• CPU å¯†é›†å‹å·¥ä½œæˆ–é˜»æ­¢æ€§æ“ä½œï¼ˆä¾‹å¦‚ MP3 æ’­æ”¾æˆ–è”ç½‘ï¼‰ï¼Œåˆ™åº”åœ¨æœåŠ¡å†…åˆ›å»ºæ–°çº¿ç¨‹æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚é€šè¿‡ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹ï¼Œå¯ä»¥é™ä½å‘ç”Ÿâ€œåº”ç”¨æ— å“åº”â€(ANR) é”™è¯¯çš„é£é™©ï¼Œè€Œåº”ç”¨çš„ä¸»çº¿ç¨‹ä»å¯ç»§ç»­ä¸“æ³¨äºè¿è¡Œç”¨æˆ·ä¸ Activity ä¹‹é—´çš„äº¤äº’</p><h4 id="service-çš„ç”Ÿå‘½å‘¨æœŸ">Service çš„ç”Ÿå‘½å‘¨æœŸ</h4><p>Service çš„ç”Ÿå‘½å‘¨æœŸä¸»è¦å’ŒæœåŠ¡çš„ä½¿ç”¨æ–¹å¼æœ‰å…³ï¼Œä½¿ç”¨æœåŠ¡ä¸»è¦åˆ†ä¸ºå¯åŠ¨å’Œç»‘å®šä¸¤ç§æ–¹å¼ï¼Œå…¶ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š <img src="https://raw.githubusercontent.com/ikroal/blog-images/master/service-life-cycle.png"></p><h4 id="service-çš„åŸºæœ¬ä½¿ç”¨">Service çš„åŸºæœ¬ä½¿ç”¨</h4><ol type="1"><li>åˆ›å»ºæœåŠ¡ ç³»ç»Ÿæä¾›äº†ä¸€ä¸ª Service æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå·±å®ç°ä¸€ä¸ªç»§æ‰¿è‡ª Service çš„ç±»ï¼Œç„¶ååœ¨ AndroidManifest.xml æ³¨å†Œå³å¯ã€‚</li><li>è¿è¡ŒæœåŠ¡ è¿è¡ŒæœåŠ¡ä¸»è¦æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯è°ƒç”¨ startService()ï¼Œç¬¬äºŒç§åˆ™æ˜¯ bindService()ã€‚å®é™…ä¸Šè¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥åŒæ—¶è°ƒç”¨ã€‚</li><li>æœåŠ¡ä¸­å¤„ç†äº‹ä»¶ startService å¯åŠ¨æœåŠ¡ï¼Œäº‹ä»¶çš„å¤„ç†ä¸€èˆ¬åœ¨æœåŠ¡çš„ onStartCommand æ–¹æ³•è¿›è¡Œçš„ï¼ŒbindService ç»‘å®šæœåŠ¡ä¹‹åï¼Œå°†ä¼šåœ¨ ServiceConnection çš„ onServiceConnected ä¸­è¿”å›ä¸€ä¸ª Binder å¯¹è±¡ï¼Œåˆ©ç”¨è¿”å›çš„ Binder å¯¹è±¡å¯ä»¥è°ƒç”¨ç›¸å…³çš„äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚</li><li>åœæ­¢æœåŠ¡ æœåŠ¡çš„è¿è¡Œæ¡ä»¶æ˜¯æœåŠ¡è¢«ç»‘å®šæˆ–è€…è¢«å¯åŠ¨ï¼Œæ‰€ä»¥æƒ³è®©æœåŠ¡ä¸è¿è¡Œåˆ™éœ€è¦ç ´åè¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ stopService å’Œ unbindService å®ç°ã€‚</li></ol><hr>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;service-çš„å«ä¹‰åŠä½œç”¨&quot;&gt;Service çš„å«ä¹‰åŠä½œç”¨&lt;/h4&gt;
&lt;p&gt;Service æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨åå°æ‰§è¡Œé•¿æ—¶é—´è¿è¡Œæ“ä½œè€Œä¸éœ€è¦æä¾›ç”¨æˆ·ç•Œé¢çš„åº”ç”¨ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ Service æ˜¯ä¸ºäº†å»å¤„ç†é‚£äº›ä¸éœ€è¦å’Œç”¨æˆ·äº¤äº’ä½†åˆè€—æ—¶çš„æ“ä½œã€‚ä½†æ˜¯å¦‚æœ Service åªæ˜¯ä¸ºäº†æ‰§è¡Œé‚£äº›è€—æ—¶çš„æ“ä½œçš„è¯ï¼Œå…¶å®åªç”¨çº¿ç¨‹ä¹Ÿå¯ä»¥è¾¾åˆ°åŒæ ·çš„ç›®çš„ï¼Œä¹‹æ‰€ä»¥éœ€è¦å•ç‹¬ç”¨ Service æ¥è¿›è¡Œå®ç°çš„åŸå› åœ¨äº Service ç›¸è¾ƒä¹‹çº¿ç¨‹è€Œè¨€ä¼˜å…ˆçº§æ¯”è¾ƒé«˜ï¼Œå¹¶ä¸” Service é€šè¿‡ç»‘å®šå¯åŠ¨çš„æ—¶å€™æ˜¯å¯æ§çš„ï¼Œå¦‚æœç³»ç»Ÿä¸æ˜¯æç«¯ä¸å¤Ÿç”¨ï¼Œä¸€èˆ¬è€Œè¨€æ˜¯ä¸ä¼šæ€æ­» Serviceï¼Œä½†æ˜¯çº¿ç¨‹å¯èƒ½å­˜åœ¨è¢«ç³»ç»Ÿå›æ”¶çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥ Service çš„å¯é æ€§è¦æ¯”çº¿ç¨‹é«˜ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="AndroidåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Android%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="Service" scheme="http://www.ikroal.xyz/tags/Service/"/>
    
  </entry>
  
  <entry>
    <title>Android åŸºç¡€ä¹‹ BroastCasts</title>
    <link href="http://www.ikroal.xyz/2017/08/26/Android%E4%B9%8BBroastCastReceiver/"/>
    <id>http://www.ikroal.xyz/2017/08/26/Androidä¹‹BroastCastReceiver/</id>
    <published>2017-08-26T15:06:37.000Z</published>
    <updated>2018-03-05T15:15:58.820Z</updated>
    
    <content type="html"><![CDATA[<h4 id="broadcasts-å®šä¹‰åŠå…¶ä½œç”¨">BroadCasts å®šä¹‰åŠå…¶ä½œç”¨</h4><p>BroadCasts æ˜¯ä¸€ç§å¹¿æ’­æœºåˆ¶ï¼Œç±»ä¼¼äºå‘å¸ƒ-è®¢é˜…è¿™ç§æœºåˆ¶ï¼Œå½“å‘ç”Ÿä¸€äº›äº‹ä»¶çš„æ—¶å€™ï¼Œç³»ç»Ÿæˆ–ç¨‹åºå°±ä¼šå‘é€ï¼ˆå‘å¸ƒï¼‰ä¸€äº›ç›¸å…³çš„å¹¿æ’­ï¼Œè€Œæ³¨å†Œï¼ˆè®¢é˜…ï¼‰äº†è¿™äº›å¹¿æ’­çš„ç¨‹åºå°±ä¼šé€šè¿‡å¹¿æ’­æ¥æ”¶å™¨å»å“åº”è¿™äº›å¹¿æ’­ã€‚ <a id="more"></a> #### BroadCasts çš„åˆ†ç±» 1. æŒ‰ä½œç”¨èŒƒå›´æ¥åˆ†ï¼š * å…¨å±€å¹¿æ’­ * æœ¬åœ°å¹¿æ’­ æœ¬åœ°ä¸»è¦ä¸ºäº†è§£å†³å…¨å±€å¹¿æ’­çš„å®‰å…¨æ€§é—®é¢˜ï¼Œç”±äºå…¨å±€å¹¿æ’­æ˜¯é¢å‘ç³»ç»Ÿä¸­æ‰€æœ‰åº”ç”¨çš„ï¼Œæ‰€ä»¥å½“æºå¸¦ä¸€äº›å…³é”®æ•°æ®æ—¶å¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„æ³„æ¼ã€‚ 2. æŒ‰æ¥æ”¶é¡ºåºæ¥åˆ†ï¼š * æ ‡å‡†å¹¿æ’­ æ ‡å‡†å¹¿æ’­åœ¨å‘å‡ºä¹‹åï¼Œæ‰€æœ‰ç›¸å…³çš„å¹¿æ’­æ¥æ”¶å™¨å‡ ä¹èƒ½å¤Ÿä¸€æ¬¡æ€§æ¥æ”¶åˆ°è¯¥æ¡å¹¿æ’­ã€‚ * æœ‰åºå¹¿æ’­ æœ‰åºå¹¿æ’­å‘å‡ºåï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨èƒ½å¤Ÿæ¥æ”¶åˆ°è¿™æ¡å¹¿æ’­æ¶ˆæ¯ï¼Œåªæœ‰å½“è¯¥å¹¿æ’­æ¥æ”¶å™¨å½“ä¸­çš„å¤„ç†é€»è¾‘å¤„ç†å®Œæˆä¹‹åï¼Œå¹¿æ’­æ‰èƒ½å‘ä¸‹ä¼ é€’ï¼Œå¹¶ä¸”ä¼˜å…ˆçº§é«˜çš„å¹¿æ’­èƒ½å¤Ÿæˆªæ–­æ­£åœ¨ä¼ é€’çš„å¹¿æ’­ã€‚å¦‚æœå¤šä¸ªåº”ç”¨ç¨‹åºè®¾ç½®çš„ä¼˜å…ˆçº§åˆ«ç›¸åŒï¼Œåˆ™è°å…ˆæ³¨å†Œçš„å¹¿æ’­ï¼Œè°å°±å¯ä»¥ä¼˜å…ˆæ¥æ”¶åˆ°å¹¿æ’­ã€‚</p><h4 id="broadcasts-çš„ä½¿ç”¨">BroadCasts çš„ä½¿ç”¨</h4><p>å¹¿æ’­æœºåˆ¶çš„ä½¿ç”¨æ–¹æ³•å¤§ä½“æŒ‰ç…§å¦‚ä¸‹æ­¥éª¤ï¼š</p><ol type="1"><li><p>åˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨ Android ç³»ç»Ÿæä¾›äº†ä¸€ä¸ª BroadCastReciver çš„æŠ½è±¡ç±»ï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºè‡ªå·±çš„å¹¿æ’­æ¥æ”¶å™¨ï¼Œç„¶åé‡å†™å½“ä¸­çš„ onReceive æ–¹æ³•ï¼Œåœ¨å½“ä¸­ç¼–å†™äº‹ä»¶çš„å¤„ç†é€»è¾‘ã€‚ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ForceReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(<span class="keyword">final</span> Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(context);</span><br><span class="line">        builder.setTitle(<span class="string">"æç¤º"</span>);</span><br><span class="line">        builder.setMessage(<span class="string">"å·²ç»è¢«é€€å‡º"</span>);</span><br><span class="line">        builder.setCancelable(<span class="keyword">false</span>);</span><br><span class="line">        builder.setPositiveButton(<span class="string">"OK"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialogInterface, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">                ActivityCollector.finishActivities();</span><br><span class="line">                Intent intent = <span class="keyword">new</span> Intent(context, LoginActivity.class);</span><br><span class="line">                context.startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li><li><p>æ³¨å†Œå¹¿æ’­ ä¸ºäº†è¿›è¡Œå¹¿æ’­çš„æ¥æ”¶è¿˜éœ€è¦å¯¹éœ€è¦æ¥æ”¶çš„å¹¿æ’­è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œæ–¹å¼å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š ç¬¬ä¸€ç§æ˜¯åŠ¨æ€æ³¨å†Œï¼Œå¦‚æœæ˜¯å…¨å±€å¹¿æ’­åˆ™åœ¨ Activity ä¸­ç›´æ¥è°ƒç”¨ registerReceiver æ–¹æ³•å³å¯ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ BroadCastReceiverï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯ IntentFilterã€‚å¦‚æœæ˜¯æœ¬åœ°å¹¿æ’­åˆ™éœ€è¦å€ŸåŠ©ç³»ç»Ÿæä¾›çš„ LocalBroadCastManager å»è¿›è¡Œæ³¨å†Œï¼Œæ–¹æ³•åä¸æ³¨å†Œå…¨å±€å¹¿æ’­çš„æ–¹æ³•åä¸€è‡´ã€‚ å…¨å±€å¹¿æ’­ï¼š <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter(<span class="string">"com.rookieyang.forcelogin"</span>);</span><br><span class="line">forceReceiver = <span class="keyword">new</span> ForceReceiver();</span><br><span class="line">registerReceiver(forceReceiver, intentFilter);</span><br></pre></td></tr></table></figure></p><p>æœ¬åœ°å¹¿æ’­ï¼š <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter(<span class="string">"com.rookieyang.forcelogin"</span>);</span><br><span class="line">forceReceiver = <span class="keyword">new</span> ForceReceiver();</span><br><span class="line">LocalBroadcastManager localBroadcastManager = LocalBroadcastManager.getInstance(<span class="keyword">this</span>);</span><br><span class="line">localBroadcastManager.registerReceiver(forceReceiver, intentFilter);</span><br></pre></td></tr></table></figure></p><p>ç¬¬äºŒç§æ˜¯é™æ€æ³¨å†Œï¼Œé™æ€æ³¨å†Œå¯ä»¥å®ç°åœ¨ç¨‹åºæœªå¯åŠ¨çš„æƒ…å†µä¸‹æ¥æ”¶åˆ°å¹¿æ’­ï¼Œé™æ€æ³¨å†Œçš„å¹¿æ’­æ˜¯å…¨å±€å¹¿æ’­ã€‚ <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">receiver</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".BootCompleteReceiver"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.BOOT_COMPLETED"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>ç›‘å¬ç³»ç»Ÿçš„å¼€æœºå¹¿æ’­æ˜¯éœ€è¦æ·»åŠ æƒé™çš„ï¼ŒåŠ¨æ€æ³¨å†Œç›¸æ¯”è¾ƒäºé™æ€æ³¨å†Œè€Œè¨€æ›´ä¸ºçµæ´»ï¼Œä½†æ˜¯é™æ€æ³¨å†Œèƒ½å¤Ÿå®ç°åœ¨åº”ç”¨æœªå¯åŠ¨çš„æƒ…å†µä¸‹æ¥æ”¶å¹¿æ’­ã€‚è€Œä¸”åŠ¨æ€æ³¨å†Œçš„å¹¿æ’­æœ€åå¿…é¡»è¦å–æ¶ˆæ³¨å†Œã€‚</p></blockquote></li><li><p>å‘é€å¹¿æ’­ å‘é€å¹¿æ’­éœ€è¦ä¸»è¦é€šè¿‡ Intent ä¼ é€’ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ˜¯ç³»ç»Ÿå¹¿æ’­åˆ™ä¸éœ€è¦æˆ‘ä»¬å»ç¼–ç å»å‘é€å¹¿æ’­ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰çš„å¹¿æ’­ï¼Œå‘é€æ ‡å‡†å¹¿æ’­åˆ™è°ƒç”¨ sendBroadCast æ–¹æ³•ï¼Œå‘é€æœ‰åºå¹¿æ’­åˆ™è°ƒç”¨ sendOrderedBroadcast æ–¹æ³•ã€‚å¦‚æœæ˜¯æœ¬åœ°å¹¿æ’­åˆ™å’Œä¸Šæ–‡ä¸€è‡´éœ€è¦å€ŸåŠ© LocalBroadCastManager è¿›è¡Œå‘é€ï¼Œæœ¬åœ°å¹¿æ’­æ²¡æœ‰æœ‰åºå¹¿æ’­ã€‚ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.rookieyang.forcelogin"</span>);</span><br><span class="line">sendBroadcast(intent);</span><br><span class="line"><span class="comment">//sendOrderedBroadcast(intent);</span></span><br><span class="line">localBroadcastManager.sendBroadcast();</span><br></pre></td></tr></table></figure></p></li><li>æ¥æ”¶å¤„ç† æ¥æ”¶å¤„ç†åœ¨å¹¿æ’­æ¥æ”¶å™¨çš„ onReceive æ–¹æ³•ä¸­è¿›è¡Œï¼Œåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨ä¸­å·²ç»è¯´æ˜ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</li><li><p>å–æ¶ˆæ³¨å†Œ é™æ€æ³¨å†Œçš„ä¸éœ€è¦æˆ‘ä»¬ç¼–ç å»å–æ¶ˆæ³¨å†Œï¼Œå¯¹äºåŠ¨æ€æ³¨å†Œçš„åˆ™éœ€è¦ç¼–ç å»å–æ¶ˆæ³¨å†Œï¼Œå¦‚æœæ˜¯å…¨å±€å¹¿æ’­åˆ™è°ƒç”¨ unregisterReceiver æ–¹æ³•å³å¯ï¼Œå¦‚æœæ˜¯æœ¬åœ°å¹¿æ’­åˆ™è°ƒç”¨ LocalBroadCastManager å¯¹è±¡çš„è¯¥æ–¹æ³•å³å¯ã€‚ <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unregisterReceiver(forceReceiver);</span><br><span class="line">localBroadcastManager.unregisterReceiver(forceReceiver);</span><br></pre></td></tr></table></figure></p></li></ol><hr>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;broadcasts-å®šä¹‰åŠå…¶ä½œç”¨&quot;&gt;BroadCasts å®šä¹‰åŠå…¶ä½œç”¨&lt;/h4&gt;
&lt;p&gt;BroadCasts æ˜¯ä¸€ç§å¹¿æ’­æœºåˆ¶ï¼Œç±»ä¼¼äºå‘å¸ƒ-è®¢é˜…è¿™ç§æœºåˆ¶ï¼Œå½“å‘ç”Ÿä¸€äº›äº‹ä»¶çš„æ—¶å€™ï¼Œç³»ç»Ÿæˆ–ç¨‹åºå°±ä¼šå‘é€ï¼ˆå‘å¸ƒï¼‰ä¸€äº›ç›¸å…³çš„å¹¿æ’­ï¼Œè€Œæ³¨å†Œï¼ˆè®¢é˜…ï¼‰äº†è¿™äº›å¹¿æ’­çš„ç¨‹åºå°±ä¼šé€šè¿‡å¹¿æ’­æ¥æ”¶å™¨å»å“åº”è¿™äº›å¹¿æ’­ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="AndroidåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Android%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="BroatCasts" scheme="http://www.ikroal.xyz/tags/BroatCasts/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu 14.04ä¸‹AVDçš„åˆ›å»ºä»¥åŠé—ªé€€é—®é¢˜</title>
    <link href="http://www.ikroal.xyz/2017/08/24/Android%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%E4%B9%8BAVD%E7%9A%84%E5%88%9B%E5%BB%BA%E4%BB%A5%E5%8F%8A%E9%97%AA%E9%80%80/"/>
    <id>http://www.ikroal.xyz/2017/08/24/Androidé—®é¢˜è®°å½•ä¹‹AVDçš„åˆ›å»ºä»¥åŠé—ªé€€/</id>
    <published>2017-08-24T15:15:12.000Z</published>
    <updated>2018-03-06T12:34:17.409Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Ubuntu 14.04 ä¸‹åˆ›å»º Android è™šæ‹Ÿæœºæ—¶å¯èƒ½ä¼šå‡ºç°ä¸‹åˆ—é”™è¯¯ï¼š<br></p><blockquote><p>An error occurred while creating the AVD. See idea.log for details</p></blockquote><p>åœ¨ç½‘ä¸ŠæŸ¥æ‰¾ä¹‹åå¾ˆå¤šäººå»ºè®®ä½¿ç”¨ sudo apt-get install lib32stdc++6 è¿™æ¡å‘½ä»¤ï¼Œä½†æ˜¯å®é™…ä¸Šé‡‡ç”¨è¿™æ¡å‘½ä»¤å»å®‰è£…ä¼šå‡ºç°ä¾èµ–å†²çªçš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ© sudo aptitude -f install lib32stdc++6 å»è§£å†³ä¾èµ–é—®é¢˜ï¼Œè¿™æ¡è¯­å¥ä½¿ç”¨ä¸€æ¬¡å¯èƒ½å¹¶ä¸èƒ½è§£å†³é—®é¢˜ï¼Œå®é™…å½“ä¸­æˆ‘è¿è¡Œäº†ä¸‰æ¬¡æ‰è§£å†³äº†ä¾èµ–çš„å†²çªçš„é—®é¢˜ï¼Œæ¯ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™ä¾æ¬¡é€‰æ‹© no-&gt;yes-&gt;yesã€‚å…·ä½“è¦è¿è¡Œå‡ æ¬¡ï¼Œå¿…é¡»çœ‹ lib32stdc++6 åº“æ˜¯å¦å®‰è£…æˆåŠŸã€‚<a id="more"></a></p><p>åœ¨ç»è¿‡ä¸Šè¿°çš„æ“ä½œä¹‹åï¼Œè™½ç„¶ AVD å¯èƒ½èƒ½æˆåŠŸåˆ›å»ºï¼Œä½†å®é™…å¯èƒ½è¿˜æ˜¯æ— æ³•å¯åŠ¨ï¼Œæ— æ³•å¯åŠ¨çš„åŸå› å¯èƒ½æ˜¯éœ€è¦å®‰è£… Intel's KVMï¼Œå…·ä½“æ­¥éª¤å¯ä»¥å‚è€ƒ<a href="https://github.com/uw-it-aca/spacescout-android/wiki/1.-Setting-Up-Android-Studio-on-Ubuntu#install-intels-kvm-for-better-avd-performance" target="_blank" rel="noopener">Setting Up Android Studio on Ubuntu</a>å½“ä¸­çš„ Install Intel's KVM for Better AVD Performance éƒ¨åˆ†ï¼Œåœ¨è¿™éƒ¨åˆ†å½“ä¸­åªéœ€åšåˆ°ç¬¬ä¸ƒæ­¥å³å¯ï¼Œç”±äºæˆ‘ä½¿ç”¨çš„ AndroidStudio 2.3ï¼Œæ— æ³•æ‰¾åˆ°ç¬¬å…«æ­¥æ‰€è¯´çš„é€‰é¡¹ã€‚</p><p>åœ¨å®‰è£…å¥½æ‰€éœ€è¦çš„ä¸€åˆ‡åº“ä¹‹åï¼Œæ¥ä¸‹æ¥çš„æ­¥éª¤å¦‚ä¸‹ï¼š 1. åˆ›å»ºè™šæ‹Ÿæœºï¼Œè®°ä¸‹è™šæ‹Ÿæœºåç§° 2. è¿›å…¥åˆ° Sdk è·¯å¾„ä¸‹çš„ tools ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ &gt; sudo chmod +x emulator &gt; ./emulator -avd è™šæ‹Ÿæœºåç§° -qemu -m 2047 -enable-kvm</p><p>åœ¨ç»è¿‡ä¸Šè¿°çš„ä¸¤ä¸ªæ­¥éª¤ä¹‹ååŸºæœ¬ä¸Šæ˜¯èƒ½å¤ŸæˆåŠŸå¯åŠ¨äº†çš„ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Ubuntu 14.04 ä¸‹åˆ›å»º Android è™šæ‹Ÿæœºæ—¶å¯èƒ½ä¼šå‡ºç°ä¸‹åˆ—é”™è¯¯ï¼š&lt;br&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;An error occurred while creating the AVD. See idea.log for details&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨ç½‘ä¸ŠæŸ¥æ‰¾ä¹‹åå¾ˆå¤šäººå»ºè®®ä½¿ç”¨ sudo apt-get install lib32stdc++6 è¿™æ¡å‘½ä»¤ï¼Œä½†æ˜¯å®é™…ä¸Šé‡‡ç”¨è¿™æ¡å‘½ä»¤å»å®‰è£…ä¼šå‡ºç°ä¾èµ–å†²çªçš„é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦å€ŸåŠ© sudo aptitude -f install lib32stdc++6 å»è§£å†³ä¾èµ–é—®é¢˜ï¼Œè¿™æ¡è¯­å¥ä½¿ç”¨ä¸€æ¬¡å¯èƒ½å¹¶ä¸èƒ½è§£å†³é—®é¢˜ï¼Œå®é™…å½“ä¸­æˆ‘è¿è¡Œäº†ä¸‰æ¬¡æ‰è§£å†³äº†ä¾èµ–çš„å†²çªçš„é—®é¢˜ï¼Œæ¯ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™ä¾æ¬¡é€‰æ‹© no-&amp;gt;yes-&amp;gt;yesã€‚å…·ä½“è¦è¿è¡Œå‡ æ¬¡ï¼Œå¿…é¡»çœ‹ lib32stdc++6 åº“æ˜¯å¦å®‰è£…æˆåŠŸã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="Androidé—®é¢˜è®°å½•" scheme="http://www.ikroal.xyz/categories/Android%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="å·¥å…·é—®é¢˜" scheme="http://www.ikroal.xyz/tags/%E5%B7%A5%E5%85%B7%E9%97%AE%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>Java çº¿ç¨‹ç®€è¿°</title>
    <link href="http://www.ikroal.xyz/2017/08/22/Java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%AE%80%E8%BF%B0/"/>
    <id>http://www.ikroal.xyz/2017/08/22/JavaåŸºç¡€ä¹‹å¤šçº¿ç¨‹ç®€è¿°/</id>
    <published>2017-08-22T00:41:38.000Z</published>
    <updated>2019-05-13T08:42:25.401Z</updated>
    
    <content type="html"><![CDATA[<h4 id="çº¿ç¨‹çš„ä½œç”¨">çº¿ç¨‹çš„ä½œç”¨</h4><blockquote><p>çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šThreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p></blockquote><p>ç®€è€Œè¨€ä¹‹ï¼Œçº¿ç¨‹çš„å­˜åœ¨æ˜¯ä¸ºäº†å®ç°ç¨‹åºçš„å¹¶å‘æ“ä½œï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚ <a id="more"></a></p><h4 id="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h4><p><img src="https://raw.githubusercontent.com/ikroal/blog-images/master/thread-life-cycle.png"> çº¿ç¨‹çš„ä¸»è¦ç”Ÿå‘½å‘¨æœŸå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸»è¦åˆ†ä¸ºäº”ä¸ªçŠ¶æ€ï¼š</p><ol type="1"><li>æ–°å»ºæ€ï¼ˆNewï¼‰ï¼šJava ä¸­ä½¿ç”¨ new å…³é”®å­—åˆ›å»ºçº¿ç¨‹ä¹‹åï¼Œè¿™æ—¶çº¿ç¨‹å³å¤„äºæ–°å»ºæ€ã€‚</li><li>å°±ç»ªæ€ï¼ˆRunnableï¼‰ï¼šåœ¨çº¿ç¨‹è°ƒç”¨ start() æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹å³å¤„äºå°±ç»ªæ€ã€‚</li><li>è¿è¡Œæ€ï¼ˆRunningï¼‰ï¼šå½“å°±ç»ªæ€çš„çº¿ç¨‹è·å¾— CPU å¹¶ä¸”å¼€å§‹æ‰§è¡Œ run() æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹å°±ä¼šå¤„äºè¿è¡ŒçŠ¶æ€ã€‚</li><li>é˜»å¡æ€ï¼ˆBlockedï¼‰ï¼šåœ¨å¤„äºè¿è¡Œæ€çš„çº¿ç¨‹è°ƒç”¨äº† sleep() æˆ– wait() åˆæˆ–è€…æ˜¯è°ƒç”¨äº†ä¸€ä¸ªé˜»å¡å¼çš„ IO æ–¹æ³•ä¹‹åï¼Œçº¿ç¨‹å°†ä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚</li><li>æ­»äº¡æ€ï¼ˆDeadï¼‰ï¼šåœ¨çº¿ç¨‹ä¸­çš„ run() æ–¹æ³•æ‰§è¡Œå®Œæ¯•ã€çº¿ç¨‹æŠ›å‡ºå¼‚å¸¸ã€è°ƒç”¨çº¿ç¨‹çš„ stop() è¿™å‡ ç§æƒ…å½¢ä¸‹çº¿ç¨‹å°†ä¼šè¿›å…¥æ­»äº¡æ€ã€‚</li></ol><h4 id="çº¿ç¨‹çš„å®ç°æ–¹æ³•">çº¿ç¨‹çš„å®ç°æ–¹æ³•</h4><p>Java ä¸­çº¿ç¨‹çš„å®ç°ä¸»è¦æ˜¯é€šè¿‡ Thread ç±»å’Œ Runnable æ¥å£ã€‚</p><ol type="1"><li><p>é€šè¿‡ Thread ç±»å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** do some things **/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>é€šè¿‡ Runnable æ¥å£å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/** do some things **/</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">MyThread myThread = <span class="keyword">new</span> MyThread();</span><br><span class="line">Thread thread = <span class="keyword">new</span> Thread(myThread);</span><br></pre></td></tr></table></figure></li></ol><blockquote><p>ç›¸å¯¹è€Œè¨€ç¬¬äºŒç§æ–¹å¼æ›´ä¸ºåˆç†ä¸€äº›ï¼Œç¬¬äºŒç§æ–¹å¼åˆ›å»ºçš„çº¿ç¨‹ç±»åªå®ç°äº† Runnable æ¥å£ï¼Œè¿˜å¯ä»¥å†ç»§æ‰¿å…¶å®ƒçš„çˆ¶ç±»ã€‚</p></blockquote><hr><h4 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h4><p><a href="http://blog.csdn.net/ns_code/article/details/17161237" target="_blank" rel="noopener">ã€Javaå¹¶å‘ç¼–ç¨‹ã€‘ä¹‹å…­ï¼šRunnableå’ŒThreadå®ç°å¤šçº¿ç¨‹çš„åŒºåˆ«ï¼ˆå«ä»£ç ï¼‰</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;çº¿ç¨‹çš„ä½œç”¨&quot;&gt;çº¿ç¨‹çš„ä½œç”¨&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;çº¿ç¨‹ï¼ˆè‹±è¯­ï¼šThreadï¼‰æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿè¿›è¡Œè¿ç®—è°ƒåº¦çš„æœ€å°å•ä½ã€‚å®ƒè¢«åŒ…å«åœ¨è¿›ç¨‹ä¹‹ä¸­ï¼Œæ˜¯è¿›ç¨‹ä¸­çš„å®é™…è¿ä½œå•ä½ã€‚ä¸€æ¡çº¿ç¨‹æŒ‡çš„æ˜¯è¿›ç¨‹ä¸­ä¸€ä¸ªå•ä¸€é¡ºåºçš„æ§åˆ¶æµï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¹¶å‘å¤šä¸ªçº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ç®€è€Œè¨€ä¹‹ï¼Œçº¿ç¨‹çš„å­˜åœ¨æ˜¯ä¸ºäº†å®ç°ç¨‹åºçš„å¹¶å‘æ“ä½œï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="JavaåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Java" scheme="http://www.ikroal.xyz/tags/Java/"/>
    
      <category term="Thread" scheme="http://www.ikroal.xyz/tags/Thread/"/>
    
  </entry>
  
  <entry>
    <title>Android åŸºç¡€ä¹‹ LayoutInflater æ€»ç»“</title>
    <link href="http://www.ikroal.xyz/2017/07/22/Android%E5%9F%BA%E7%A1%80%E4%B9%8BLayoutInflater%E6%80%BB%E7%BB%93/"/>
    <id>http://www.ikroal.xyz/2017/07/22/AndroidåŸºç¡€ä¹‹LayoutInflateræ€»ç»“/</id>
    <published>2017-07-22T15:01:23.000Z</published>
    <updated>2018-03-05T15:59:59.165Z</updated>
    
    <content type="html"><![CDATA[<h4 id="layoutinflater-çš„è·å–">LayoutInflater çš„è·å–</h4><p>è·å– LayoutInflater çš„æ–¹å¼ä¸€èˆ¬æœ‰ä¸‰ç§ï¼š</p><ol type="1"><li>getLayoutInflater()</li><li>LayoutInflater.from(Context context)</li><li>context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)</li></ol><p>è¿™ä¸‰ç§è·å–æ–¹å¼æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„</p><ul><li><p>getLayoutInflater() é€šè¿‡ getWindow().getLayoutInflater() è¿›è¡Œè·å–ï¼ŒgetWindow() è·å–çš„æ˜¯ PhoneWindowï¼Œç„¶å PhoneWindow é€šè¿‡ mLayoutInflater = LayoutInflater.from(context) è·å– LayoutInflaterã€‚</p></li><li><p>LayoutInflater.from(Context context) å†…éƒ¨é€šè¿‡ä»¥ä¸‹ä»£ç è·å– LayoutInflaterã€‚<a id="more"></a></p><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LayoutInflater <span class="title">from</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    LayoutInflater LayoutInflater =</span><br><span class="line">            (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">    <span class="keyword">if</span> (LayoutInflater == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LayoutInflater not found."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> LayoutInflater;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li></ul><p><strong>ç»“è®ºï¼šæ‰€ä»¥è¿™ä¸‰ç§æ–¹å¼æœ€ç»ˆéƒ½è°ƒç”¨äº† Context.getSystemService()</strong></p><h4 id="layoutinflater-çš„-inflater-æ–¹æ³•">LayoutInflater çš„ inflater æ–¹æ³•</h4><p>inflater ä½œä¸º LayoutInflater ä¸­æœ€å¸¸ç”¨çš„æ–¹æ³•ï¼Œç”¨äºä» xml çš„å¸ƒå±€æ–‡ä»¶å¾—åˆ°ä¸€ä¸ª View å¯¹è±¡ï¼ŒåŠ è½½åˆ° Activity ç”¨äºåŠ¨æ€åˆ›å»ºå¸ƒå±€ã€‚inflater æ€»å…±é‡è½½äº† 4 ç§è°ƒç”¨æ–¹å¼ï¼š 1. public View inflate(<span class="citation" data-cites="LayoutRes">@LayoutRes</span> int resource, <span class="citation" data-cites="Nullable">@Nullable</span> ViewGroup root) 2. public View inflate(<span class="citation" data-cites="LayoutRes">@LayoutRes</span> int resource, <span class="citation" data-cites="Nullable">@Nullable</span> ViewGroup root, boolean attachToRoot) 3. public View inflate(XmlPullParser parser, <span class="citation" data-cites="Nullable">@Nullable</span> ViewGroup root) 4. public View inflate(XmlPullParser parser, <span class="citation" data-cites="Nullable">@Nullable</span> ViewGroup root, boolean attachToRoot)</p><p>å¯¹äºæ„é€ å‡½æ•°çš„ä½¿ç”¨è€Œè¨€ï¼Œæœ‰å¦‚ä¸‹æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>root å¡«å……çš„æ ¹è§†å›¾</li><li>attachToRoot å†³å®šæ˜¯å¦å°†è½½å…¥çš„è§†å›¾é™„åŠ åˆ°æ ¹è§†å›¾ä¸Šï¼Œå¦‚æœä¸º false åˆ™ä»…ç”¨äºä¸º XML ä¸­çš„æ ¹è§†å›¾åˆ›å»ºæ­£ç¡®çš„ LayoutParams çš„å­ç±»</li><li>å‰ä¸‰ä¸ª inflater æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ç¬¬å››ä¸ª inflater æ–¹æ³•ï¼Œé‡‡ç”¨äº† pull è§£æ</li><li>é¿å…å°† null ä½œä¸º ViewGroup ä¼ å…¥</li><li>å½“ä¸éœ€è¦å°†è¿”å›çš„ View æ·»åŠ å…¥ ViewGroup æ—¶åº”è¯¥è®¾ç½®attachToRoot ä¸º false</li><li>é¿å…åœ¨ View å·²ç»è¢«æ·»åŠ å…¥ ViewGroup æ—¶å°† attachToRoot è®¾ç½®ä¸º True</li><li>è‡ªå®šä¹‰ View æ—¶éå¸¸é€‚åˆå°† attachToRoot è®¾ç½®ä¸º True</li></ul><h4 id="layoutinflater-åŸºæœ¬ä½¿ç”¨">LayoutInflater åŸºæœ¬ä½¿ç”¨</h4><p>ç”±äº LayoutInflater ä¸»è¦ç”¨äºå¸ƒå±€å¡«å……ï¼Œæ‰€ä»¥ä¸»è¦æ¶‰åŠåˆ°çš„æ˜¯ inflater æ–¹æ³•ï¼Œinflater è¿”å›äº†ä¸€ä¸ª Viewï¼Œå…¶è°ƒç”¨æ–¹å¼æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</span><br><span class="line">View view = inflater.inflate(R.layout.first_fragment, container, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><hr><h4 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h4><ol type="1"><li><a href="http://blog.chengdazhi.com/index.php/110" target="_blank" rel="noopener">æ·±å…¥ç†è§£ LayoutInflater.inflate()</a></li><li><a href="http://blog.csdn.net/guolin_blog/article/details/12921889/" target="_blank" rel="noopener">Android LayoutInflater åŸç†åˆ†æï¼Œå¸¦ä½ ä¸€æ­¥æ­¥æ·±å…¥äº†è§£ View (ä¸€)</a></li><li><a href="http://www.2cto.com/kf/201407/313054.html" target="_blank" rel="noopener">LayoutInflaterâ€”â€”80%çš„Androidç¨‹åºå‘˜å¯¹å®ƒå¹¶ä¸äº†è§£ç”šè‡³é”™è¯¯ä½¿ç”¨</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;layoutinflater-çš„è·å–&quot;&gt;LayoutInflater çš„è·å–&lt;/h4&gt;
&lt;p&gt;è·å– LayoutInflater çš„æ–¹å¼ä¸€èˆ¬æœ‰ä¸‰ç§ï¼š&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;getLayoutInflater()&lt;/li&gt;
&lt;li&gt;LayoutInflater.from(Context context)&lt;/li&gt;
&lt;li&gt;context.getSystemService(Context.LAYOUT_INFLATER_SERVICE)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™ä¸‰ç§è·å–æ–¹å¼æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€æ ·çš„&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;getLayoutInflater() é€šè¿‡ getWindow().getLayoutInflater() è¿›è¡Œè·å–ï¼ŒgetWindow() è·å–çš„æ˜¯ PhoneWindowï¼Œç„¶å PhoneWindow é€šè¿‡ mLayoutInflater = LayoutInflater.from(context) è·å– LayoutInflaterã€‚&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;LayoutInflater.from(Context context) å†…éƒ¨é€šè¿‡ä»¥ä¸‹ä»£ç è·å– LayoutInflaterã€‚&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
      <category term="AndroidåŸºç¡€" scheme="http://www.ikroal.xyz/categories/Android%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Android" scheme="http://www.ikroal.xyz/tags/Android/"/>
    
      <category term="LayoutInflater" scheme="http://www.ikroal.xyz/tags/LayoutInflater/"/>
    
  </entry>
  
</feed>
